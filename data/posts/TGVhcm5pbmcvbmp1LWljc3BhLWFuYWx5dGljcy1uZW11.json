{"Id":"Learning/nju-icspa-analytics-nemu","Type":0,"AuthorId":"","Content":{"Tag":"","Raw":"\n# \u6982\u8FF0\n\n- [\u6846\u67B6\u4EE3\u7801\u5E93](https://github.com/NJU-ProjectN/nemu)\n- CPU \u67B6\u6784\uFF1Ax64\n- \u64CD\u4F5C\u7CFB\u7EDF: GNU/Linux\n- \u7F16\u8BD1\u5668: GCC\n- \u7F16\u7A0B\u8BED\u8A00\uFF1AC \u8BED\u8A00\n\n\u7531\u4E8E NJU ICS PA \u6846\u67B6\u4EE3\u7801\u8F83\u591A\u4E14\u7F3A\u5C11\u8DB3\u591F\u8BF4\u660E\uFF0C\u8BB2\u4E49\u591A\u4E3A\u57FA\u7840\u5F15\u5165\u5185\u5BB9\uFF0C\u4E3A\u65B9\u4FBF\u540E\u7EED\u7A0B\u5E8F\u7F16\u5199\uFF0C\u6839\u636E\u5B9E\u9645\u4F5C\u4E1A\u8FC7\u7A0B\u4E2D\u7684\u7406\u89E3\u6574\u7406\u51FA\u6B64\u6587\u3002\n\u672C\u6587\u4E3B\u8981\u5305\u542B\u5BF9 NJU ICS \u8BFE\u7A0B\u7F16\u7A0B\u4F5C\u4E1A\u7684\u6846\u67B6\u4EE3\u7801\u4E2D NEMU \u90E8\u5206\u7684\u7406\u89E3\u548C\u5206\u6790\uFF0C\u8DDF\u968F\u8BFE\u7A0B\u53CA\u8BB2\u4E49\u8FDB\u5EA6\u66F4\u65B0\uFF0C\u4EE5\u4E2A\u4EBA\u4F7F\u7528\u4E3A\u4E3B\uFF0C\u53EF\u80FD\u5B58\u5728\u9519\u8BEF\u3002\n\n\u003E \u90E8\u5206\u5185\u5BB9\u6846\u67B6\u4EE3\u7801\u5E76\u4E0D\u5305\u542B\uFF08\u5982\u6269\u5C55\u7684 Debug \u5B8F\uFF09\uFF0C\u5747\u4E3A\u6211\u4E3A\u7F16\u7801\u800C\u6DFB\u52A0\u7684\u5185\u5BB9\u3002\u91C7\u7528 \u0060a_b\u0060 \u65B9\u5F0F\u547D\u540D\u7684\u591A\u4E3A\u539F\u5185\u5BB9\uFF0C\u91C7\u7528 \u0060aB\u0060 \u65B9\u5F0F\u547D\u540D\u7684\u591A\u4E3A\u8865\u5145\u5185\u5BB9\u3002\u7531\u4E8E\u6B64\u9879\u76EE\u662F NJU ICS PA \u7684\u4E00\u90E8\u5206\uFF0C\u5176\u4E2D\u4F1A\u5305\u542B\u4E0E\u76F8\u5173\u9879\u76EE\u7684\u4E92\u64CD\u4F5C\u5185\u5BB9\u3002\n\nNEMU (NJU EMUlator) \u662F\u5728 Linux \u4E0A\u7684\u4E00\u4E2A n86\uFF08x86 \u5B50\u96C6\uFF09\u6A21\u62DF\u5668\uFF0C\u6A21\u62DF\u4E86\u57FA\u672C\u8BA1\u7B97\u673A\u7CFB\u7EDF\u7684\u529F\u80FD\uFF08\u5185\u5B58\uFF0CCPU\u7B49\uFF09\u3002\u5305\u542B\u4E86\uFF1A\n\n- \u5185\u5B58\n- CPU\uFF0C\u5BC4\u5B58\u5668\n- \u8C03\u8BD5\u5668\uFF08\u76D1\u89C6\u5668\uFF09\n\n## \u6846\u67B6\u4EE3\u7801\u7ED3\u6784\n\n\u0060\u0060\u0060\nnanos-lite/\nnavy-apps/\nnexus-am/\nnemu/               # NEMU \u9879\u76EE\n    build/          # \u6784\u5EFA\u8F93\u51FA\u6587\u4EF6\u5939\n        nemu        # NEMU \u4E3B\u7A0B\u5E8F\uFF08\u53EF\u6267\u884C\u6587\u4EF6\uFF09\n    include/        # \u5934\u6587\u4EF6\n    src/            # \u6E90\u7801\u6587\u4EF6\n    tools/          # \u5DE5\u5177\u6587\u4EF6\n    runall.sh       # \u6D4B\u8BD5 AM cputest \u6D4B\u8BD5\u96C6 \uFF08nexus-am/tests/cputest\uFF09\n    Makefile        # NEMU \u6784\u5EFA\u547D\u4EE4\n    Makefile.git    # NEMU Git \u8BB0\u5F55\u547D\u4EE4\n\u0060\u0060\u0060\n\n## \u76F8\u5173\u8D44\u6599\n\n- [NEMU](/posts/nju-icspa-analytics-nemu)\n- [Nexus-am](/posts/nju-icspa-analytics-nexus-am)\n- [Nanos-lite](/posts/nju-icspa-analytics-nanos-lite)\n- [Navy-apps](/posts/nju-icspa-analytics-navy-apps)\n\n# include/\n\n## nemu.h\n\n\u57FA\u7840\u5934\u6587\u4EF6\u3002\u5305\u542B\u4E86 \u0060commom.h\u0060\uFF0C\u0060memory/memory.h\u0060\uFF0C\u0060cpu/reg.h\u0060\n\n## macro.h\n\n\u5B9A\u4E49\u4E86\u4E00\u4E9B\u5B57\u7B26\u4E32\u8FDE\u63A5\u5B8F \u0060concat\u0060 \u7B49\u3002\n\n## common.h\n\n\u5B9A\u4E49\u4E86\u4E00\u4E9B\u7C7B\u578B\u522B\u540D\u3002\n\n|\u7C7B\u578B\u522B\u540D|\u539F\u7C7B\u578B|\u63CF\u8FF0|\n|-|-|-|\n|\u0060rtlreg_t\u0060|\u0060uint32_t\u0060|RTL\u5BC4\u5B58\u5668|\n|\u0060vaddr_t\u0060|\u0060uint32_t\u0060|\u865A\u62DF\u5730\u5740|\n|\u0060paddr_t\u0060|\u0060uint32_t\u0060|\u7269\u7406\u5730\u5740|\n|\u0060ioaddr_t\u0060|\u0060uint16_t\u0060|I/O \u7AEF\u53E3\u5730\u5740|\n\n- \u0060relreg_t\u0060 \u591A\u7528\u4E8E\u5BC4\u5B58\u5668\u8BBF\u95EE\n- \u0060vaddr_t\u0060 \u0060paddr_t\u0060 \u591A\u7528\u4E8E\u5185\u5B58\u8BBF\u95EE\n- \u0060ioaddr_t\u0060 \u591A\u7528\u4E8E\u8BBE\u5907 I/O \u7AEF\u53E3\u8BBF\u95EE\n\n\u5B9A\u4E49\u4E86\u4E00\u4E9B\u63A7\u5236\u7F16\u8BD1\u65B9\u5F0F\u7684\u5B8F\u3002\n\n|\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060DEBUG\u0060|\u542F\u7528\u8C03\u8BD5|\n|\u0060DIFF_TEST\u0060|\u542F\u7528 diff-test|\n|\u0060HAS_IOE\u0060|\u542F\u7528\u8F93\u5165\u8F93\u51FA\u6269\u5C55|\n\n- \u0060DIFF_TEST\u0060 \u53EF\u542F\u7528\u4E00\u4E2A\u5DEE\u5F02\u6D4B\u8BD5\u5DE5\u5177\uFF0C\u53C2\u89C1 \u0060tools/qemu-diff\u0060 \u90E8\u5206\u3002\n- \u0060HAS_IOE\u0060 \u542F\u7528\u8F93\u5165\u8F93\u51FA\u8BBE\u5907\uFF0C\u53C2\u89C1\u8BBE\u5907\u90E8\u5206\u3002\n\n## debug.h\n\n\u5B9A\u4E49\u4E86\u4FBF\u4E8E\u8C03\u8BD5\u7684\u5B8F\u3002\n\n|\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060Log_write(format, ...)\u0060|\u4EC5\u8BB0\u5F55\u65E5\u5FD7|\n|\u0060printflog(format, ...)\u0060|\u663E\u793A\u6587\u672C\u5E76\u8BB0\u5F55\u65E5\u5FD7|\n|\u0060Log(format, ...)\u0060|\u5BF9 \u0060printflog\u0060 \u7684\u6269\u5C55\uFF0C\u5305\u542B\u5F53\u524D\u6587\u4EF6\uFF0C\u884C\uFF0C\u51FD\u6570|\n|\u0060Info(format, ...)\u0060|\u5BF9 \u0060Log\u0060 \u7684\u6269\u5C55\uFF0C\u65E5\u5FD7\u7EA7\u522B\uFF1A\u63D0\u793A|\n|\u0060Warning(format, ...)\u0060|\u5BF9 \u0060Log\u0060 \u7684\u6269\u5C55\uFF0C\u65E5\u5FD7\u7EA7\u522B\uFF1A\u8B66\u544A|\n|\u0060Error(format, ...)\u0060|\u5BF9 \u0060Log\u0060 \u7684\u6269\u5C55\uFF0C\u65E5\u5FD7\u7EA7\u522B\uFF1A\u9519\u8BEF|\n|\u0060panic(format, ...)\u0060|\u5F3A\u5236\u9000\u51FA\uFF0C\u663E\u793A\u6587\u672C\u5E76\u8BB0\u5F55\u65E5\u5FD7|\n|\u0060Assert(cond [, format, ...])\u0060|\u8BBE\u7F6E\u65AD\u8A00\uFF0C\u5931\u8D25\u65F6\u5F3A\u5236\u9000\u51FA\uFF0C\u663E\u793A\u6587\u672C\u5E76\u8BB0\u5F55\u65E5\u5FD7|\n|\u0060TODO()\u0060|\u6807\u8BC6\u5F85\u5B8C\u6210\u9879\uFF0C\u6267\u884C\u65F6\u4F1A\u89E6\u53D1 \u0060panic\u0060|\n\n## cpu/\n\n### reg.h\n\n\u5B9A\u4E49\u4E86\u5BC4\u5B58\u5668\u7ED3\u6784\uFF0C\u548C\u8F85\u52A9\u5BC4\u5B58\u5668\u7684\u4E00\u4E9B\u5B8F\u548C\u51FD\u6570\u3002\n\n- \u5916\u90E8\u6570\u7EC4 \u0060regsl, regsw, regsb\u0060 \u4E0D\u540C\u5BC4\u5B58\u5668\u540D\u3002\u5B9E\u73B0\u5728 \u0060src/cpu/reg.c\u0060\n\n\u0060\u0060\u0060c\nextern const char* regsl[];\nextern const char* regsw[];\nextern const char* regsb[];\n\u0060\u0060\u0060\n\n#### \u7ED3\u6784\u4F53 CPU_state\n\n\u5BC4\u5B58\u5668\u7ED3\u6784\uFF0C\u5305\u542B\u4E86\u6240\u6709\u5BC4\u5B58\u5668\uFF0C\u5747\u4E3A\u65E0\u7B26\u53F7\u6574\u6570\u3002\n- \u5BF9\u4E8E 8 \u4E2A\u901A\u7528\u5BC4\u5B58\u5668\uFF0C\u5185\u90E8\u4EE5 \u0060gpr\u0060 \u6570\u7EC4\u4E3A\u57FA\u7840\u7ED3\u6784\uFF0C\u63D0\u4F9B \u0060eax\u0060 \u7B49\u522B\u540D\u65B9\u4FBF\u8BBF\u95EE\u3002\u5BC4\u5B58\u5668\u6309\u7167 i386 \u6307\u4EE4\u4E2D\u5BC4\u5B58\u5668\u6807\u53F7\u987A\u5E8F\u6392\u5217\u3002\u53EF\u4F7F\u7528 \u0060_16,_8[0],_8[1]\u0060 \u8BBF\u95EE\u5BC4\u5B58\u5668\u4F4E\u4F4D\u90E8\u5206\u3002\n- \u0060eip\u0060 \u5F53\u524D\u6267\u884C\u6307\u4EE4\u4F4D\u7F6E\u5BC4\u5B58\u5668\n- \u0060eflags\u0060 \u6807\u5FD7\u4F4D\u5BC4\u5B58\u5668\uFF08\u4F7F\u7528\u533F\u540D\u7ED3\u6784\u4F53\uFF0C\u53EF\u76F4\u63A5\u8BBF\u95EE \u0060CF,OF,ZF,SF\u0060\uFF09\n    - \u0060eflags\u0060 \u521D\u59CB\u5316\u4E3A \u00600x2\u0060\n- \u0060cs,ss,ds,es,fs,gs\u0060 \u7A0B\u5E8F\u6BB5\u5BC4\u5B58\u5668\uFF08\u4EC5\u4E3A\u652F\u6301 diff-test\uFF09\n    - \u0060cs\u0060 \u521D\u59CB\u5316\u4E3A \u00608\u0060\n- \u0060idtr\u0060 48 \u4F4D\u5BC4\u5B58\u5668\uFF0C\u5B58\u653E IDT (Interrupt Descriptor Table, \u4E2D\u65AD\u63CF\u8FF0\u7B26\u8868)\u7684\u9996\u5730\u5740\u548C\u957F\u5EA6\n    - \u0060limit\u0060 16\u4F4D\uFF0C\u957F\u5EA6\uFF0C\u5355\u4F4D\uFF1A\u5B57\u8282\n    - \u0060base\u0060 32\u4F4D\uFF0CIDT \u57FA\u5730\u5740\n\n|\u51FD\u6570/\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060reg_l(index)\u0060|\u83B7\u53D6\u6307\u5B9A\u4E0B\u6807\u5904\u5BC4\u5B58\u566832\u4F4D\u503C|\n|\u0060reg_w(index)\u0060|\u83B7\u53D6\u6307\u5B9A\u4E0B\u6807\u5904\u5BC4\u5B58\u5668\u4F4E16\u4F4D\u503C|\n|\u0060reg_b(index)\u0060|\u83B7\u53D6\u6307\u5B9A\u4E0B\u6807\u5904\u5BC4\u5B58\u5668\u4F4E8\u4F4D\u503C|\n|\u0060reg_name(index,width)\u0060|\u6839\u636E\u4E0B\u6807\u548C\u4F4D\u5BBD\u83B7\u5F97\u5BC4\u5B58\u5668\u540D|\n\n{% note info %}\n\u5BC4\u5B58\u5668\u5B58\u50A8\u5728\u53D8\u91CF \u0060cpu\u0060 \u4E2D\u3002\n{% endnote %}\n\n#### \u679A\u4E3E\n\n\u5B9A\u4E49\u4E86\u5F62\u5982 \u0060R_NAME\u0060 \u7684\u5BC4\u5B58\u5668\u679A\u4E3E\uFF0C\u5176\u987A\u5E8F\u4E0E\u5BC4\u5B58\u5668\u7ED3\u6784\u4E2D\u7684\u987A\u5E8F\u4E00\u81F4\u3002\n\n\u0060\u0060\u0060c\nenum { R_EAX, R_ECX, R_EDX, R_EBX, R_ESP, R_EBP, R_ESI, R_EDI };\nenum { R_AX, R_CX, R_DX, R_BX, R_SP, R_BP, R_SI, R_DI };\nenum { R_AL, R_CL, R_DL, R_BL, R_AH, R_CH, R_DH, R_BH };\n\u0060\u0060\u0060\n\n### decode.h\n\n\u5B9A\u4E49\u4E86\u7528\u4E8E\u6307\u4EE4\u8BD1\u7801\u7684\u7ED3\u6784\u548C\u51FD\u6570\u3002\n\n#### \u7ED3\u6784\u4F53 Operand\n\n\u64CD\u4F5C\u6570\u3002\n\n|\u6210\u5458|\u63CF\u8FF0|\n|-|-|\n|\u0060type\u0060|\u7C7B\u578B\uFF08\u89C1\u4E0B\u65B9\u679A\u4E3E\uFF09|\n|\u0060width\u0060|\u4F4D\u5BBD|\n|\u0060val\u0060|\u5B9E\u9645\u503C|\n|\u0060str\u0060|\u539F\u4E32\uFF08\u7528\u4E8E\u8C03\u8BD5\u8F93\u51FA\uFF09|\n|\u0060reg\u0060|\u5BC4\u5B58\u5668\u4E0B\u6807|\n|\u0060addr\u0060|\u5185\u5B58\u5730\u5740|\n|\u0060imm\u0060|\u7ACB\u5373\u6570|\n|\u0060simm\u0060|\u5E26\u7B26\u53F7\u7ACB\u5373\u6570|\n\n#### \u7ED3\u6784\u4F53 DecodeInfo\n\n\u5355\u6761\u547D\u4EE4\u8BD1\u7801\u7ED3\u679C\u3002\n\n|\u6210\u5458|\u63CF\u8FF0|\u5BF9\u5E94x86\u6307\u4EE4\u90E8\u5206|\n|-|-|-|\n|\u0060opcode\u0060|\u6307\u4EE4\u7801|opcode|\n|\u0060seq_eip\u0060|\u5E8F\u5217 EIP \u4F4D\u7F6E||\n|\u0060is_operand_size_16\u0060|\u6807\u8BC6\u64CD\u4F5C\u6570\u662F\u5426\u4E3A 16 \u4F4D|operand-size prefix|\n|\u0060ext_opcode\u0060|\u989D\u5916\u6307\u4EE4\u7801|ModR/M \u4E2D opcode|\n|\u0060is_jmp\u0060|\u6807\u8BC6\u662F\u5426\u4E3A\u8DF3\u8F6C\u8BED\u53E5||\n|\u0060jmp_eip\u0060|\u8DF3\u8F6C\u76EE\u6807\uFF08\u7EDD\u5BF9\u5730\u5740\uFF09\uFF0C\u4EC5\u5BF9\u4E8E\u8DF3\u8F6C\u8BED\u53E5||\n|\u0060src\u0060|\u6E90\u64CD\u4F5C\u6570||\n|\u0060src2\u0060|\u7B2C\u4E8C\u4E2A\u6E90\u64CD\u4F5C\u6570||\n|\u0060dest\u0060|\u76EE\u6807\u64CD\u4F5C\u6570||\n|\u0060assembly\u0060|||\n|\u0060asm_buf\u0060|||\n|\u0060p\u0060|||\n\n- \u0060seq_eip\u0060 \u968F\u8BD1\u7801\u8FC7\u7A0B\u6539\u53D8\uFF0C\u6700\u7EC8\u505C\u7559\u5728\u9700\u8981\u8BD1\u7801\u7684\u4E0B\u4E00\u4E2A\u4F4D\u7F6E\uFF0C\u53EF\u6839\u636E\u8FD9\u4E00\u503C\u5B9E\u73B0 eip \u66F4\u65B0\u3002\n- \u0060is_operand_size_16\u0060 \u591A\u7528\u4E8E\u5B9E\u73B0\u5355\u547D\u4EE4\u5B58\u5728 16 \u4F4D\uFF0C32 \u4F4D\u4E24\u4E2A\u7248\u672C\u7684\u60C5\u51B5\n- \u0060ext_opcode\u0060 \u7528\u4E8E\u5B9E\u73B0 \u0060sub /5\u0060 \u8FD9\u79CD\u6839\u636E\u7B2C\u4E8C\u4E2A\u6307\u4EE4\u7801 \u0060/5\u0060 \u533A\u5206\u4E0D\u540C\u6307\u4EE4\u7684\u60C5\u51B5\uFF0C\u5728\u8BD1\u7801\u4E2D\u4F7F\u7528 \u0060make_group\u0060 \u5B9E\u73B0\u3002\n- \u0060is_jmp\u0060 \u591A\u5728\u8FD0\u884C\u65F6\u6307\u5B9A\uFF08\u5982 \u0060rtl_j\u0060 \u51FD\u6570\uFF09\uFF0C\u5982\u679C\u6807\u8BB0\uFF0C\u5219\u4E0D\u4F1A\u518D\u6839\u636E \u0060seq_eip\u0060 \u66F4\u65B0 eip\n\n|\u51FD\u6570/\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060id_src\u0060|\u0060(\u0026decoding.src)\u0060|\n|\u0060id_src2\u0060|\u0060(\u0026decoding.src2)\u0060|\n|\u0060id_dest\u0060|\u0060(\u0026decoding.dest)\u0060|\n|\u0060operand_write(Operand *, rtlreg_t *)\u0060|\u6839\u636E\u7B2C\u4E00\u4E2A\u53C2\u6570\u4E2D\u8BB0\u5F55\u7684\u7C7B\u578B\u7684\u4E0D\u540C\u8FDB\u884C\u76F8\u5E94\u7684\u5199\u64CD\u4F5C\uFF0C\u5305\u62EC\u5199\u5BC4\u5B58\u5668\u548C\u5199\u5185\u5B58|\n|\u0060load_addr(vaddr_t *, ModR_M *, Operand *)\u0060||\n|\u0060read_ModR_M(vaddr_t *, Operand *, bool, Operand *, bool)\u0060||\n\n{% note info %}\n\u8BD1\u7801\u5185\u5BB9\u5B58\u50A8\u5728\u53D8\u91CF \u0060decoding\u0060 \u4E2D\u3002\n{% endnote %}\n\n#### \u7ED3\u6784\u4F53 ModR_M\n\n\u6307\u4EE4\u4E2D\u7684 ModR/M\u3002\n\n#### \u7ED3\u6784\u4F53 SIB\n\n\u6307\u4EE4\u4E2D\u7684 SIB\u3002\n\n#### \u679A\u4E3E \n\n\u5B9A\u4E49\u4E86\u64CD\u4F5C\u6570\u7684\u7C7B\u578B \u0060OP_TYPE_REG\u0060\uFF0C\u0060OP_TYPE_MEM\u0060\uFF0C\u0060OP_TYPE_IMM\u0060\uFF0C\u5206\u522B\u4E3A\u5BC4\u5B58\u5668\uFF0C\u5185\u5B58\uFF0C\u7ACB\u5373\u6570\u3002\n\n#### \u5B8F make_DHelper \u4E0E\u51FD\u6570\u65CF decode_name\n\n\u7531\u5B8F \u0060make_DHelper\u0060 \u5B9A\u4E49\u4E86\u4E00\u65CF\u51FD\u6570\uFF08\u53C2\u6570\u76F8\u540C\uFF09\uFF0C\u7528\u4E8E\u6307\u4EE4\u8BD1\u7801\uFF0C\u5E76\u5B9A\u4E49\u4E86\u8FD9\u4E9B\u51FD\u6570\u7684\u6307\u9488\u7C7B\u578B \u0060DHelper\u0060\u3002\n\n- \u8BBE\u8BA1\u76EE\u7684\uFF1A\u7531\u4E8E\u5927\u91CF\u6307\u4EE4\u7684\u64CD\u4F5C\u6570\u6A21\u5F0F\u76F8\u4F3C\uFF0C\u5C06\u8FD9\u4E00\u70B9\u63D0\u53D6\u51FA\u6765\uFF0C\u5B9E\u73B0\u89E3\u8026\u3002\n\n\u0060\u0060\u0060c\n#define make_DHelper(name) void concat(decode_, name) (vaddr_t *eip)\ntypedef void (*DHelper) (vaddr_t *);\n\u0060\u0060\u0060\n\n\u51FD\u6570\u65CF\u4E2D\u90E8\u5206\u51FD\u6570\u547D\u540D\u89C4\u5219\uFF08**\u4E0D\u5168**\uFF09\uFF1A\n\n|\u540D\u79F0|\u63CF\u8FF0|\n|-|-|\n|\u0060I\u0060|\u7ACB\u5373\u6570|\n|\u0060SI\u0060|\u6709\u7B26\u53F7\u7ACB\u5373\u6570|\n|\u0060E\u0060|\u5185\u5B58\u6216\u5BC4\u5B58\u5668\uFF08\u5BF9\u5E94\u6307\u4EE4\u63CF\u8FF0\u4E2D\u7684 r/m\uFF09|\n|\u0060G\u0060|\u901A\u7528\u5BC4\u5B58\u5668|\n|\u0060r\u0060|\u5355\u4E00\u5BC4\u5B58\u5668|\n|\u0060a\u0060|\u6307\u5B9A\u5BC4\u5B58\u5668\u4E3A \u0060eax,ax,al\u0060|\n|\u0060I2G\u0060|\u7ACB\u5373\u6570\u5230\u901A\u7528\u5BC4\u5B58\u5668|\n|\u0060I_E2G\u0060|\u7ACB\u5373\u6570\u4E0E\u5185\u5B58\u6216\u5BC4\u5B58\u5668\u5230\u901A\u7528\u5BC4\u5B58\u5668|\n|\u0060O\u0060|\u672A\u77E5|\n\n- \u0060r\u0060 \u4E00\u822C\u7528\u4E8E\u5BC4\u5B58\u5668\u4FE1\u606F\u5B58\u50A8\u5728 \u0060opcode\u0060 \u4E2D\u7684\u60C5\u51B5\n- \u8FD8\u6709\u4E00\u4E9B\u4E13\u7528\u4E8E\u7279\u5B9A\u6307\u4EE4\u7684\u8BD1\u7801\u51FD\u6570\n\n{% note info %}\n\u5EFA\u8BAE\u7ED3\u5408 i386 \u624B\u518C\u9644\u5F55 C \u7406\u89E3\u3002\n{% endnote %}\n\n\u51FD\u6570\u65CF\u4E2D\u7279\u6B8A\u51FD\u6570\uFF1A\n\n- \u0060J\u0060 \u8DF3\u8F6C\u6307\u4EE4\u89E3\u7801\u3002\u5355\u64CD\u4F5C\u6570\uFF0C\u5B58\u50A8\u5230 \u0060jmp_eip\u0060 \u4E2D\u3002\n\n### exec.h\n\n\u5B9A\u4E49\u4E86\u4E00\u4E9B\u7528\u4E8E\u8C03\u8BD5\u7684\u6307\u4EE4\u6253\u5370\u5B8F\uFF1A\n\n|\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060print_asm\u0060|\u6253\u5370\u6307\u4EE4|\n|\u0060suffix_char\u0060|\u6839\u636E\u5BBD\u5EA6\u83B7\u53D6\u6307\u4EE4\u5BBD\u5EA6\u540E\u7F00|\n|\u0060print_asm_template1\u0060|\u5355\u64CD\u4F5C\u6570\u6307\u4EE4|\n|\u0060print_asm_template2\u0060|\u53CC\u64CD\u4F5C\u6570\u6307\u4EE4|\n|\u0060print_asm_template3\u0060|\u4E09\u64CD\u4F5C\u6570\u6307\u4EE4|\n\n#### \u51FD\u6570 instr_fetch\n\n\u0060\u0060\u0060c\nuint32_t instr_fetch(vaddr_t *eip, int len)\n\u0060\u0060\u0060\n\n\u4ECE \u0060eip\u0060 \u5F00\u59CB\uFF0C\u8BFB\u53D6 \u0060len\u0060 \u4E2A\u5B57\u8282\uFF0C\u8FD4\u56DE\u503C\uFF0C\u5E76\u81EA\u52A8\u589E\u52A0 \u0060eip\u0060\u3002\n\n- \u8BBE\u8BA1\u76EE\u7684\uFF1A\u4E0E\u673A\u5668\u7684\u5927\u7AEF\u5C0F\u7AEF\u89E3\u8026\u3002\n\n#### \u5B8F make_EHelper \u4E0E \u51FD\u6570\u65CF exec_name\n\n\u7528\u4E8E\u5B9A\u4E49\u4E00\u65CF\u51FD\u6570\uFF08\u53C2\u6570\u76F8\u540C\uFF09\uFF0C\u7528\u4E8E\u6307\u4EE4\u6267\u884C\uFF0C\u5E76\u5B9A\u4E49\u4E86\u8FD9\u4E9B\u51FD\u6570\u7684\u6307\u9488\u7C7B\u578B \u0060EHelper\u0060\u3002\n\n\u0060\u0060\u0060c\n#define make_EHelper(name) void concat(exec_, name) (vaddr_t *eip)\ntypedef void (*EHelper) (vaddr_t *);\n\u0060\u0060\u0060\n\n### relop.h\n\n\u5B9A\u4E49\u4E86\u5F62\u5982 \u0060RELOP_NAME\u0060 \u7684\u679A\u4E3E\uFF0C\u6807\u8BC6\u4E0D\u540C\u7C7B\u578B\u7684\u5173\u7CFB\u8FD0\u7B97\u3002\u5BF9\u5E94\u4E86 \u0060setcc,jcc\u0060 \u547D\u4EE4\u7684\u76F8\u5E94\u7F16\u7801\u3002\n\n\u0060\u0060\u0060c\nenum {\n  //            \u002B-- unsign\n  //            |   \u002B-- sign\n  //            |   |   \u002B-- equal\n  //            |   |   |   \u002B-- invert\n  //            |   |   |   |\n  RELOP_FALSE = 0 | 0 | 0 | 0,\n  RELOP_TRUE  = 0 | 0 | 0 | 1,\n  RELOP_EQ    = 0 | 0 | 2 | 0,\n  RELOP_NE    = 0 | 0 | 2 | 1,\n\n  RELOP_LT    = 0 | 4 | 0 | 0,\n  RELOP_LE    = 0 | 4 | 2 | 0,\n  RELOP_GT    = 0 | 4 | 2 | 1,\n  RELOP_GE    = 0 | 4 | 0 | 1,\n\n  RELOP_LTU   = 8 | 0 | 0 | 0,\n  RELOP_LEU   = 8 | 0 | 2 | 0,\n  RELOP_GTU   = 8 | 0 | 2 | 1,\n  RELOP_GEU   = 8 | 0 | 0 | 1,\n};\n\u0060\u0060\u0060\n\n### cc.h\n\n\u5B9A\u4E49\u4E86\u51FD\u6570 \u0060get_cc_name\u0060 \u6839\u636E\u7F16\u7801\u83B7\u53D6\u6307\u5B9A\u5173\u7CFB\u8FD0\u7B97\u5B57\u7B26\u4E32\u3002\n\n\u5B9A\u4E49\u4E86 RTL \u57FA\u672C\u6307\u4EE4 \u0060rtl_setcc\u0060 \u7528\u4E8E\u6839\u636E\u5F53\u524D\u5173\u7CFB\u8FD0\u7B97\u548C eflags \u5BC4\u5B58\u5668\u6807\u5FD7\u4F4D\u8BBE\u7F6E dest\u3002\n\n\u0060\u0060\u0060c\nvoid rtl_setcc(rtlreg_t*, uint8_t);\n\u0060\u0060\u0060\n\n### rtl.h\n\n\u5B9A\u4E49\u548C\u5B9E\u73B0\u4E86\u4E00\u4E9B RTL \u6307\u4EE4\uFF0C\u7528\u4E8E\u63D0\u4F9B\u5BF9\u6307\u4EE4\u6267\u884C\u7684\u5E95\u5C42\u5EFA\u6A21\u3002\u53EF\u4F7F\u7528\u8FD9\u4E9B\u64CD\u4F5C\u5C06\u590D\u6742\u6307\u4EE4\u5206\u89E3\u6210\u66F4\u7B80\u5355\u7684\u64CD\u4F5C\u3002\n\nNEMU \u4E2D\u7684 RTL \u5BC4\u5B58\u5668\uFF1A\n\n- x86\u7684\u516B\u4E2A\u901A\u7528\u5BC4\u5B58\u5668(\u5728 \u0060include/cpu/reg.h\u0060 \u4E2D\u5B9A\u4E49)\n- \u0060id_src\u0060, \u0060id_src2\u0060 \u548C \u0060id_dest\u0060 \u4E2D\u7684\u8BBF\u5B58\u5730\u5740 \u0060addr\u0060 \u548C\u64CD\u4F5C\u6570\u5185\u5BB9 \u0060val\u0060 (\u5728 \u0060include/cpu/decode.h\u0060 \u4E2D\u5B9A\u4E49). \u4ECE\u6982\u5FF5\u4E0A\u770B, \u5B83\u4EEC\u5206\u522B\u4E0EMAR\u548C MDR\u6709\u5F02\u66F2\u540C\u5DE5\u4E4B\u5999\n- \u4E34\u65F6\u5BC4\u5B58\u5668 \u0060t0~t3\u0060 \u548C \u0060at\u0060 (\u5728 \u0060src/cpu/decode/decode.c\u0060 \u4E2D\u5B9A\u4E49)\n\n\u0060\u0060\u0060c\nextern rtlreg_t t0, t1, t2, t3, at;\n\u0060\u0060\u0060\n\n- \u5B8F \u0060make_rtl_arith_logic\u0060 \u6839\u636E\u7B97\u672F\u8FD0\u7B97\u7B26\u540D\u521B\u5EFA\u5BF9\u5E94 RTL \u57FA\u672C\u6307\u4EE4\u548C RTL \u6307\u4EE4\uFF0C\u4F7F\u7528\u4E86 \u0060include/util/c_op.h\u0060 \u4E2D\u7684\u8FD0\u7B97\u3002\n    - 32\u4F4D\u5BC4\u5B58\u5668-\u5BC4\u5B58\u5668\u7C7B\u578B\u7684\u7B97\u672F/\u903B\u8F91\u8FD0\u7B97\n    - 32\u4F4D\u5BC4\u5B58\u5668-\u7ACB\u5373\u6570\u7C7B\u578B\u7684\u7B97\u672F/\u903B\u8F91\u8FD0\u7B97\n- \u5B9A\u4E49\u51FD\u6570 \u0060decoding_set_jmp(bool is_jmp)\u0060 \uFF1A\u5C06 \u5F53\u524D\u6307\u4EE4\u6807\u8BB0\u4E3A\u8DF3\u8F6C\uFF08\u6807\u8BB0 \u0060decoing.is_jmp\u0060\uFF09\n- \u5B9A\u4E49\u51FD\u6570 \u0060interpret_relop\u0060 \uFF1A\u5B9E\u73B0\u4E24\u4E2A\u503C\u7684\u5173\u7CFB\u8FD0\u7B97\uFF0C\u8FD4\u56DE\u7ED3\u679C\uFF08\u5B9E\u73B0\u5728 \u0060src/cpu/exec/relop.c\u0060\n\n#### RTL \u57FA\u672C\u6307\u4EE4\n\n\u7279\u70B9\uFF1A\u4E0D\u9700\u8981\u4F7F\u7528\u4E34\u65F6\u5BC4\u5B58\u5668, \u53EF\u4EE5\u770B\u505A\u662F\u6700\u57FA\u672C\u7684x86\u6307\u4EE4\u4E2D\u7684\u6700\u57FA\u672C\u7684\u64CD\u4F5C\u3002\n\u5B9E\u73B0\u65F6\u6DFB\u52A0\u4E86 \u0060interpret_\u0060 \u524D\u7F00\uFF0C\u4F46\u5728 \u0060include/cpu/rtl-wrapper.h\u0060 \u4F5C\u7528\u4E0B\uFF0C\u5176\u5B83\u4EE3\u7801\u4E2D\u4F7F\u7528\u5230\u8FD9\u4E9BRTL\u57FA\u672C\u6307\u4EE4\u65F6\u4F1A\u81EA\u52A8\u6DFB\u52A0 \u0060interpret_\u0060 \u524D\u7F00\u3002\n\n- \u7ACB\u5373\u6570\u8BFB\u5165 \u0060rtl_li\u0060\n- \u5BC4\u5B58\u5668\u4F20\u8F93 \u0060rtl_mv\u0060\n- 32\u4F4D\u5BC4\u5B58\u5668-\u5BC4\u5B58\u5668\u7C7B\u578B\u7684\u7B97\u672F/\u903B\u8F91\u8FD0\u7B97, \u5305\u62EC \u0060rtl_(add|sub|and|or|xor|shl|shr|sar|i?mul_[lo|hi]|i?div_[q|r])\u0060 , \u8FD9\u4E9B\u8FD0\u7B97\u7684\u5B9A\u4E49\u7528\u5230  \u0060include/util/c_op.h\u0060 \u4E2D\u7684C\u8BED\u8A00\u8FD0\u7B97\n- \u88AB\u9664\u6570\u4E3A64\u4F4D\u7684\u9664\u6CD5\u8FD0\u7B97 \u0060rtl_i?div64_[q|r]\u0060\n- guest\u5185\u5B58\u8BBF\u95EE \u0060rtl_lm\u0060 \u548C \u0060rtl_sm\u0060\n- host\u5185\u5B58\u8BBF\u95EE \u0060rtl_host_lm\u0060 \u548C \u0060rtl_host_sm\u0060 \n- \u5173\u7CFB\u8FD0\u7B97 \u0060rtl_setrelop\u0060, \u5177\u4F53\u53EF\u53C2\u8003 \u0060src/cpu/exec/relop.c\u0060\n- \u8DF3\u8F6C, \u5305\u62EC\u76F4\u63A5\u8DF3\u8F6C \u0060rtl_j\u0060 , \u95F4\u63A5\u8DF3\u8F6C \u0060rtl_jr\u0060 \u548C\u6761\u4EF6\u8DF3\u8F6C \u0060rtl_jrelop\u0060\n- \u7EC8\u6B62\u7A0B\u5E8F \u0060rtl_exit\u0060\n\n\u5177\u4F53\u58F0\u660E\uFF1A\n\n- \u672A\u6807\u660E\u5219\u51FD\u6570\u4FEE\u9970\u7B26\u5747\u4E3A \u0060static inline\u0060\u3002\n\n\u0060\u0060\u0060c\n// \u7ACB\u5373\u6570\u8BFB\u5165\nvoid interpret_rtl_li(rtlreg_t* dest, uint32_t imm);\n\n// \u5BC4\u5B58\u5668\u4F20\u8F93\nvoid interpret_rtl_mv(rtlreg_t* dest, const rtlreg_t *src1);\n\n// 32\u4F4D\u5BC4\u5B58\u5668-\u5BC4\u5B58\u5668\u7C7B\u578B\u7684\u7B97\u672F/\u903B\u8F91\u8FD0\u7B97\nvoid interpret_rtl_add (rtlreg_t* dest, const rtlreg_t* src1, const rtlreg_t* src2);\n\n// \u88AB\u9664\u6570\u4E3A64\u4F4D\u7684\u9664\u6CD5\u8FD0\u7B97\nvoid interpret_rtl_div64_q(rtlreg_t* dest,\n    const rtlreg_t* src1_hi, const rtlreg_t* src1_lo, const rtlreg_t* src2);\n\n// guest\u5185\u5B58\u8BBF\u95EE\nvoid interpret_rtl_lm(rtlreg_t *dest, const rtlreg_t* addr, int len);\nvoid interpret_rtl_sm(const rtlreg_t* addr, const rtlreg_t* src1, int len);\n\n// host\u5185\u5B58\u8BBF\u95EE\nvoid interpret_rtl_host_lm(rtlreg_t* dest, const void *addr, int len);\nvoid interpret_rtl_host_sm(void *addr, const rtlreg_t *src1, int len);\n\n// \u5173\u7CFB\u8FD0\u7B97\nvoid interpret_rtl_setrelop(uint32_t relop, rtlreg_t *dest, const rtlreg_t *src1, const rtlreg_t *src2);\n\n// \u8DF3\u8F6C\nvoid interpret_rtl_j(vaddr_t target);\nvoid interpret_rtl_jr(rtlreg_t *target);\nvoid interpret_rtl_jrelop(uint32_t relop, const rtlreg_t *src1, const rtlreg_t *src2, vaddr_t target);\n\n// \u7EC8\u6B62\u7A0B\u5E8F\nvoid interpret_rtl_exit(int state);\n\u0060\u0060\u0060\n\n#### RTL \u4F2A\u6307\u4EE4\n\n\u901A\u8FC7RTL\u57FA\u672C\u6307\u4EE4\u6216\u8005\u5DF2\u7ECF\u5B9E\u73B0\u7684RTL\u4F2A\u6307\u4EE4\u6765\u5B9E\u73B0\u3002\n\n- 32\u4F4D\u5BC4\u5B58\u5668-\u7ACB\u5373\u6570\u7C7B\u578B\u7684\u7B97\u672F/\u903B\u8F91\u8FD0\u7B97, \u5305\u62EC \u0060rtl_(add|sub|and|or|xor|shl|shr|sar|i?mul_[lo|hi]|i?div_[q|r])_i\u0060\n- \u901A\u7528\u5BC4\u5B58\u5668\u8BBF\u95EE \u0060rtl_lr\u0060 \u548C \u0060rtl_sr\u0060\n- EFLAGS\u6807\u5FD7\u4F4D\u7684\u8BFB\u5199 \u0060rtl_set_(CF|OF|ZF|SF)\u0060 \u548C \u0060rtl_get_(CF|OF|ZF|SF)\u0060\n- \u5176\u5B83\u5E38\u7528\u529F\u80FD, \u5982\u6309\u4F4D\u53D6\u53CD \u0060rtl_not\u0060 \uFF0C\u7B26\u53F7\u6269\u5C55 \u0060rtl_sext\u0060 \u7B49\n\n\u5177\u4F53\u58F0\u660E\uFF1A\n\n- \u672A\u6807\u660E\u5219\u51FD\u6570\u4FEE\u9970\u7B26\u5747\u4E3A \u0060static inline\u0060\u3002\n- \u5B8F \u0060make_rtl_setget_eflags\u0060 \u58F0\u660E\u4E86\u9700\u8981\u5B9E\u73B0\u7684 EFLAGS\u6807\u5FD7\u4F4D\u7684\u8BFB\u5199 \u6307\u4EE4\n    - \u0060rtl_set_name\u0060\n    - \u0060rtl_get_name\u0060\n\n\u0060\u0060\u0060c\n// 32\u4F4D\u5BC4\u5B58\u5668-\u7ACB\u5373\u6570\u7C7B\u578B\u7684\u7B97\u672F/\u903B\u8F91\u8FD0\u7B97\nvoid rtl_addi (rtlreg_t* dest, const rtlreg_t* src1, int imm)\n\n// \u901A\u7528\u5BC4\u5B58\u5668\u8BBF\u95EE\nvoid rtl_lr(rtlreg_t* dest, int r, int width);\nvoid rtl_sr(int r, const rtlreg_t* src1, int width);\n\n// EFLAGS\u6807\u5FD7\u4F4D\u7684\u8BFB\u5199\nvoid rtl_set_CF (const rtlreg_t* src);\nvoid rtl_get_CF (rtlreg_t* dest);\nvoid rtl_set_OF (const rtlreg_t* src);\nvoid rtl_get_OF (rtlreg_t* dest);\nvoid rtl_set_ZF (const rtlreg_t* src);\nvoid rtl_get_ZF (rtlreg_t* dest);\nvoid rtl_set_SF (const rtlreg_t* src);\nvoid rtl_get_SF (rtlreg_t* dest);\n\n// \u6839\u636E\u8FD0\u7B97\u7ED3\u6784\u66F4\u65B0 ZF, SF \u6807\u5FD7\u4F4D\nvoid rtl_update_ZF(const rtlreg_t* result, int width);\nvoid rtl_update_SF(const rtlreg_t* result, int width);\nvoid rtl_update_ZFSF(const rtlreg_t* result, int width);\n\n// \u6309\u4F4D\u53D6\u53CD\nvoid rtl_not(rtlreg_t *dest, const rtlreg_t* src1);\n\n// \u7B26\u53F7\u6269\u5C55\nvoid rtl_sext(rtlreg_t* dest, const rtlreg_t* src1, int width);\n\n// \u538B\u6808\nvoid rtl_push(const rtlreg_t* src1);\n\n// \u5F39\u6808\nvoid rtl_pop(rtlreg_t* dest);\n\n// 32\u4F4D\u5BC4\u5B58\u5668-\u7ACB\u5373\u6570\u7C7B\u578B \u5173\u7CFB\u8FD0\u7B97\nvoid rtl_setrelopi(uint32_t relop, rtlreg_t *dest, const rtlreg_t *src1, int imm);\n\n// \u53D6\u7B26\u53F7\u4F4D\uFF08\u6700\u9AD8\u4F4D\uFF09\nvoid rtl_msb(rtlreg_t* dest, const rtlreg_t* src1, int width);\n\u0060\u0060\u0060\n\n{% note warning %}\n\u6211\u4EEC\u5B9A\u4E49RTL\u57FA\u672C\u6307\u4EE4\u7684\u65F6\u5019, \u7EA6\u5B9A\u4E86RTL\u57FA\u672C\u6307\u4EE4\u4E0D\u9700\u8981\u4F7F\u7528RTL\u4E34\u65F6\u5BC4\u5B58\u5668. \u4F46\u67D0\u4E9BRTL\u4F2A\u6307\u4EE4\u9700\u8981\u4F7F\u7528\u4E34\u65F6\u5BC4\u5B58\u5668\u5B58\u653E\u4E2D\u95F4\u7ED3\u679C, \u624D\u80FD\u5B9E\u73B0\u5176\u5B8C\u6574\u529F\u80FD. \u8FD9\u6837\u53EF\u80FD\u4F1A\u5E26\u6765\u5BC4\u5B58\u5668\u8986\u76D6\u7684\u95EE\u9898, \u4F8B\u5982\u5982\u4E0BRTL\u6307\u4EE4\u5E8F\u5217:\n\u003Ccode\u003E\n(1) rtl_mv(\u0026t0, \u0026t1);\n(2) rtl_sext(\u0026t1, \u0026t2, 1);  // use t0 temporarily\n(3) rtl_add(\u0026t2, \u0026t0, \u0026t1);\n\u003C/code\u003E\n\u5982\u679C\u5B9E\u73B0(2)\u7684\u65F6\u5019\u6070\u597D\u4F7F\u7528\u5230\u4E86t0\u4F5C\u4E3A\u4E34\u65F6\u5BC4\u5B58\u5668, \u5728(3)\u4E2D\u4F7F\u7528\u7684t0\u5C31\u4E0D\u518D\u662F(1)\u7684\u7ED3\u679C\u4E86, \u4ECE\u800C\u4EA7\u751F\u975E\u9884\u671F\u7684\u7ED3\u679C.\n\n\u4E3A\u4E86\u5C3D\u53EF\u80FD\u907F\u514D\u4E0A\u8FF0\u95EE\u9898, \u6211\u4EEC\u6709\u4E24\u6761\u7EA6\u5B9A:\n\n- \u5B9E\u73B0RTL\u4F2A\u6307\u4EE4\u7684\u65F6\u5019, \u5C3D\u53EF\u80FD\u4E0D\u4F7F\u7528 \u0060dest\u0060 \u4E4B\u5916\u7684\u5BC4\u5B58\u5668\u5B58\u653E\u4E2D\u95F4\u7ED3\u679C. \u7531\u4E8E \u0060dest\u0060 \u6700\u540E\u4F1A\u88AB\u5199\u5165\u65B0\u503C, \u5176\u65E7\u503C\u80AF\u5B9A\u8981\u88AB\u8986\u76D6, \u81EA\u7136\u4E5F\u53EF\u4EE5\u5B89\u5168\u5730\u4F5C\u4E3ARTL\u4F2A\u6307\u4EE4\u7684\u4E34\u65F6\u5BC4\u5B58\u5668.\n- \u5B9E\u5728\u9700\u8981\u4F7F\u7528\u4E34\u65F6\u5BC4\u5B58\u5668\u7684\u65F6\u5019, \u4F7F\u7528 \u0060at\u0060 . \u0060at\u0060 \u5168\u79F0\u662Fassembly temporary, \u662FMIPS ABI\u4E2D\u5B9A\u4E49\u7684\u4E00\u4E2A\u7279\u6B8A\u5BC4\u5B58\u5668: \u7F16\u8BD1\u5668\u5E76\u4E0D\u4F1A\u4F7F\u7528\u5B83, \u5B83\u53EF\u4EE5\u5728\u7F16\u5199\u6C47\u7F16\u4EE3\u7801\u7684\u65F6\u5019\u5B89\u5168\u5730\u4F5C\u4E3A\u53EF\u4F7F\u7528\u7684\u4E34\u65F6\u5BC4\u5B58\u5668. \u5728\u8FD9\u91CC\uFF0C \u6211\u4EEC\u501F\u9274\u5B83\u7684\u529F\u80FD\u6765\u4F5C\u5982\u4E0B\u7EA6\u5B9A: \u4E0D\u8981\u5728RTL\u4F2A\u6307\u4EE4\u7684\u5185\u90E8\u5B9E\u73B0\u4E4B\u5916\u4F7F\u7528 \u0060at\u0060 . \u8FD9\u6837\uFF0C \u0060at\u0060 \u5C31\u53EF\u4EE5\u5B89\u5168\u5730\u4F5C\u4E3ARTL\u4F2A\u6307\u4EE4\u7684\u4E34\u65F6\u5BC4\u5B58\u5668\u4E86.\n{% endnote %}\n\n### rtl-wrapper.h\n\n\u4E3A rtl.h \u4E2D\u5B9A\u4E49\u7684 RTL \u57FA\u672C\u6307\u4EE4\u7684\u8C03\u7528\u7701\u53BB \u0060interpret_\u0060 \u524D\u7F00\u3002\n\n## memory/\n\n### memory.h\n\n\u5B9A\u4E49\u4E86\u8BBF\u95EE\u5185\u5B58\u7684\u51FD\u6570\u3002\u4F7F\u7528\u6570\u7EC4 \u0060pmem\u0060 \u6A21\u62DF\u5185\u5B58\u3002\n\n\u0060\u0060\u0060c\nextern uint8_t pmem[];\n\u0060\u0060\u0060\n\n|\u51FD\u6570/\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060uint32_t vaddr_read(vaddr_t, int)\u0060|\u4ECE\u865A\u62DF\u5185\u5B58\u6307\u5B9A\u4F4D\u7F6E\u8BFB\u53D6\u6307\u5B9A\u6570\u76EE\u4E2A\u5B57\u8282|\n|\u0060void vaddr_write(vaddr_t, uint32_t, int)\u0060|\u5411\u865A\u62DF\u5185\u5B58\u6307\u5B9A\u4F4D\u7F6E\u5199\u5165\u6307\u5B9A\u6570\u76EE\u4E2A\u5B57\u8282|\n|\u0060uint32_t paddr_read(paddr_t, int)\u0060|\u4ECE\u7269\u7406\u5185\u5B58\u6307\u5B9A\u4F4D\u7F6E\u8BFB\u53D6\u6307\u5B9A\u6570\u76EE\u4E2A\u5B57\u8282|\n|\u0060void paddr_write(paddr_t, uint32_t, int)\u0060|\u5411\u7269\u7406\u5185\u5B58\u6307\u5B9A\u4F4D\u7F6E\u5199\u5165\u6307\u5B9A\u6570\u76EE\u4E2A\u5B57\u8282|\n|\u0060guest_to_host(p)\u0060|\u0060((void *)(pmem \u002B (unsigned)p))\u0060|\n|\u0060host_to_guest(p)\u0060|\u0060((paddr_t)((void *)p - (void *)pmem))\u0060|\n\n### mmu.h\n\n(TODO)\n\n#### \u7ED3\u6784\u4F53 GateDesc\n\n\u6307\u793A\u4E2D\u65AD\u64CD\u4F5C\u7684\u95E8\u63CF\u8FF0\u7B26(Gate Descriptor)\u7C7B\u578B\u3002\u95E8\u63CF\u8FF0\u7B26\u662F\u4E00\u4E2A8\u5B57\u8282\u7684\u7ED3\u6784\u4F53, \u91CC\u9762\u5305\u542B\u7740\u4E0D\u5C11\u7EC6\u8282\u7684\u4FE1\u606F, \u5728NEMU\u4E2D\u7B80\u5316\u4E86\u95E8\u63CF\u8FF0\u7B26\u7684\u7ED3\u6784, \u53EA\u4FDD\u7559\u5B58\u5728\u4F4DP\u548C\u504F\u79FB\u91CFOFFSET\u3002\n\n\u0060\u0060\u0060\n   31                23                15                7                0\n  \u002B-----------------\u002B-----------------\u002B---\u002B-------------------------------\u002B\n  |           OFFSET 31..16           | P |          Don\u0027t care           |4\n  \u002B-----------------------------------\u002B---\u002B-------------------------------\u002B\n  |             Don\u0027t care            |           OFFSET 15..0            |0\n  \u002B-----------------\u002B-----------------\u002B-----------------\u002B-----------------\u002B\n\u0060\u0060\u0060\n\n\u5728 \u0060raise_intr\u0060\uFF08\u5B9A\u4E49\u5728 \u0060intr.c\u0060 \u4E2D\uFF09\u4E2D\u4F7F\u7528\u3002\n\n|\u6210\u5458|\u63CF\u8FF0|\n|-|-|\n|\u0060offset_15_0\u0060|Offset \u4F4E\u4F4D\u90E8\u5206|\n|\u0060offset_31_16\u0060|Offset \u9AD8\u4F4D\u90E8\u5206|\n|\u0060present\u0060|\u6807\u8BC6\u662F\u5426\u6709\u6548|\n\n- \u4E3A\u65B9\u4FBF\u4ECE\u5185\u5B58\u4E2D\u8BFB\u53D6\uFF0C\u4F7F\u7528 union \u7ED3\u6784\u4EE5\u53CA \u0060val0 val1\u0060 \u57DF\u7B80\u5316\u8BFB\u5199\u3002\n- \u6B64\u7ED3\u6784\u4F53\u4E0E AM \u4E2D\u5B9A\u4E49\u7684 \u0060GateDesc\u0060 \uFF08\u5728 \u0060arch/x86-nemu/include/x86.h\u0060 \u4E2D\uFF09\u7ED3\u6784\u76F8\u540C\u3002\n\n## device/\n\n### mmio.h\n\n\u5BF9\u5185\u5B58\u6620\u5C04 I/O \u7F16\u5740\u65B9\u5F0F\u7684\u652F\u6301\u3002\u6CE8\u610F\uFF0C\u5185\u5B58\u6620\u5C04 I/O \u7684\u8BFB\u5199\u5E76\u4E0D\u662F\u9762\u5411 CPU \u7684\u3002\n\n\u003E \u7AEF\u53E3\u6620\u5C04I/O\u628A\u7AEF\u53E3\u53F7\u4F5C\u4E3AI/O\u6307\u4EE4\u7684\u4E00\u90E8\u5206, \u8FD9\u79CD\u65B9\u6CD5\u5F88\u7B80\u5355, \u4F46\u540C\u65F6\u4E5F\u662F\u5B83\u6700\u5927\u7684\u7F3A\u70B9. \u6307\u4EE4\u96C6\u4E3A\u4E86\u517C\u5BB9\u5DF2\u7ECF\u5F00\u53D1\u7684\u7A0B\u5E8F, \u662F\u53EA\u80FD\u6DFB\u52A0\u4F46\u4E0D\u80FD\u4FEE\u6539\u7684. \u8FD9\u610F\u5473\u7740, \u7AEF\u53E3\u6620\u5C04I/O\u6240\u80FD\u8BBF\u95EE\u7684I/O\u5730\u5740\u7A7A\u95F4\u7684\u5927\u5C0F, \u5728\u8BBE\u8BA1I/O\u6307\u4EE4\u7684\u90A3\u4E00\u523B\u5C31\u5DF2\u7ECF\u51B3\u5B9A\u4E0B\u6765\u4E86. \u6240\u8C13I/O\u5730\u5740\u7A7A\u95F4, \u5176\u5B9E\u5C31\u662F\u6240\u6709\u80FD\u8BBF\u95EE\u7684\u8BBE\u5907\u7684\u5730\u5740\u7684\u96C6\u5408. \u968F\u7740\u8BBE\u5907\u8D8A\u6765\u8D8A\u591A, \u529F\u80FD\u4E5F\u8D8A\u6765\u8D8A\u590D\u6742, I/O\u5730\u5740\u7A7A\u95F4\u6709\u9650\u7684\u7AEF\u53E3\u6620\u5C04I/O\u5DF2\u7ECF\u9010\u6E10\u4E0D\u80FD\u6EE1\u8DB3\u9700\u6C42\u4E86. \u6709\u7684\u8BBE\u5907\u9700\u8981\u8BA9CPU\u8BBF\u95EE\u4E00\u6BB5\u8F83\u5927\u7684\u8FDE\u7EED\u5B58\u50A8\u7A7A\u95F4, \u5982VGA\u7684\u663E\u5B58, 24\u8272\u52A0\u4E0AAlpha\u901A\u9053\u76841024x768\u5206\u8FA8\u7387\u7684\u663E\u5B58\u5C31\u9700\u89813MB\u7684\u7F16\u5740\u8303\u56F4. \u4E8E\u662F\u5185\u5B58\u6620\u5C04I/O(memory-mapped I/O)\u5E94\u8FD0\u800C\u751F.\n\u003E \u5185\u5B58\u6620\u5C04I/O\u8FD9\u79CD\u7F16\u5740\u65B9\u5F0F\u975E\u5E38\u5DE7\u5999, \u5B83\u662F\u901A\u8FC7\u4E0D\u540C\u7684\u7269\u7406\u5185\u5B58\u5730\u5740\u7ED9\u8BBE\u5907\u7F16\u5740\u7684. \u8FD9\u79CD\u7F16\u5740\u65B9\u5F0F\u5C06\u4E00\u90E8\u5206\u7269\u7406\u5185\u5B58\u0022\u91CD\u5B9A\u5411\u0022\u5230I/O\u5730\u5740\u7A7A\u95F4\u4E2D, CPU\u5C1D\u8BD5\u8BBF\u95EE\u8FD9\u90E8\u5206\u7269\u7406\u5185\u5B58\u7684\u65F6\u5019, \u5B9E\u9645\u4E0A\u6700\u7EC8\u662F\u8BBF\u95EE\u4E86\u76F8\u5E94\u7684I/O\u8BBE\u5907, CPU\u5374\u6D51\u7136\u4E0D\u77E5. \u8FD9\u6837\u4EE5\u540E, CPU\u5C31\u53EF\u4EE5\u901A\u8FC7\u666E\u901A\u7684\u8BBF\u5B58\u6307\u4EE4\u6765\u8BBF\u95EE\u8BBE\u5907. \u8FD9\u4E5F\u662F\u5185\u5B58\u6620\u5C04I/O\u5F97\u5929\u72EC\u539A\u7684\u597D\u5904: \u7269\u7406\u5185\u5B58\u7684\u5730\u5740\u7A7A\u95F4\u548CCPU\u7684\u4F4D\u5BBD\u90FD\u4F1A\u4E0D\u65AD\u589E\u957F, \u5185\u5B58\u6620\u5C04I/O\u4ECE\u6765\u4E0D\u9700\u8981\u62C5\u5FC3I/O\u5730\u5740\u7A7A\u95F4\u8017\u5C3D\u7684\u95EE\u9898. \u4ECE\u539F\u7406\u4E0A\u6765\u8BF4, \u5185\u5B58\u6620\u5C04I/O\u552F\u4E00\u7684\u7F3A\u70B9\u5C31\u662F, CPU\u65E0\u6CD5\u901A\u8FC7\u6B63\u5E38\u6E20\u9053\u76F4\u63A5\u8BBF\u95EE\u90A3\u4E9B\u88AB\u6620\u5C04\u5230I/O\u5730\u5740\u7A7A\u95F4\u7684\u7269\u7406\u5185\u5B58\u4E86. \u4F46\u968F\u7740\u8BA1\u7B97\u673A\u7684\u53D1\u5C55, \u5185\u5B58\u6620\u5C04I/O\u7684\u552F\u4E00\u7F3A\u70B9\u5DF2\u7ECF\u8D8A\u6765\u8D8A\u4E0D\u660E\u663E\u4E86: \u73B0\u4EE3\u8BA1\u7B97\u673A\u90FD\u5DF2\u7ECF\u662F64\u4F4D\u8BA1\u7B97\u673A, \u7269\u7406\u5730\u5740\u7EBF\u90FD\u670948\u6839, \u8FD9\u610F\u5473\u7740\u7269\u7406\u5730\u5740\u7A7A\u95F4\u6709256TB\u8FD9\u4E48\u5927, \u4ECE\u91CC\u9762\u5212\u51FA3MB\u7684\u5730\u5740\u7A7A\u95F4\u7ED9\u663E\u5B58, \u6839\u672C\u5C31\u662F\u4E0D\u75DB\u4E0D\u75D2. \u6B63\u56E0\u4E3A\u5982\u6B64, \u5185\u5B58\u6620\u5C04I/O\u6210\u4E3A\u4E86\u73B0\u4EE3\u8BA1\u7B97\u673A\u4E3B\u6D41\u7684I/O\u7F16\u5740\u65B9\u5F0F: RISC\u67B6\u6784\u53EA\u63D0\u4F9B\u5185\u5B58\u6620\u5C04I/O\u7684\u7F16\u5740\u65B9\u5F0F, \u800CPCI-e, \u7F51\u5361, x86\u7684APIC\u7B49\u4E3B\u6D41\u8BBE\u5907, \u90FD\u652F\u6301\u901A\u8FC7\u5185\u5B58\u6620\u5C04I/O\u6765\u8BBF\u95EE.\n\n{% note info %}\n\u5728 NEMU \u4E2D\uFF0C video memory\u662F\u552F\u4E00\u4F7F\u7528\u5185\u5B58\u6620\u5C04 I/O \u65B9\u5F0F\u8BBF\u95EE\u7684 I/O \u7A7A\u95F4\u3002\n{% endnote %}\n\n\u5B9A\u4E49\u4E86\u7C7B\u578B \u0060mmio_callback_t\u0060 \uFF0C\u8BBE\u5907\u5B9A\u4E49\u7684\u56DE\u8C03\u51FD\u6570\uFF0C\u7528\u4EE5\u66F4\u65B0\u8BBE\u5907\u72B6\u6001\u3002\n\n\u0060\u0060\u0060c\ntypedef void(*mmio_callback_t)(paddr_t, int, bool);\n\u0060\u0060\u0060\n\n|\u51FD\u6570|\u63CF\u8FF0|\n|-|-|\n|\u0060void* add_mmio_map(paddr_t, int, mmio_callback_t)\u0060|\u6CE8\u518C\u4E00\u4E2A\u5185\u5B58\u6620\u5C04 I/O \u6620\u5C04\u5173\u7CFB\uFF0C\u8FD4\u56DE\u8BE5\u6620\u5C04\u5173\u7CFB\u7684 I/O \u7A7A\u95F4\u9996\u5730\u5740|\n|\u0060int is_mmio(paddr_t)\u0060|\u5224\u65AD\u4E00\u4E2A\u7269\u7406\u5730\u5740\u662F\u5426\u88AB\u6620\u5C04\u5230 I/O \u7A7A\u95F4\uFF0C\u5982\u679C\u662F\uFF0C\u8FD4\u56DE\u6620\u5C04\u53F7, \u5426\u5219\u8FD4\u56DE -1|\n|\u0060uint32_t mmio_read(paddr_t, int, int)\u0060|\u6839\u636E\u7AEF\u53E3\u53F7\u548C\u5730\u5740\u8BFB\u53D6|\n|\u0060void mmio_write(paddr_t, int, uint32_t, int)\u0060|\u6839\u636E\u7AEF\u53E3\u53F7\u548C\u5730\u5740\u5199\u5165|\n\n### port-io.h\n\n\u5BF9\u7AEF\u53E3\u6620\u5C04 I/O \u7F16\u5740\u65B9\u5F0F\u7684\u652F\u6301\u3002\u7AEF\u53E3\u6620\u5C04I/O(port-mapped I/O)\uFF0C CPU\u4F7F\u7528\u4E13\u95E8\u7684I/O\u6307\u4EE4\u5BF9\u8BBE\u5907\u8FDB\u884C\u8BBF\u95EE\uFF0C \u5E76\u628A\u8BBE\u5907\u7684\u5730\u5740\u79F0\u4F5C\u7AEF\u53E3\u53F7\u3002 \u6709\u4E86\u7AEF\u53E3\u53F7\u4EE5\u540E\uFF0C \u5728I/O\u6307\u4EE4\u4E2D\u7ED9\u51FA\u7AEF\u53E3\u53F7\uFF0C \u5C31\u77E5\u9053\u8981\u8BBF\u95EE\u54EA\u4E00\u4E2A\u8BBE\u5907\u5BC4\u5B58\u5668\u4E86\u3002\n\n\u5B9A\u4E49\u4E86\u7C7B\u578B \u0060pio_callback_t\u0060 \uFF0C\u8BBE\u5907\u5B9A\u4E49\u7684\u56DE\u8C03\u51FD\u6570\uFF0C\u7528\u4EE5\u66F4\u65B0\u8BBE\u5907\u72B6\u6001\u3002\n\n\u0060\u0060\u0060c\ntypedef void(*pio_callback_t)(ioaddr_t, int, bool);\n\u0060\u0060\u0060\n\n|\u51FD\u6570|\u63CF\u8FF0|\n|-|-|\n|\u0060void* add_pio_map(paddr_t, int, mmio_callback_t)\u0060|\u6CE8\u518C\u4E00\u4E2A\u7AEF\u53E3\u6620\u5C04 I/O \u6620\u5C04\u5173\u7CFB\uFF0C\u8FD4\u56DE\u8BE5\u6620\u5C04\u5173\u7CFB\u7684 I/O \u7A7A\u95F4\u9996\u5730\u5740|\n|\u0060uint32_t pio_read_[l,w,b](ioaddr_t)\u0060|\u9762\u5411 CPU \u7684\u7AEF\u53E3 I/O \u8BFB\u63A5\u53E3|\n|\u0060void pio_write_[l,w,b](ioaddr_t, uint32_t)\u0060|\u9762\u5411 CPU \u7684\u7AEF\u53E3 I/O \u5199\u63A5\u53E3|\n\n## monitor/\n\n\u76D1\u89C6\u5668\u90E8\u5206\uFF08\u4E5F\u5305\u542B NEMU \u6267\u884C\u4E3B\u5FAA\u73AF\uFF09\u3002\n\n### expr.h\n\n\u5B9A\u4E49\u4E86\u8BA1\u7B97\u8868\u8FBE\u5F0F\u7684\u503C\u7684\u51FD\u6570 \u0060expr\u0060\u3002\n\n\u0060\u0060\u0060c\nuint32_t expr(char *, bool *);\n\u0060\u0060\u0060\n\n### monitor.h\n\n\u5B9A\u4E49\u4E86 NEMU \u72B6\u6001 \u53D8\u91CF \u0060nemu_state\u0060\uFF0C\u548C\u679A\u4E3E\u503C \u0060NEMU_STOP, NEMU_RUNNING, NEMU_END, NEMU_ABORT\u0060\u3002\n\u5B9A\u4E49\u4E86 \u5E94\u7528\u7A0B\u5E8F\u5165\u53E3\u70B9 \u0060ENTRY_START\u0060 \uFF1A\n\u0060\u0060\u0060c\n#define ENTRY_START 0x100000\n\u0060\u0060\u0060\n\n### watchpoint.h\n\n#### \u7ED3\u6784\u4F53 WP \n\n\u76D1\u89C6\u70B9\u7ED3\u6784\u3002\u91C7\u7528\u94FE\u8868\u7ED3\u6784\u5B58\u50A8\u3002\n\n|\u6210\u5458|\u63CF\u8FF0|\n|-|-|\n|\u0060NO\u0060|\u5E8F\u53F7|\n|\u0060next\u0060|\u4E0B\u4E00\u76D1\u89C6\u70B9\u6307\u9488|\n|\u0060expr\u0060|\u76D1\u89C6\u7684\u8868\u8FBE\u5F0F|\n|\u0060lastVal\u0060|\u8868\u8FBE\u5F0F\u6700\u8FD1\u4E00\u6B21\u7684\u503C|\n\n## util/\n\n### c_op.h\n\n\u5B9A\u4E49\u4E86\u4E00\u4E9B\u5F62\u5982 \u0060c_opname_type\u0060 \u7684\u5B8F\uFF0C\u7528\u4E8E\u8868\u793A\u57FA\u7840 C \u8FD0\u7B97\u3002\u5728 RTL\u57FA\u672C\u6307\u4EE4\u4E2D\u7684\u5BC4\u5B58\u5668\u8FD0\u7B97\u6307\u4EE4\u4E2D\u4F7F\u7528\u3002\n\n# src/\n\n## main.c\n\nNEMU \u4E3B\u7A0B\u5E8F\u3002\n\n\u8C03\u7528 \u0060init_monitor\u0060 \uFF08\u5B9E\u73B0\u5728 \u0060/src/monitor/monitor.c\u0060\uFF09\u521D\u59CB\u5316\u76D1\u89C6\u5668\uFF0C\u5E76\u83B7\u53D6\u5F53\u524D\u662F\u5426\u4E3A\u6279\u5904\u7406\u6A21\u5F0F\u3002\n\u8C03\u7528 \u0060ui_mainloop\u0060 \uFF08\u5B9E\u73B0\u5728 \u0060/src/monitor/debug/ui.c\u0060\uFF09\u8FDB\u884C\u6307\u4EE4\u6267\u884C\u6A21\u62DF\u3002\n\n## cpu/\n\n### reg.c\n\n\u5B9E\u73B0\u4E86 \u0060include/cpu/reg.h\u0060 \u4E2D\u7684 \u0060regsl,regsw,regsb\u0060\uFF0C\u540C\u65F6\u5B9E\u73B0\u5BC4\u5B58\u5668\u5B9E\u9645\u5B9A\u4E49\uFF1A\u53D8\u91CF \u0060cpu\u0060\u3002\n\n- \u51FD\u6570 \u0060reg_test\u0060\uFF1A\u6D4B\u8BD5\u5BC4\u5B58\u5668\u7ED3\u6784\u5B9A\u4E49\uFF08\u0060CPU_state\u0060\uFF09\u662F\u5426\u6B63\u786E\u3002\n\n### intr.c\n\n\u51FD\u6570 \u0060void raise_intr(uint8_t NO, vaddr_t ret_addr)\u0060 \u4E3A \u0060int\u0060 \u6307\u4EE4\uFF08\u5728 \u0060system.c\u0060 \u4E2D\u5B9E\u73B0\uFF09\u7684\u5185\u90E8\u5B9E\u73B0\u3002\n\u5B9E\u73B0\u4E86\u89E6\u53D1\u4E2D\u65AD\u6216\u5F02\u5E38\u540E\u7684\u786C\u4EF6\u5904\u7406\uFF1A\n\n1. \u4F9D\u6B21\u5C06EFLAGS, CS(\u4EE3\u7801\u6BB5\u5BC4\u5B58\u5668), EIP\u5BC4\u5B58\u5668\uFF08\u8FD4\u56DE\u5730\u5740\uFF09\u7684\u503C\u538B\u5165\u5806\u6808\n2. \u6839\u636E\u4E2D\u65AD\u7801\uFF0C\u4ECEIDTR\u4E2D\u8BFB\u51FAIDT\u7684\u9996\u5730\u5740\n3. \u6839\u636E\u5F02\u5E38\u53F7\u5728IDT\u4E2D\u8FDB\u884C\u7D22\u5F15, \u627E\u5230\u4E00\u4E2A\u95E8\u63CF\u8FF0\u7B26\n4. \u5C06\u95E8\u63CF\u8FF0\u7B26\u4E2D\u7684offset\u57DF\u7EC4\u5408\u6210\u76EE\u6807\u5730\u5740\n5. \u8DF3\u8F6C\u5230\u76EE\u6807\u5730\u5740\n\n### decode/\n\n\u6307\u4EE4\u8BD1\u7801\u76F8\u5173\u3002\n\n#### decode.c\n\n\u5B9E\u73B0\u4E86 \u0060include/cpu/decode.h\u0060 \u4E2D\u7684\u8BD1\u7801\u51FD\u6570\u65CF\uFF0C\u51FD\u6570 \u0060operand_write\u0060 \u4EE5\u53CA\u8BD1\u7801\u4FE1\u606F\u53D8\u91CF \u0060decoding\u0060\u3002\n\u5B9E\u73B0\u4E86 \u0060include/cpu/rtl.h\u0060 \u4E2D\u7684\u4E34\u65F6\u5BC4\u5B58\u5668 \u0060t0,t1,t2,t3,at\u0060 \u548C\u51FD\u6570 \u0060decoding_set_jmp\u0060\u3002\n\n##### \u5B8F make_DopHelper \u4E0E\u51FD\u6570\u65CF decode_op_name\n\n\u0060\u0060\u0060c\n#define make_DopHelper(name) void concat(decode_op_, name) (vaddr_t *eip, Operand *op, bool load_val)\n\u0060\u0060\u0060\n\n\u8BD1\u7801\u51FD\u6570\u4F1A\u8FDB\u4E00\u6B65\u5206\u89E3\u6210\u5404\u79CD\u4E0D\u540C\u64CD\u4F5C\u6570\u7684\u8BD1\u7801\u7684\u7EC4\u5408\uFF0C\u4EE5\u5B9E\u73B0\u64CD\u4F5C\u6570\u8BD1\u7801\u7684\u89E3\u8026. \u64CD\u4F5C\u6570\u8BD1\u7801\u51FD\u6570\u7EDF\u4E00\u901A\u8FC7\u5B8F \u0060make_DopHelper\u0060 \u6765\u5B9A\u4E49 \uFF08\u0060decode_op_rm\u0060 \u9664\u5916\uFF09\u3002\n\u64CD\u4F5C\u6570\u8BD1\u7801\u51FD\u6570\u4F1A\u628A\u64CD\u4F5C\u6570\u7684\u4FE1\u606F\u8BB0\u5F55\u5728\u7ED3\u6784\u4F53 \u0060op\u0060 \u4E2D, \u5982\u679C\u64CD\u4F5C\u6570\u5728\u6307\u4EE4\u4E2D\uFF0C \u5C31\u4F1A\u901A\u8FC7 \u0060instr_fetch()\u0060 \u5C06\u5B83\u4EEC\u4ECE \u0060eip\u0060 \u6240\u6307\u5411\u7684\u5185\u5B58\u4F4D\u7F6E\u53D6\u51FA. \u4E3A\u4E86\u4F7F\u64CD\u4F5C\u6570\u8BD1\u7801\u51FD\u6570\u66F4\u6613\u4E8E\u590D\u7528\uFF0C \u51FD\u6570\u4E2D\u7684 \u0060load_val\u0060 \u53C2\u6570\u4F1A\u63A7\u5236 \u662F\u5426\u9700\u8981\u5C06\u8BE5\u64CD\u4F5C\u6570\u8BFB\u51FA\u5230\u5168\u5C40\u8BD1\u7801\u4FE1\u606F \u0060decoding\u0060 \u4F9B\u540E\u7EED\u4F7F\u7528. \u4F8B\u5982\u5982\u679C\u4E00\u4E2A\u5185\u5B58\u64CD\u4F5C\u6570\u662F\u6E90\u64CD\u4F5C\u6570, \u5C31\u9700\u8981\u5C06\u8FD9\u4E2A\u64CD\u4F5C\u6570\u4ECE\u5185\u5B58\u4E2D\u8BFB\u51FA\u6765\u4F9B\u540E\u7EED\u6267\u884C\u9636\u6BB5\u6765\u4F7F\u7528\uFF1B \u5982\u679C\u5B83\u4EC5\u4EC5\u662F\u4E00\u4E2A\u76EE\u7684\u64CD\u4F5C\u6570\uFF0C \u5C31\u4E0D\u9700\u8981\u4ECE\u5185\u5B58\u8BFB\u51FA\u5B83\u7684\u503C\u4E86\uFF0C\u56E0\u4E3A\u6267\u884C\u8FD9\u6761\u6307\u4EE4\u5E76\u4E0D\u9700\u8981\u8FD9\u4E2A\u503C\uFF0C \u800C\u662F\u5C06\u65B0\u6570\u636E\u5199\u5165\u76F8\u5E94\u7684\u5185\u5B58\u4F4D\u7F6E.\n\n\u0060decode_op_name\u0060 \u51FD\u6570\u65CF\u547D\u540D\u89C4\u5219\u53EF\u53C2\u89C1 \u0060decode_name\u0060 \u51FD\u6570\u65CF\u547D\u540D\u89C4\u5219\u3002\n- \u0060decode_op_a\u0060 \u662F\u4E00\u4E2A\u7279\u4F8B\uFF0C\u5176\u7528\u4E8E\u5C06\u64CD\u4F5C\u6570\u6807\u8BB0\u4E3A\u5BC4\u5B58\u5668 \u0060ax\u0060 \u6216 \u0060eax\u0060\n\n#### modrm.c\n\n\u5B9E\u73B0\u4E86 \u0060include/cpu/decode.h\u0060 \u4E2D\u7684\u51FD\u6570 \u0060load_addr\u0060 \u548C \u0060read_ModR_M\u0060\u3002\n\n### exec/\n\n\u6307\u4EE4\u6267\u884C\u76F8\u5173\u3002\n\n#### cc.c\n\n\u5B9E\u73B0\u4E86 \u0060include/cpu/cc.h\u0060 \u4E2D\u7684\u51FD\u6570 \u0060rtl_setcc\u0060\u3002\u6839\u636E\u6307\u5B9A\u5173\u7CFB\u8FD0\u7B97\u4EE5\u53CA\u6761\u4EF6\u6807\u5FD7\u4F4D\u8BBE\u7F6E dest\u3002\n\n#### relop.c\n\n\u5B9E\u73B0\u4E86 \u0060include/cpu/relop.h\u0060 \u4E2D\u7684\u51FD\u6570 \u0060interpret_relop\u0060\uFF0C\u4F7F\u7528 C\u8BED\u8A00\u5173\u7CFB\u8FD0\u7B97\u7B26\u5B9E\u73B0\u5173\u7CFB\u8FD0\u7B97\u3002\n\n#### all-instr.h\n\n\u5B9A\u4E49\u4E86\u5DF2\u7ECF\u5B9E\u73B0\u7684\u6307\u4EE4\u6267\u884C\u51FD\u6570\uFF08\u5728 \u0060exec.c\u0060 \u4E2D\u4F7F\u7528\uFF09\u3002\n\n#### arith.c\n\n\u7B97\u672F\u8FD0\u7B97\u6307\u4EE4\u6267\u884C\u51FD\u6570\u5B9E\u73B0\u3002\n\n|\u6307\u4EE4|\u63CF\u8FF0|\n|-|-|\n|\u0060add\u0060||\n|\u0060sub\u0060||\n|\u0060cmp\u0060||\n|\u0060inc\u0060||\n|\u0060dec\u0060||\n|\u0060neg\u0060||\n|\u0060adc\u0060||\n|\u0060sbb\u0060||\n|\u0060mul\u0060||\n|\u0060imul1\u0060|imul \u5355\u64CD\u4F5C\u6570|\n|\u0060imul2\u0060|imul \u53CC\u64CD\u4F5C\u6570|\n|\u0060imul3\u0060|imul \u4E09\u64CD\u4F5C\u6570|\n|\u0060div\u0060||\n|\u0060idiv\u0060||\n\n#### control.c\n\n\u63A7\u5236\u6307\u4EE4\u6267\u884C\u51FD\u6570\u5B9E\u73B0\u3002\n\n|\u6307\u4EE4|\u63CF\u8FF0|\n|-|-|\n|\u0060jmp\u0060|\u76F4\u63A5\u8DF3\u8F6C|\n|\u0060jmp_rm\u0060|\u95F4\u63A5\u8DF3\u8F6C|\n|\u0060jcc\u0060|\u6761\u4EF6\u8DF3\u8F6C|\n|\u0060call\u0060|\u76F4\u63A5\u8C03\u7528|\n|\u0060call_rm\u0060|\u95F4\u63A5\u8C03\u7528|\n|\u0060ret\u0060||\n\n#### data-mov.c\n\n\u6570\u636E\u79FB\u52A8\u6307\u4EE4\u6267\u884C\u51FD\u6570\u5B9E\u73B0\u3002\n\n|\u6307\u4EE4|\u63CF\u8FF0|\n|-|-|\n|\u0060mov\u0060||\n|\u0060movsx\u0060||\n|\u0060movzx\u0060||\n|\u0060lea\u0060||\n|\u0060push\u0060||\n|\u0060pop\u0060||\n|\u0060pusha\u0060||\n|\u0060popa\u0060||\n|\u0060leave\u0060||\n|\u0060cltd\u0060||\n|\u0060cwtl\u0060||\n\n#### logic.c\n\n\u903B\u8F91\u8FD0\u7B97\u6307\u4EE4\u6267\u884C\u51FD\u6570\u5B9E\u73B0\u3002\n\n|\u6307\u4EE4|\u63CF\u8FF0|\n|-|-|\n|\u0060test\u0060||\n|\u0060and\u0060||\n|\u0060xor\u0060||\n|\u0060or\u0060||\n|\u0060sar\u0060||\n|\u0060shl\u0060||\n|\u0060shr\u0060||\n|\u0060setcc\u0060||\n|\u0060not\u0060||\n|\u0060rol\u0060||\n|\u0060ror\u0060||\n\n#### special.c\n\n\u7279\u6B8A\u6307\u4EE4\u6267\u884C\u51FD\u6570\u5B9E\u73B0\u3002\n\n\u5B9E\u73B0\u4E86 \u0060include/cpu/rtl.h\u0060 \u4E2D\u7684\u51FD\u6570 \u0060interpret_rtl_exit\u0060\u3002\n\n|\u6307\u4EE4|\u63CF\u8FF0|\n|-|-|\n|\u0060nop\u0060||\n|\u0060inv\u0060|\u975E\u6CD5\u6307\u4EE4|\n|\u0060nemu_trap\u0060|\u7ED3\u675F\u6267\u884C|\n\n#### prefix.c\n\n\u5B9A\u4E49\u4E86\u6267\u884C\u51FD\u6570 \u0060exec_real\u0060\u3002\n\u5B9A\u4E49\u5E76\u5B9E\u73B0\u4E86\u6267\u884C\u51FD\u6570 \u0060exec_operand_size\u0060\u3002\n\n- \u0060exec_operand_size\u0060 \u4EE5 16 \u4F4D\u64CD\u4F5C\u6570\u6267\u884C\u6307\u4EE4\uFF08\u6807\u8BB0 \u0060decoding.is_operand_size_16\u0060\uFF09\n\n#### system.c\n\n\u7CFB\u7EDF\u76F8\u5173\u6307\u4EE4\u5B9E\u73B0\u3002\n\n|\u6307\u4EE4|\u63CF\u8FF0|\n|-|-|\n|\u0060lidt\u0060|\u8BBE\u7F6E IDTR \u5BC4\u5B58\u5668|\n|\u0060mov_r2cr\u0060||\n|\u0060mov_cr2r\u0060||\n|\u0060int\u0060|\u6839\u636E\u4E2D\u65AD\u7801\u8FDB\u884C\u4E2D\u65AD\u8DF3\u8F6C|\n|\u0060iret\u0060|\u4ECE\u4E2D\u65AD\u8DF3\u8F6C\u8FD4\u56DE|\n|\u0060in\u0060|\u8BFB\u53D6\u7AEF\u53E3\u6620\u5C04 I/O|\n|\u0060out\u0060|\u5199\u5165\u7AEF\u53E3\u6620\u5C04 I/O|\n\n- x86 \u63D0\u4F9B\u4E86 in \u548C out \u6307\u4EE4\u7528\u4E8E\u8BBF\u95EE\u8BBE\u5907\uFF0C\u5176\u4E2D in \u6307\u4EE4\u7528\u4E8E\u5C06\u8BBE\u5907\u5BC4\u5B58\u5668\u4E2D\u7684\u6570\u636E\u4F20\u8F93\u5230 CPU \u5BC4\u5B58\u5668\u4E2D\uFF0Cout \u6307\u4EE4\u7528\u4E8E\u5C06 CPU \u5BC4\u5B58\u5668\u4E2D\u7684\u6570\u636E\u4F20\u9001\u5230\u8BBE\u5907\u5BC4\u5B58\u5668\u4E2D\n\n#### exec.c\n\n\u6307\u4EE4\u6267\u884C\u8FC7\u7A0B\u6838\u5FC3\u5B9E\u73B0\u3002\n\n##### \u7ED3\u6784\u4F53 opcode_entry\n\n\u8BD1\u7801\u67E5\u627E\u8868\u4E2D\u5143\u7D20\u3002\n\n|\u6210\u5458|\u63CF\u8FF0|\n|-|-|\n|\u0060DHelper decode\u0060|\u8BD1\u7801\u51FD\u6570\u6307\u9488|\n|\u0060EHelper execute\u0060|\u6267\u884C\u51FD\u6570\u6307\u9488|\n|\u0060width\u0060|\u6307\u4EE4\u5BBD\u5EA6|\n\n##### \u6570\u7EC4 opcode_table\n\n\u8BD1\u7801\u8868\u3002\u6309\u6307\u4EE4\u7B2C\u4E00\u4E2A\u5B57\u8282\u7D22\u5F15\u5B58\u653E\u3002\u5206\u4E24\u6BB5\uFF1A\u5355\u5B57\u8282\u6307\u4EE4\u7801\u548C\u53CC\u5B57\u8282\u6307\u4EE4\u7801\u3002\n\n\u0060\u0060\u0060c\nopcode_entry opcode_table [512] = {\n  /* 0x00 */\tEMPTY, EMPTY, EMPTY, EMPTY,\n  /* 0x04 */\tEMPTY, EMPTY, EMPTY, EMPTY,\n  /* 0x08 */\tEMPTY, EMPTY, EMPTY, EMPTY,\n  ...\n};\n\u0060\u0060\u0060\n\n|\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060IDEXW(id, ex, w)\u0060|\u6839\u636E\u8BD1\u7801\u51FD\u6570\u540D\uFF0C\u6267\u884C\u51FD\u6570\u540D\uFF0C\u5BBD\u5EA6\u751F\u6210 \u0060opcode_entry\u0060|\n|\u0060IDEX(id, ex)\u0060|\u6839\u636E\u8BD1\u7801\u51FD\u6570\u540D\uFF0C\u6267\u884C\u51FD\u6570\u540D\uFF0C\u4EE5\u5BBD\u5EA6 0 \u751F\u6210 \u0060opcode_entry\u0060|\n|\u0060EXW(ex, w)\u0060|\u6839\u636E\u6267\u884C\u51FD\u6570\u540D\uFF0C\u5BBD\u5EA6\uFF0C\u751F\u6210\u65E0\u8BD1\u7801\u51FD\u6570\u7684 \u0060opcode_entry\u0060|\n|\u0060EX(ex)\u0060|\u6839\u636E\u6267\u884C\u51FD\u6570\u540D\uFF0C\u751F\u6210\u5BBD\u5EA6\u4E3A 0 \u4E14\u65E0\u8BD1\u7801\u51FD\u6570\u7684 \u0060opcode_entry\u0060|\n|\u0060EMPTY\u0060|\u672A\u5B9E\u73B0\u7684\u547D\u4EE4\uFF0C\u4F7F\u7528 \u0060exec_inv\u0060\uFF08\u5B9A\u4E49\u5728 \u0060special.c\u0060 \u4E2D\uFF09 \u6784\u9020 \u0060opcode_entry\u0060|\n|\u0060make_group(name, item0, item1, item2, item3, item4, item5, item6, item7)\u0060|\u7528\u4E8E\u5B9E\u73B0 \u0060sub /5\u0060 \u8FD9\u79CD\u6839\u636E\u7B2C\u4E8C\u4E2A\u6307\u4EE4\u7801 \u0060/5\u0060 \u533A\u5206\u4E0D\u540C\u6307\u4EE4\u7684\u60C5\u51B5\u3002\u4F1A\u81EA\u52A8\u751F\u6210\u4E00\u4E2A \u0060exec_name\u0060 \u7684\u7EDF\u4E00\u6267\u884C\u51FD\u6570\uFF0C\u5E76\u6839\u636E \u0060decoding.ext_opcode\u0060 \u5206\u914D\u5230\u6307\u5B9A\u6267\u884C\u51FD\u6570\u3002|\n\n\u0060\u0060\u0060c\n#define IDEXW(id, ex, w)   {concat(decode_, id), concat(exec_, ex), w}\n#define IDEX(id, ex)       IDEXW(id, ex, 0)\n#define EXW(ex, w)         {NULL, concat(exec_, ex), w}\n#define EX(ex)             EXW(ex, 0)\n#define EMPTY              EX(inv)\n\n#define make_group(name, item0, item1, item2, item3, item4, item5, item6, item7) \\\n  static opcode_entry concat(opcode_table_, name) [8] = { \\\n    /* 0x00 */\titem0, item1, item2, item3, \\\n    /* 0x04 */\titem4, item5, item6, item7  \\\n  }; \\\nstatic make_EHelper(name) { \\\n  idex(eip, \u0026concat(opcode_table_, name)[decoding.ext_opcode]); \\\n}\n\u0060\u0060\u0060\n\n\u4F7F\u7528 \u0060make_group\u0060 \u5B8F\u5B9A\u4E49\u4E86\u4E00\u4E9B\u7EC4 \u0060gp1\u0060 - \u0060gp7\u0060\u3002\u5BF9\u5E94\u4E8E 80386 \u624B\u518C\u9644\u5F55\u4E2D\u7EC4\u7684\u5212\u5206\u3002\n\n##### \u51FD\u6570 exec_wrapper\n\n\u0060\u0060\u0060c\nvoid exec_wrapper(bool print_flag);\n\u0060\u0060\u0060\n\n\u6267\u884C\u4E0B\u4E00\u6761\u6307\u4EE4\u3002\n- \u9996\u5148\u5C06\u5F53\u524D\u7684 \u0060%eip\u0060 \u4FDD\u5B58\u5230\u5168\u5C40\u8BD1\u7801\u4FE1\u606F \u0060decoding\u0060 \u7684\u6210\u5458 \u0060seq_eip\u0060 \u4E2D\n- \u7136\u540E\u5C06\u5176\u5730\u5740\u88AB\u4F5C\u4E3A\u53C2\u6570\u9001\u8FDB \u0060exec_real()\u0060 \u51FD\u6570\u4E2D\n    - \u0060seq\u0060 \u4EE3\u8868\u987A\u5E8F\u7684\u610F\u601D, \u5F53\u4EE3\u7801\u4ECE \u0060exec_real()\u0060 \u8FD4\u56DE\u65F6\uFF0C\u0060decoding.seq_eip\u0060 \u5C06\u4F1A\u6307\u5411\u4E0B\u4E00\u6761\u6307\u4EE4\u7684\u5730\u5740.\n- \u8C03\u7528 \u0060update_eip\u0060 \u66F4\u65B0 \u0060%eip\u0060\n- \u8C03\u8BD5\u6A21\u5F0F\u4E0B\n    - \u8BB0\u5F55\u65E5\u5FD7\uFF08\u6307\u4EE4\u5185\u5BB9\u4EE5\u53CA\u76F8\u5173\u4FE1\u606F\uFF09\n    - \u82E5 \u0060print_flag\u0060 \u4E3A\u771F\uFF0C\u5219\u663E\u793A \u0060decoding.asm_buf\u0060\n\n##### \u51FD\u6570 exec_real\n\n- \u9996\u5148\u901A\u8FC7 \u0060instr_fetch()\u0060 \u51FD\u6570(\u5728 \u0060include/cpu/exec.h\u0060 \u4E2D\u5B9A\u4E49)\u8FDB\u884C\u53D6\u6307\uFF0C \u5F97\u5230\u6307\u4EE4\u7684\u7B2C\u4E00\u4E2A\u5B57\u8282, \u5C06\u5176\u89E3\u91CA\u6210 \u0060opcode\u0060 \u5E76\u8BB0\u5F55\u5728\u5168\u5C40\u8BD1\u7801\u4FE1\u606F \u0060decoding\u0060 \u4E2D.\n- \u6839\u636E \u0060opcode\u0060 \u67E5\u9605\u8BD1\u7801\u67E5\u627E\u8868\uFF0C\u5F97\u5230\u64CD\u4F5C\u6570\u7684\u5BBD\u5EA6\u4FE1\u606F\uFF0C\u5E76\u901A\u8FC7\u8C03\u7528 \u0060set_width()\u0060 \u51FD\u6570\u5C06\u5176\u8BB0\u5F55\u5728\u5168\u5C40\u8BD1\u7801\u4FE1\u606F \u0060decoding\u0060 \u4E2D\n- \u8C03\u7528 \u0060idex()\u0060 \u5BF9\u6307\u4EE4\u8FDB\u884C\u8FDB\u4E00\u6B65\u7684\u8BD1\u7801\u548C\u6267\u884C\n\n##### \u51FD\u6570 set_width\n\n\u0060\u0060\u0060c\nstatic inline void set_width(int width);\n\u0060\u0060\u0060\n\n\u6839\u636E\u6307\u4EE4\u5B9A\u4E49\u5BBD\u5EA6\uFF08\u0060opcode_entry.width\u0060\uFF09\u6307\u5B9A\u6240\u6709\u64CD\u4F5C\u6570\u5BBD\u5EA6\uFF08\u0060decoding.src.width\u0060\uFF09\u3002\n- \u5982\u679C\u5B9A\u4E49\u5BBD\u5EA6\u4E3A 0\uFF0C\u5219\u91C7\u7528\u8BD1\u7801\u7ED3\u679C\uFF08\u0060decoding.is_operand_size_16\u0060\uFF09\n\n##### \u51FD\u6570 idex\n\n\u0060\u0060\u0060c\n/* Instruction Decode and EXecute */\nstatic inline void idex(vaddr_t *eip, opcode_entry *e);\n\u0060\u0060\u0060\n\n\u8C03\u7528\u8BD1\u7801\u67E5\u627E\u8868\u4E2D\u7684\u76F8\u5E94\u7684\u8BD1\u7801\u51FD\u6570\uFF08\u82E5\u5B58\u5728\uFF09\u8FDB\u884C\u64CD\u4F5C\u6570\u7684\u8BD1\u7801\uFF0C\u8BD1\u7801\u8FC7\u7A0B\u7ED3\u675F\u4E4B\u540E, \u4F1A\u8C03\u7528\u8BD1\u7801\u67E5\u627E\u8868\u4E2D\u7684\u76F8\u5E94\u7684\u6267\u884C\u51FD\u6570\u6765\u8FDB\u884C\u771F\u6B63\u7684\u6267\u884C\u64CD\u4F5C\u3002\n\n##### \u51FD\u6570 update_eip\n\n\u6839\u636E\u5F53\u524D\u6307\u4EE4\u662F\u5426\u4E3A\u8DF3\u8F6C\u6307\u4EE4\uFF0C\u66F4\u65B0 \u0060%eip\u0060\u3002\n\n\u0060\u0060\u0060c\nstatic inline void update_eip(void) {\n    if (decoding.is_jmp) { decoding.is_jmp = 0; }\n    else { cpu.eip = decoding.seq_eip; }\n}\n\u0060\u0060\u0060\n\n## memory/\n\n### memory.c\n\n\u5B9A\u4E49\u4E86\u5B8F \u0060PMEM_SIZE\u0060 \u6307\u5B9A\u7269\u7406\u5185\u5B58\u5927\u5C0F\u3002\n\u5B9E\u73B0\u4E86 \u0060include/memory/memory.h\u0060 \u4E2D\u7684\u51FD\u6570 \u0060paddr_read\u0060\uFF0C\u0060paddr_write\u0060\uFF0C\u0060vaddr_read\u0060\uFF0C\u0060vaddr_write\u0060\u3002\n\n- \u0060vaddr_read, vaddr_write\u0060 \u7684\u5B9E\u73B0\u8C03\u7528\u4E86 \u0060paddr_read\u0060 \u548C \u0060paddr_write\u0060\u3002\n- \u4E3A\u652F\u6301\u5185\u5B58\u6620\u5C04 I/O\uFF0C\u0060paddr_read, paddr_write\u0060 \u7684\u5B9E\u73B0\u52A0\u5165\u4E86\u5BF9\u5185\u5B58\u6620\u5C04 I/O \u7684\u5224\u65AD\u3002\n\n## device/\n\n### io/\n\n#### mmio.c\n\n\u5B9A\u4E49\u4E86\u5B8F \u0060MMIO_SPACE_MAX\u0060 \u6307\u5B9A\u5185\u5B58\u6620\u5C04\u7A7A\u95F4\u5927\u5C0F\u3002\n\u5B9A\u4E49\u4E86\u7ED3\u6784\u4F53 \u0060MMIO_t\u0060 \u4FDD\u5B58 MMIO \u4FE1\u606F\u3002\n\n\u5B9E\u73B0\u4E86 \u0060include/device/mmio.h\u0060 \u4E2D\u7684\u51FD\u6570\u3002\n\n- \u5728 \u0060mmio_read\u0060 \u548C \u0060mmio_write\u0060 \u4E2D\uFF0C\u8C03\u7528\u4E86\u56DE\u8C03\u51FD\u6570\u3002\n\n#### port-io.c\n\n\u5B9A\u4E49\u4E86\u5B8F \u0060PORT_IO_SPACE_MAX\u0060 \u6307\u5B9A\u5185\u5B58\u6620\u5C04\u7A7A\u95F4\u5927\u5C0F\u3002\n\u5B9A\u4E49\u4E86\u7ED3\u6784\u4F53 \u0060PIO_t\u0060 \u4FDD\u5B58 MMIO \u4FE1\u606F\u3002\n\n\u5B9E\u73B0\u4E86 \u0060include/device/port-io.h\u0060 \u4E2D\u7684\u51FD\u6570\u3002\n\n- \u5728 \u0060pio_read_common\u0060 \u548C \u0060pio_write_common\u0060 \u4E2D\uFF0C\u8C03\u7528\u4E86\u56DE\u8C03\u51FD\u6570\u3002\n- \u57FA\u4E8E \u0060pio_read_common\u0060 \u548C \u0060pio_write_common\u0060 \u5B9E\u73B0\u4E86\u4E0D\u540C\u7684\u7AEF\u53E3\u8BFB\u5199\u51FD\u6570\n\n### device.c\n\n\u63D0\u4F9B\u521D\u59CB\u5316\u548C\u63A7\u5236\u8BBE\u5907\u7684\u4E00\u4E9B\u51FD\u6570\u3002\u542B\u6709\u548CSDL\u5E93\u76F8\u5173\u7684\u4EE3\u7801\uFF0CNEMU\u4F7F\u7528SDL\u5E93\u6765\u5B9E\u73B0\u8BBE\u5907\u7684\u6A21\u62DF\u3002\n\n|\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060TIMER_HZ\u0060|\u65F6\u949F\u9891\u7387|\n|\u0060VGA_HZ\u0060|VGA \u5237\u65B0\u9891\u7387|\n\n#### \u51FD\u6570 init_device\n\n\u7528\u4E8E\u521D\u59CB\u5316\u8BBE\u5907\uFF1A\u4E32\u53E3\uFF0C \u65F6\u949F\uFF0C \u952E\u76D8\uFF0C VGA\u56DB\u79CD\u8BBE\u5907\u3002\n\u5176\u4E2D\u5728\u521D\u59CB\u5316 VGA \u65F6\u8FD8\u4F1A\u8FDB\u884C\u4E00\u4E9B\u548CSDL\u76F8\u5173\u7684\u521D\u59CB\u5316\u5DE5\u4F5C\uFF0C \u5305\u62EC\u521B\u5EFA\u7A97\u53E3\uFF0C \u8BBE\u7F6E\u663E\u793A\u6A21\u5F0F\u7B49. \u6700\u540E\u8FD8\u4F1A\u6CE8\u518C\u4E00\u4E2A100Hz\u7684\u5B9A\u65F6\u5668\uFF0C \u6BCF\u96940.01\u79D2\u5C31\u4F1A\u8C03\u7528\u4E00\u6B21 \u0060device_update()\u0060 \u51FD\u6570\u3002\n\n#### \u51FD\u6570 device_update\n\n\u4E3B\u8981\u8FDB\u884C\u4E00\u4E9B\u8BBE\u5907\u7684\u6A21\u62DF\u64CD\u4F5C, \u5305\u62EC\u4EE550Hz\u7684\u9891\u7387\u5237\u65B0\u5C4F\u5E55, \u4EE5\u53CA\u68C0\u6D4B\u662F\u5426\u6709\u6309\u952E\u6309\u4E0B/\u91CA\u653E. \n\n{% note warning %}\n\u9700\u8981\u8BF4\u660E\u7684\u662F\uFF0C \u4EE3\u7801\u4E2D\u6CE8\u518C\u7684\u5B9A\u65F6\u5668\u662F\u865A\u62DF\u5B9A\u65F6\u5668\uFF0C \u5B83\u53EA\u4F1A\u5728 NEMU \u5904\u4E8E\u7528\u6237\u6001\u7684\u65F6\u5019\u8FDB\u884C\u8BA1\u65F6\uFF1A \u5982\u679C NEMU \u5728 \u0060ui_mainloop()\u0060 \u4E2D\u7B49\u5F85\u7528\u6237\u8F93\u5165\uFF0C \u5B9A\u65F6\u5668\u5C06\u4E0D\u4F1A\u8BA1\u65F6; \u5982\u679C NEMU \u8FDB\u884C\u5927\u91CF\u7684\u8F93\u51FA\uFF0C \u5B9A\u65F6\u5668\u7684\u8BA1\u65F6\u5C06\u4F1A\u53D8\u5F97\u7F13\u6162. \u56E0\u6B64\u9664\u975E\u4F60\u5728\u8FDB\u884C\u8C03\u8BD5\uFF0C \u5426\u5219\u5C3D\u91CF\u907F\u514D\u5927\u91CF\u8F93\u51FA\u7684\u60C5\u51B5\uFF0C \u4ECE\u800C\u5F71\u54CD\u5B9A\u65F6\u5668\u7684\u5DE5\u4F5C\u3002\n{% endnote %}\n\n### serial.c\n\n\u4E32\u53E3\u8BBE\u5907\u3002\n\u6A21\u62DF\u4E86\u4E32\u53E3\u7684\u529F\u80FD\u3002 \u5176\u5927\u90E8\u5206\u529F\u80FD\u4E5F\u88AB\u7B80\u5316\uFF0C\u53EA\u4FDD\u7559\u4E86\u6570\u636E\u5BC4\u5B58\u5668\u548C\u72B6\u6001\u5BC4\u5B58\u5668\u3002\u4E32\u53E3\u521D\u59CB\u5316\u65F6\u4F1A\u5206\u522B\u6CE8\u518C \u00600x3F8\u0060 \u548C \u00600x3FC\u0060 \u5904\u957F\u5EA6\u4E3A1\u4E2A\u5B57\u8282\u7684\u7AEF\u53E3\uFF0C\u5206\u522B\u4F5C\u4E3A\u6570\u636E\u5BC4\u5B58\u5668\u548C\u72B6\u6001\u5BC4\u5B58\u5668\u3002\u7531\u4E8ENEMU\u4E32\u884C\u6A21\u62DF\u8BA1\u7B97\u673A\u7CFB\u7EDF\u7684\u5DE5\u4F5C\uFF0C\u4E32\u53E3\u7684\u72B6\u6001\u5BC4\u5B58\u5668\u53EF\u4EE5\u4E00\u76F4\u5904\u4E8E\u7A7A\u95F2\u72B6\u6001; \u6BCF\u5F53CPU\u5F80\u6570\u636E\u5BC4\u5B58\u5668\u4E2D\u5199\u5165\u6570\u636E\u65F6\uFF0C\u4E32\u53E3\u4F1A\u5C06\u6570\u636E\u4F20\u9001\u5230\u4E3B\u673A\u7684\u6807\u51C6\u8F93\u51FA\u3002\n\n|\u51FD\u6570/\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060init_serial()\u0060|\u521D\u59CB\u5316\u8BBE\u5907|\n|\u0060SERIAL_PORT=0x3F8\u0060|\u7AEF\u53E3 I/O \u5730\u5740|\n\n### timer.c\n\n\u65F6\u949F\u8BBE\u5907\u3002\n\u6A21\u62DF\u4E86i8253\u8BA1\u65F6\u5668\u7684\u529F\u80FD. \u8BA1\u65F6\u5668\u7684\u5927\u90E8\u5206\u529F\u80FD\u90FD\u88AB\u7B80\u5316, \u53EA\u4FDD\u7559\u4E86\u0022\u53D1\u8D77\u65F6\u949F\u4E2D\u65AD\u0022\u7684\u529F\u80FD. \u540C\u65F6\u6DFB\u52A0\u4E86\u4E00\u4E2A\u81EA\u5B9A\u4E49\u7684RTC(Real Time Clock), \u521D\u59CB\u5316\u65F6\u5C06\u4F1A\u6CE8\u518C0x48\u5904\u7684\u7AEF\u53E3\u4F5C\u4E3ARTC\u5BC4\u5B58\u5668, CPU\u53EF\u4EE5\u901A\u8FC7I/O\u6307\u4EE4\u8BBF\u95EE\u8FD9\u4E00\u5BC4\u5B58\u5668, \u83B7\u5F97\u5F53\u524D\u65F6\u95F4(\u5355\u4F4D\u662Fms).\n\n|\u51FD\u6570/\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060init_timer()\u0060|\u521D\u59CB\u5316\u8BBE\u5907|\n|\u0060RTC_PORT=0x48\u0060|\u7AEF\u53E3 I/O \u5730\u5740|\n\n### keyboard.c\n\n\u952E\u76D8\u8BBE\u5907\u3002\n\u6A21\u62DF\u4E86i8042\u901A\u7528\u8BBE\u5907\u63A5\u53E3\u82AF\u7247\u7684\u529F\u80FD. \u5176\u5927\u90E8\u5206\u529F\u80FD\u4E5F\u88AB\u7B80\u5316, \u53EA\u4FDD\u7559\u4E86\u952E\u76D8\u63A5\u53E3. i8042\u521D\u59CB\u5316\u65F6\u4F1A\u6CE8\u518C \u00600x60\u0060 \u5904\u7684\u7AEF\u53E3\uFF08\u957F\u5EA6\u4E3A 4\uFF09\u4F5C\u4E3A\u6570\u636E\u5BC4\u5B58\u5668. \u6BCF\u5F53\u7528\u6237\u6572\u4E0B/\u91CA\u653E\u6309\u952E\u65F6, \u5C06\u4F1A\u628A\u76F8\u5E94\u7684\u952E\u76D8\u7801\u653E\u5165\u6570\u636E\u5BC4\u5B58\u5668, CPU\u53EF\u4EE5\u901A\u8FC7\u7AEF\u53E3I/O\u8BBF\u95EE\u6570\u636E\u5BC4\u5B58\u5668, \u83B7\u5F97\u952E\u76D8\u7801; \u5F53\u65E0\u6309\u952E\u53EF\u83B7\u53D6\u65F6, \u5C06\u4F1A\u8FD4\u56DE \u0060_KEY_NONE\u0060 . \u5728AM\u4E2D, \u6211\u4EEC\u7EA6\u5B9A\u901A\u7801\u7684\u503C\u4E3A \u0060\u65AD\u7801 | KEYDOWN_MASK\u0060.\n\n|\u51FD\u6570/\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060init_i8042()\u0060|\u521D\u59CB\u5316\u8BBE\u5907|\n|\u0060I8042_DATA_PORT=0x60\u0060|\u7AEF\u53E3 I/O \u5730\u5740|\n|\u0060KEYDOWN_MASK=0x8000\u0060|\u901A\u7801 MASK|\n|\u0060KEY_QUEUE_LEN\u0060|\u952E\u961F\u5217\u957F\u5EA6|\n\n### vga.c\n\nVGA \u8BBE\u5907\u3002\n\u6A21\u62DF\u4E86VGA\u7684\u529F\u80FD. VGA\u521D\u59CB\u5316\u65F6\u6CE8\u518C\u4E86\u4ECE \u00600x40000\u0060 \u5F00\u59CB\u7684\u4E00\u6BB5\u7528\u4E8E\u6620\u5C04\u5230video memory\u7684\u7269\u7406\u5185\u5B58. \u5728NEMU\u4E2D, video memory\u662F\u552F\u4E00\u4F7F\u7528\u5185\u5B58\u6620\u5C04I/O\u65B9\u5F0F\u8BBF\u95EE\u7684I/O\u7A7A\u95F4. \u4EE3\u7801\u53EA\u6A21\u62DF\u4E86400x300x32\u7684\u56FE\u5F62\u6A21\u5F0F, \u4E00\u4E2A\u50CF\u7D20\u536032\u4E2Abit\u7684\u5B58\u50A8\u7A7A\u95F4, R(red), G(green), B(blue), A(alpha)\u5404\u53608 bit, \u5176\u4E2DVGA\u4E0D\u4F7F\u7528alpha\u7684\u4FE1\u606F\u3002VGA \u8BBE\u5907\u540C\u65F6\u6CE8\u518C\u4E86\u4F4D\u4E8E \u00600x100\u0060 \u7684\u957F\u5EA6\u4E3A 4 \u7684\u7AEF\u53E3\u5B58\u50A8\u5C4F\u5E55\u5927\u5C0F\u4FE1\u606F\u3002\n\n|\u51FD\u6570/\u5B8F|\u63CF\u8FF0|\n|-|-|\n|\u0060init_vga()\u0060|\u521D\u59CB\u5316\u8BBE\u5907|\n|\u0060SCREEN_PORT=0x100\u0060|\u7AEF\u53E3 I/O \u5730\u5740|\n|\u0060VMEM=0x40000\u0060|\u5185\u5B58\u6620\u5C04 I/O \u5730\u5740|\n|\u0060SCREEN_H\u0060|\u5C4F\u5E55\u9AD8\u5EA6|\n|\u0060SCREEN_W\u0060|\u5C4F\u5E55\u5BBD\u5EA6|\n\n## monitor/\n\n\u76D1\u89C6\u5668\u90E8\u5206\u5B9E\u73B0\uFF08\u4E5F\u5305\u542B NEMU \u6267\u884C\u4E3B\u5FAA\u73AF\uFF09\u3002\n\n### monitor.c\n\n#### \u51FD\u6570 init_monitor\n\n\u521D\u59CB\u5316\u76D1\u89C6\u5668\u5E76\u542F\u52A8\uFF08\u7528\u4E8E \u0060main.c/main\u0060 \u4E2D\uFF09\u3002\n- \u89E3\u6790\u5E76\u5904\u7406\u547D\u4EE4\u884C\u53C2\u6570\n- \u521D\u59CB\u5316\u65E5\u5FD7\u6587\u4EF6\n- \u5BC4\u5B58\u5668\u6D4B\u8BD5\uFF08\u8C03\u7528 \u0060reg_test()\u0060\uFF0C\u5B9E\u73B0\u5728 \u0060src/cpu/reg.c\u0060\uFF09\n- \u52A0\u8F7D\u7A0B\u5E8F\u955C\u50CF\uFF08\u6839\u636E\u547D\u4EE4\u884C\u53C2\u6570\uFF0C\u5982\u679C\u4E3A\u7A7A\uFF0C\u5219\u8C03\u7528 \u0060load_default_img()\u0060 \u52A0\u8F7D\u9ED8\u8BA4\u955C\u50CF\uFF09\n- \u542F\u52A8\u73AF\u5883\uFF08\u8C03\u7528 \u0060restart()\u0060\uFF0C\u521D\u59CB\u5316\u5E94\u7528\u7A0B\u5E8F\u5165\u53E3\u70B9\uFF0C\u5BC4\u5B58\u5668\u503C\uFF09\n- \u7F16\u8BD1\u6B63\u5219\u8868\u8FBE\u5F0F\uFF08\u8C03\u7528 \u0060init_regex()\u0060\uFF0C\u5B9E\u73B0\u5728 \u0060src/monitor/debug/expr.c\u0060\uFF09\n- \u521D\u59CB\u5316\u76D1\u89C6\u70B9\u6C60\uFF08\u8C03\u7528 \u0060init_wp_pool()\u0060\uFF0C\u5B9E\u73B0\u5728 \u0060src/monitor/debug/watchpoint.c\u0060\uFF09\n- \u521D\u59CB\u5316\u8BBE\u5907\uFF08\u8C03\u7528 \u0060init_device()\u0060\uFF0C\u5B9E\u73B0\u5728 \u0060src/device/device.c\u0060\uFF09\n- \u521D\u59CB\u5316\u5DEE\u5F02\u6D4B\u8BD5\uFF08\u8C03\u7528 \u0060init_difftest()\u0060\uFF0C\u5B9E\u73B0\u5728 \u0060src/monitor/diff-test.c\u0060\uFF09\n- \u663E\u793A\u6B22\u8FCE\u754C\u9762\n- \u8FD4\u56DE\u662F\u5426\u4E3A\u6279\u5904\u7406\u6A21\u5F0F\uFF08\u6839\u636E\u547D\u4EE4\u884C\u53C2\u6570\uFF09\n\n\u6CE8\uFF1A\n- \u547D\u4EE4\u884C\u53C2\u6570\n    - \u0060[img_file]\u0060 \u6307\u5B9A\u5E94\u7528\u7A0B\u5E8F\u955C\u50CF\u6587\u4EF6\n    - \u0060-b\u0060 \u6279\u5904\u7406\u6A21\u5F0F\n    - \u0060-l log_file\u0060 \u6307\u5B9A\u65E5\u5FD7\u6587\u4EF6\n    - \u0060-d\u0060 \u6307\u5B9A Diff-Test \u955C\u50CF\u6587\u4EF6\n\n### cpu-exec.c\n\n#### \u51FD\u6570 cpu_exec\n\n\u0060\u0060\u0060c\nvoid cpu_exec(uint64_t n);\n\u0060\u0060\u0060\n\n\u6A21\u62DF CPU \u5DE5\u4F5C\u3002\n\n- \u5224\u65AD NEMU \u72B6\u6001\uFF08\u67E5\u770B \u0060nemu_state\u0060\uFF0C\u5B9A\u4E49\u5728 \u0060include/monitor/monitor.h\u0060\uFF09\n- \u82E5\u6307\u4EE4\u6570 \u0060n\u0060 \u5C0F\u4E8E \u0060MAX_INSTR_TO_PRINT\u0060 \uFF08\u9ED8\u8BA4\u4E3A 10\uFF09\uFF0C\u5219\u6253\u5370\u6BCF\u6761\u6307\u4EE4\u3002\n- \u5F00\u59CB\u6267\u884C\u6307\u4EE4\n    - \u8C03\u7528 \u0060exec_wrapper\u0060 \u6267\u884C\u4E0B\u4E00\u6761\u6307\u4EE4\uFF08\u4F20\u5165\u662F\u5426\u6253\u5370\u6307\u4EE4\u6807\u8BB0\uFF09\n    - \u68C0\u67E5\u76D1\u89C6\u70B9\u72B6\u6001\u662F\u5426\u6709\u66F4\u65B0\n    - \u66F4\u65B0\u8BBE\u5907\u4FE1\u606F\n    - \u5224\u65AD NEMU \u72B6\u6001\uFF08\u67E5\u770B \u0060nemu_state\u0060\uFF09\uFF0C\u51B3\u5B9A\u662F\u5426\u9000\u51FA\n- \u6267\u884C\u5B8C \u0060n\u0060 \u6761\u6307\u4EE4\u540E\uFF0C\u5C06 NEMU \u72B6\u6001\u7F6E\u4E3A\u7ED3\u675F\uFF08\u0060NEMU_END\u0060\uFF09\n\n\u6CE8\uFF1A\n- \u6267\u884C\u67D0\u6761\u547D\u4EE4\u540E\n    - \u82E5 NEMU \u72B6\u6001\u4E3A\u7ED3\u675F\uFF08\u0060NEMU_END\u0060\uFF09\uFF0C\u5219\u68C0\u67E5\u7A0B\u5E8F\u8FD4\u56DE\u503C\uFF08\u0060cpu.eax\u0060\uFF09\u662F\u5426\u4E3A 0\uFF08\u662F\u5426\u6B63\u5E38\u9000\u51FA\uFF09\u3002\u5E76\u8F93\u51FA \u0060HIT GOOD TRAP\u0060\uFF08\u6B63\u5E38\u9000\u51FA\uFF09 \u6216 \u0060HIT BAD TRAP\u0060\uFF08\u975E\u6B63\u5E38\u9000\u51FA\uFF09\u3002\n\n### debug/\n\n#### watchpoint.c\n\n\u5B9A\u4E49\u4E86\u76D1\u89C6\u70B9\u5185\u5B58\u6C60\u53CA\u5176\u76F8\u5173\u7684\u51FD\u6570\u3002\n\n- \u0060wp_pool\u0060 \u76D1\u89C6\u70B9\u6C60\n- \u0060head\u0060 \u4F7F\u7528\u4E2D\u7684\u76D1\u89C6\u70B9\u94FE\u8868\u5934\u6307\u9488\n- \u0060free_\u0060 \u76D1\u89C6\u70B9\u6C60\u4E2D\u672A\u4F7F\u7528\u7684\u76D1\u89C6\u70B9\u94FE\u8868\u5934\u6307\u9488\n\n|\u51FD\u6570|\u63CF\u8FF0|\n|-|-|\n|\u0060init_wp_pool()\u0060|\u521D\u59CB\u5316\u76D1\u89C6\u70B9\u5185\u5B58\u6C60|\n|\u0060clearWP(wp)\u0060|\u6E05\u7A7A\u67D0\u76D1\u89C6\u70B9\u7684\u4E0B\u4E00\u9879\u6307\u9488|\n|\u0060WP *getHeadWP()\u0060|\u83B7\u53D6 \u0060head\u0060|\n|\u0060WP *createWP()\u0060|\u7533\u8BF7\u4F7F\u7528\u4E00\u4E2A\u65B0\u76D1\u89C6\u70B9\uFF08\u5185\u90E8\u8C03\u7528 \u0060new_wp()\u0060 \u5E76\u66F4\u65B0\u94FE\u8868\u4FE1\u606F\uFF09|\n|\u0060removeWP(no)\u0060|\u5220\u9664\u6307\u5B9A\u7F16\u53F7\u7684\u76D1\u89C6\u70B9|\n|\u0060WP *new_wp()\u0060|\uFF08\u79C1\u6709\uFF09\u4ECE\u5185\u5B58\u6C60\u4E2D\u83B7\u53D6\u4E0B\u4E00\u4E2A\u80FD\u4F7F\u7528\u7684\u76D1\u89C6\u70B9\uFF0C\u5E76\u4F5C\u4E00\u5B9A\u9884\u5904\u7406|\n|\u0060free_wp(wp)\u0060|\uFF08\u79C1\u6709\uFF09\u91CA\u653E\u4E00\u4E2A\u76D1\u89C6\u70B9|\n\n#### expr.c\n\n\u5B9E\u73B0\u4E86 \u0060expr.h/expr\u0060 \u51FD\u6570\uFF0C\u5B9E\u73B0\u8868\u8FBE\u5F0F\u89E3\u6790\u548C\u6C42\u503C\u3002\n\n##### \u5E38\u91CF\n\n- \u0060PRI_NEG\u0060 \u53D6\u8D1F\u8FD0\u7B97\u4F18\u5148\u7EA7\n- \u0060PRI_POINT\u0060 \u89E3\u5F15\u7528\u8FD0\u7B97\u4F18\u5148\u7EA7\n- \u5F62\u5982 \u0060TK_TYPE\u0060 \u7684 Token \u7C7B\u578B\u679A\u4E3E\n\n##### \u6570\u7EC4 rules\n\n\u89C4\u5B9A\u4E86\u4F7F\u7528\u6B63\u5219\u8868\u8FBE\u5F0F\u89E3\u6790 Token \u7684\u89C4\u5219\u3002\n\n|\u6210\u5458|\u63CF\u8FF0|\n|-|-|\n|\u0060regex\u0060|\u6B63\u5219\u8868\u8FBE\u5F0F\u5B57\u7B26\u4E32|\n|\u0060token_type\u0060|\u5BF9\u5E94 Token \u7C7B\u578B\uFF0C\u53EF\u7528 \u0060TK_TYPE\u0060 \u679A\u4E3E\u6216\u5B57\u7B26\uFF08\u5982 \u0060\u002B\u0060\uFF09\u8868\u793A|\n|\u0060opPri\u0060|\u8FD0\u7B97\u7B26 Token \u7684\u4F18\u5148\u7EA7|\n\n##### \u6570\u7EC4 re\n\n\u6839\u636E \u0060rules\u0060 \u7F16\u8BD1\u540E\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u3002\n\n##### \u51FD\u6570 \u0060init_regex\u0060\n\n\u6839\u636E \u0060rules\u0060 \u7F16\u8BD1\u5230 \u0060re\u0060\n\n##### \u7ED3\u6784\u4F53 Token\n\n\u8BC6\u522B\u540E\u7684 Token.\n\n|\u6210\u5458|\u63CF\u8FF0|\n|-|-|\n|\u0060type\u0060|Token \u7C7B\u578B\uFF0C\u53EF\u7528 \u0060TK_TYPE\u0060 \u679A\u4E3E\u6216\u5B57\u7B26\uFF08\u5982 \u0060\u002B\u0060\uFF09\u8868\u793A|\n|\u0060isOp\u0060|\u6807\u8BB0\u6B64 Token \u662F\u5426\u662F\u8FD0\u7B97\u7B26|\n|\u0060isValue\u0060|\u6807\u8BB0\u6B64 Token \u662F\u5426\u662F\u503C|\n|\u0060str\u0060|Token \u7684\u539F\u59CB\u5B57\u7B26\u4E32|\n|\u0060data\u0060|\u503C\u7C7B\u578B\u7684\u5B9E\u9645\u6570\u636E|\n|\u0060priority\u0060|\u8FD0\u7B97\u7B26\u7684\u4F18\u5148\u7EA7|\n\n- \u0060isOp\u0060 \u548C \u0060isValue\u0060 \u591A\u7528\u4E8E\u533A\u5206\u7279\u6B8A\u5355\u76EE\u8FD0\u7B97\u7B26\uFF0C\u5982\u89E3\u5F15\u7528\u548C\u53D6\u8D1F\n- \u0060data\u0060 \u591A\u5B58\u50A8\u7ECF\u8FC7\u9884\u5904\u7406\u7684\u6570\u636E\uFF0C\u5982\u8F6C\u6362\u540E\u7684\u6574\u6570\n\n{% note info %}\n\u89E3\u6790\u540E\u7684 Token \u5217\u8868\u5B58\u50A8\u5728\u6570\u7EC4 \u0060tokens\u0060 \u4E2D\u3002\n\u0060nr_token\u0060 \u6307\u793A \u0060token\u0060 \u6709\u6548\u957F\u5EA6\u3002\n{% endnote %}\n\n##### \u51FD\u6570 make_token\n\n\u0060\u0060\u0060c\nstatic bool make_token(char *e)\n\u0060\u0060\u0060\n\n\u6839\u636E\u5B57\u7B26\u4E32\u89E3\u6790 Token \u5217\u8868\uFF0C\u8FD4\u56DE\u662F\u5426\u89E3\u6790\u6210\u529F\u3002\n\n\u5B9E\u73B0\u601D\u8DEF\uFF1A\u4F7F\u7528 \u0060re\u0060 \u4F9D\u6B21\u5C1D\u8BD5\u6BCF\u4E00\u79CD\u5339\u914D\uFF0C\u76F4\u5230\u9047\u5230\u7B2C\u4E00\u4E2A\u6210\u529F\u5339\u914D\uFF0C\u6839\u636E\u5176\u89C4\u5219\u7684 \u0060token_type\u0060 \u751F\u6210 Token\uFF0C\u5B58\u5165 \u0060token\u0060\u3002\n\n- \u51FD\u6570 \u0060toInteger\u0060 \uFF1A\u4EE5\u6307\u5B9A\u8FDB\u5236\u5B8C\u6210\u5B57\u7B26\u4E32\u5230\u6570\u7684\u8F6C\u6362\uFF0C\u7528\u4E8E \u5341\u8FDB\u5236\uFF0C\u4E8C\u8FDB\u5236\uFF0C\u516B\u8FDB\u5236\uFF0C\u5341\u516D\u8FDB\u5236 \u6570\u7684\u89E3\u6790\u3002\n\n\u0060\u0060\u0060c\nstatic uint32_t toInteger(char *s, uint32_t base)\n\u0060\u0060\u0060\n\n##### \u51FD\u6570 evalWithToken\n\n\u0060\u0060\u0060c\nuint32_t evalWithToken(int l, int r, bool * success)\n\u0060\u0060\u0060\n\n\u6C42\u89E3 \u0060tokens[l..r]\u0060 \u4E2D\u7684\u8868\u8FBE\u5F0F\u7684\u503C\u3002 \n\n\u5B9E\u73B0\u601D\u8DEF\uFF1A\u5355 Token \u7279\u6B8A\u5904\u7406\uFF0C\u7136\u540E\u5904\u7406\u5916\u56F4\u62EC\u53F7\u60C5\u51B5\uFF0C\u7136\u540E\u786E\u5B9A\u6700\u540E\u8BA1\u7B97\u7684\u8FD0\u7B97\u7B26\uFF0C\u5206\u5272\u6210 \u0060left\u0060 \u548C \u0060right\u0060 \u4E24\u90E8\u5206\uFF0C\u7136\u540E\u9012\u5F52\u89E3\u51B3\uFF0C\u6700\u540E\u5408\u5E76\uFF0C\n\n- \u51FD\u6570 \u0060checkExtraP\u0060 \u5224\u65AD \u0060tokens[l..r]\u0060 \u662F\u5426\u5916\u56F4\u4E3A\u62EC\u53F7\u4E14\u62EC\u53F7\u5339\u914D\u6B63\u5E38\u3002\n- \u51FD\u6570 \u0060getReg\u0060 \u6839\u636E\u5BC4\u5B58\u5668\u540D\u83B7\u53D6\u5BC4\u5B58\u5668\u503C\uFF0C\u4F7F\u7528\u4E86 \u0060regMap\u0060\n- \u6570\u7EC4 \u0060regMap\u0060 \u6807\u8BC6\u5BC4\u5B58\u5668\u540D\u4E0E\u5BF9\u5E94\u7684\u504F\u79FB\u91CF\uFF08\u0060cpu.gpr\u0060\uFF09\n\n##### \u51FD\u6570 expr\n\n\u5BF9 \u0060expr.h/expr\u0060 \u7684\u5B9E\u73B0\uFF0C\u8C03\u7528\u4E86 \u0060make_token\u0060 \u548C \u0060evalWithToken\u0060\u3002\n\n{% note warning %}\n\u5F85\u66F4\u65B0\n{% endnote %}\n\n#### ui.c\n\n\u76D1\u89C6\u5668 CUI \u90E8\u5206\u3002\n\n##### \u51FD\u6570\u65CF fc2color\n\n\u63A7\u5236\u53F0\u5B57\u4F53\u989C\u8272\u63A7\u5236\u3002\n\n|\u51FD\u6570|\u63CF\u8FF0|\n|-|-|\n|\u0060fc2red\u0060|\u524D\u666F\u8272\u8BBE\u4E3A\u7EA2\u8272|\n|\u0060fc2green\u0060|\u524D\u666F\u8272\u8BBE\u4E3A\u7EFF\u8272|\n|\u0060fc2yellow\u0060|\u524D\u666F\u8272\u8BBE\u4E3A\u9EC4\u8272|\n|\u0060fc2blue\u0060|\u524D\u666F\u8272\u8BBE\u4E3A\u84DD\u8272|\n|\u0060fc2purple\u0060|\u524D\u666F\u8272\u8BBE\u4E3A\u7D2B\u8272|\n|\u0060csClear\u0060|\u6E05\u9664\u6240\u6709\u63A7\u5236\u53F0\u8BBE\u7F6E|\n\n##### \u51FD\u6570\u65CF cmd_item\n\n\u4E0D\u540C\u547D\u4EE4\u7684\u5B9E\u73B0\u3002\n\n|\u51FD\u6570|\u63CF\u8FF0|\n|-|-|\n|\u0060cmd_help\u0060|\u83B7\u53D6\u5E2E\u52A9|\n|\u0060cmd_q\u0060|\u9000\u51FA|\n|\u0060cmd_c\u0060|\u7EE7\u7EED\u6267\u884C\uFF08\u8C03\u7528 \u0060cpu_exec(-1)\u0060\uFF0C\u5B9E\u73B0\u5728 \u0060src/monitor/cpu-exec.c\u0060\uFF09|\n|\u0060cmd_si\u0060|\u6267\u884C\u5355\u6B65\u6307\u4EE4|\n|\u0060cmd_info name\u0060|\u67E5\u770B\u4FE1\u606F|\n|\u0060cmd_x N expr\u0060|\u663E\u793A\u5730\u5740\u4ECE \u0060expr\u0060 \u7684\u503C\u5F00\u59CB\u7684 \u0060N\u0060 \u4E2A\u5B57\u8282\u503C|\n|\u0060cmd_p expr\u0060|\u8BA1\u7B97\u8868\u8FBE\u5F0F\u7684\u503C|\n|\u0060cmd_w expr\u0060|\u65B0\u5EFA\u76D1\u89C6\u70B9\uFF0C\u76D1\u89C6\u8868\u8FBE\u5F0F\u4E3A \u0060expr\u0060|\n|\u0060cmd_d no\u0060|\u5220\u9664\u6307\u5B9A\u7F16\u53F7\u7684\u76D1\u89C6\u70B9|\n\n- \u0060cmd_info\u0060\n  - \u0060r\u0060 \u6253\u5370\u6240\u6709\u5BC4\u5B58\u5668\u4FE1\u606F\n  - \u0060w\u0060 \u6253\u5370\u6240\u6709\u76D1\u89C6\u70B9\u4FE1\u606F\n\n##### \u6570\u7EC4 cmd_table\n\n|\u6210\u5458|\u63CF\u8FF0|\n|-|-|\n|\u0060name\u0060|\u547D\u4EE4\u540D\uFF08\u7528\u4E8E\u8BC6\u522B\u547D\u4EE4\uFF09|\n|\u0060description\u0060|\u547D\u4EE4\u63CF\u8FF0\uFF08\u7528\u4E8E\u5E2E\u52A9\u5217\u8868\uFF09|\n|\u0060handler\u0060|\u547D\u4EE4\u5B9E\u73B0\u51FD\u6570\u6307\u9488|\n\n##### \u51FD\u6570 ui_mainloop\n\n\u0060\u0060\u0060c\nvoid ui_mainloop(int is_batch_mode);\n\u0060\u0060\u0060\n\nNEMU \u4EE5\u53CA\u5176 CUI \u4E3B\u5FAA\u73AF\uFF0C\u4E0D\u65AD\u8BFB\u53D6\u547D\u4EE4\uFF0C\u5E76\u6267\u884C\u3002\n- \u5982\u679C\u662F\u6279\u5904\u7406\u6A21\u5F0F\uFF08\u0060is_batch_mode\u0060 \u4E3A\u771F\uFF09\uFF0C\u5219\u76F4\u63A5\u6267\u884C\u5E94\u7528\u7A0B\u5E8F\uFF0C\u4E0D\u76D1\u542C\u7528\u6237\u547D\u4EE4\u3002\n\n### diff-test/\n\n\u5DEE\u5F02\u6D4B\u8BD5\u5B9E\u73B0\u3002\n\n\u003E \u5982\u679C\u6709\u4E00\u79CD\u65B9\u6CD5\u80FD\u591F\u8868\u8FBE\u6307\u4EE4\u7684\u6B63\u786E\u884C\u4E3A, \u6211\u4EEC\u5C31\u53EF\u4EE5\u57FA\u4E8E\u8FD9\u79CD\u65B9\u6CD5\u6765\u8FDB\u884C\u7C7B\u4F3Cassert()\u7684\u68C0\u67E5\u4E86\u3002\u90A3\u4E48, \u7A76\u7ADF\u4EC0\u4E48\u5730\u65B9\u8868\u8FBE\u4E86\u6307\u4EE4\u7684\u6B63\u786E\u884C\u4E3A\u5462? \u6700\u76F4\u63A5\u7684, \u5F53\u7136\u5C31\u662Fi386\u624B\u518C\u4E86, \u4F46\u662F\u6211\u4EEC\u6070\u6070\u5C31\u662F\u6839\u636Ei386\u624B\u518C\u4E2D\u7684\u6307\u4EE4\u884C\u4E3A\u6765\u5728NEMU\u4E2D\u5B9E\u73B0\u6307\u4EE4\u7684, \u540C\u4E00\u5957\u65B9\u6CD5\u4E0D\u80FD\u65E2\u7528\u4E8E\u5B9E\u73B0\u4E5F\u7528\u4E8E\u68C0\u67E5. \u5982\u679C\u6709\u4E00\u4E2Ai386\u624B\u518C\u7684\u53C2\u8003\u5B9E\u73B0\u5C31\u597D\u4E86. \u563F! \u6211\u4EEC\u7528\u7684\u771F\u673A\u4E0D\u5C31\u662F\u6839\u636Ei386\u624B\u518C\u5B9E\u73B0\u51FA\u6765\u7684\u5417? \u6211\u4EEC\u8BA9\u5728NEMU\u4E2D\u6267\u884C\u7684\u6BCF\u6761\u6307\u4EE4\u4E5F\u5728\u771F\u673A\u4E2D\u6267\u884C\u4E00\u6B21, \u7136\u540E\u5BF9\u6BD4NEMU\u548C\u771F\u673A\u7684\u72B6\u6001, \u5982\u679CNEMU\u548C\u771F\u673A\u7684\u72B6\u6001\u4E0D\u4E00\u81F4, \u6211\u4EEC\u5C31\u6355\u6349\u5230error\u4E86!\n\u003E \u8FD9\u5B9E\u9645\u4E0A\u662F\u4E00\u79CD\u975E\u5E38\u594F\u6548\u7684\u6D4B\u8BD5\u65B9\u6CD5, \u5728\u8F6F\u4EF6\u6D4B\u8BD5\u9886\u57DF\u79F0\u4E3Adifferential testing(\u540E\u7EED\u7B80\u79F0DiffTest). \u6211\u4EEC\u521A\u624D\u63D0\u5230\u4E86\u0022\u72B6\u6001\u0022, \u90A3\u0022\u72B6\u6001\u0022\u5177\u4F53\u6307\u7684\u662F\u4EC0\u4E48\u5462? \u6211\u4EEC\u5728PA1\u4E2D\u5DF2\u7ECF\u8BA4\u8BC6\u5230, \u8BA1\u7B97\u673A\u5C31\u662F\u4E00\u4E2A\u6570\u5B57\u7535\u8DEF. \u90A3\u4E48, \u0022\u8BA1\u7B97\u673A\u7684\u72B6\u6001\u0022\u5C31\u6070\u6070\u662F\u90A3\u4E9B\u65F6\u5E8F\u903B\u8F91\u90E8\u4EF6\u7684\u72B6\u6001, \u4E5F\u5C31\u662F\u5BC4\u5B58\u5668\u548C\u5185\u5B58\u7684\u503C. \u5176\u5B9E\u4ED4\u7EC6\u601D\u8003\u4E00\u4E0B, \u8BA1\u7B97\u673A\u6267\u884C\u6307\u4EE4, \u5C31\u662F\u4FEE\u6539\u8FD9\u4E9B\u65F6\u5E8F\u903B\u8F91\u90E8\u4EF6\u7684\u72B6\u6001\u7684\u8FC7\u7A0B. \u8981\u68C0\u67E5\u6307\u4EE4\u7684\u5B9E\u73B0\u662F\u5426\u6B63\u786E, \u53EA\u8981\u68C0\u67E5\u8FD9\u4E9B\u65F6\u5E8F\u903B\u8F91\u90E8\u4EF6\u4E2D\u7684\u503C\u662F\u5426\u4E00\u81F4\u5C31\u53EF\u4EE5\u4E86! DiffTest\u53EF\u4EE5\u975E\u5E38\u53CA\u65F6\u5730\u6355\u6349\u5230error, \u7B2C\u4E00\u6B21\u53D1\u73B0NEMU\u7684\u5BC4\u5B58\u5668\u6216\u5185\u5B58\u7684\u503C\u4E0E\u771F\u673A\u4E0D\u4E00\u6837\u7684\u65F6\u5019, \u5C31\u662F\u56E0\u4E3A\u5F53\u65F6\u6267\u884C\u7684\u6307\u4EE4\u5B9E\u73B0\u6709\u8BEF\u5BFC\u81F4\u7684. \u8FD9\u65F6\u5019\u5176\u5B9E\u79BBerror\u975E\u5E38\u63A5\u8FD1, \u9632\u6B62\u4E86error\u8FDB\u4E00\u6B65\u4F20\u64AD\u7684\u540C\u65F6, \u8981\u56DE\u6EAF\u627E\u5230fault\u4E5F\u5BB9\u6613\u5F97\u591A.\n\u003E \u591A\u4E48\u7F8E\u5999\u7684\u529F\u80FD\u554A! \u80CC\u540E\u8FD8\u8574\u542B\u7740\u8BA1\u7B97\u673A\u672C\u8D28\u7684\u6DF1\u523B\u539F\u7406! \u4F46\u5F88\u9057\u61BE, \u4E0D\u8981\u5FD8\u8BB0\u4E86, \u771F\u673A\u4E0A\u662F\u8FD0\u884C\u4E86\u64CD\u4F5C\u7CFB\u7EDFGNU/Linux\u7684, \u800CNEMU\u4E2D\u7684\u6D4B\u8BD5\u7A0B\u5E8F\u662F\u8FD0\u884C\u5728x86-nemu\u4E0A\u7684, \u6211\u4EEC\u65E0\u6CD5\u5728native\u4E2D\u8FD0\u884C\u7F16\u8BD1\u5230x86-nemu\u7684AM\u7A0B\u5E8F. \u6240\u4EE5, \u6211\u4EEC\u9700\u8981\u7684\u4E0D\u4EC5\u662F\u4E00\u4E2Ai386\u624B\u518C\u7684\u6B63\u786E\u5B9E\u73B0, \u800C\u4E14\u9700\u8981\u5728\u4E0A\u9762\u80FD\u6B63\u786E\u8FD0\u884Cx86-nemu\u7684AM\u7A0B\u5E8F.\n\u003E \u4E8B\u5B9E\u4E0A, QEMU\u5C31\u662F\u4E00\u4E2A\u4E0D\u9519\u7684\u53C2\u8003\u5B9E\u73B0. \u5B83\u662F\u4E00\u4E2A\u865A\u62DF\u51FA\u6765\u7684\u5B8C\u6574\u7684x86\u8BA1\u7B97\u673A\u7CFB\u7EDF, \u800CNEMU\u7684\u76EE\u6807\u53EA\u662F\u865A\u62DF\u51FAx86\u7684\u4E00\u4E2A\u5B50\u96C6, \u80FD\u5728NEMU\u4E0A\u8FD0\u884C\u7684\u7A0B\u5E8F, \u81EA\u7136\u4E5F\u80FD\u5728QEMU\u4E0A\u8FD0\u884C. \u56E0\u6B64, \u4E3A\u4E86\u901A\u8FC7DiffTest\u7684\u65B9\u6CD5\u6D4B\u8BD5NEMU\u5B9E\u73B0\u7684\u6B63\u786E\u6027, \u6211\u4EEC\u8BA9NEMU\u548CQEMU\u9010\u6761\u6307\u4EE4\u5730\u6267\u884C\u540C\u4E00\u4E2A\u5BA2\u6237\u7A0B\u5E8F. \u53CC\u65B9\u6BCF\u6267\u884C\u5B8C\u4E00\u6761\u6307\u4EE4, \u5C31\u68C0\u67E5\u5404\u81EA\u7684\u5BC4\u5B58\u5668\u548C\u5185\u5B58\u7684\u72B6\u6001, \u5982\u679C\u53D1\u73B0\u72B6\u6001\u4E0D\u4E00\u81F4, \u5C31\u9A6C\u4E0A\u62A5\u544A\u9519\u8BEF, \u505C\u6B62\u5BA2\u6237\u7A0B\u5E8F\u7684\u6267\u884C.\n\n#### diff-test.h\n\n\u5B9A\u4E49\u4E86\u5B8F \u0060DIFFTEST_REG_SIZE\u0060 \u89C4\u5B9A\u8BBF\u95EE\u7684\u5BC4\u5B58\u5668\u5927\u5C0F\u3002\n\n\u0060\u0060\u0060c\n#define DIFFTEST_REG_SIZE (sizeof(uint32_t) * 9) // GRPs \u002B EIP\n\u0060\u0060\u0060\n\n#### ref.c\n\n\u5728 DUT(Design Under Test, \u6D4B\u8BD5\u5BF9\u8C61)\u548C REF(Reference, \u53C2\u8003\u5B9E\u73B0) \u4E4B\u95F4\u5B9A\u4E49\u4E86\u4E00\u7EC4 API\u3002\n\n\u0060\u0060\u0060c\n// \u4ECEDUT host memory\u7684 src \u5904\u62F7\u8D1D n \u5B57\u8282\u5230REF guest memory\u7684 dest \u5904\nvoid difftest_memcpy_from_dut(paddr_t dest, void *src, size_t n);\n// \u83B7\u53D6REF\u7684\u5BC4\u5B58\u5668\u72B6\u6001\u5230 r \nvoid difftest_getregs(void *r);\n// \u8BBE\u7F6EREF\u7684\u5BC4\u5B58\u5668\u72B6\u6001\u4E3A r \nvoid difftest_setregs(const void *r);\n// \u8BA9REF\u6267\u884C n \u6761\u6307\u4EE4\nvoid difftest_exec(uint64_t n);\n// \u521D\u59CB\u5316REF\u7684DiffTest\u529F\u80FD\nvoid difftest_init();\n\u0060\u0060\u0060\n\n- \u5176\u4E2D\u5BC4\u5B58\u5668\u72B6\u6001 \u0060r\u0060 \u8981\u6C42\u5BC4\u5B58\u5668\u7684\u503C\u6309\u7167\u67D0\u79CD\u987A\u5E8F\u6392\u5217\uFF0C\u82E5\u672A\u6309\u8981\u6C42\u987A\u5E8F\u6392\u5217\uFF0C \u0060difftest_getregs()\u0060 \u548C \u0060difftest_setregs()\u0060 \u7684\u884C\u4E3A\u662F\u672A\u5B9A\u4E49\u7684. REF \u9700\u8981\u5B9E\u73B0\u8FD9\u4E9B API\uFF0CDUT\u4F1A\u4F7F\u7528\u8FD9\u4E9B API \u6765\u8FDB\u884C DiffTest \u3002\n\n#### diff-test.c\n\n\u5B9A\u4E49\u4E86\u53D8\u91CF \u0060is_skip_ref\u0060\uFF0C\u0060is_skip_dut\u0060 \u7528\u4E8E\u6807\u8BB0\u5FFD\u89C6\u4E00\u4E9B\u6307\u4EE4\u5904\u7684\u6BD4\u5BF9\u3002\uFF08\u53EF\u7ED3\u5408 \u0060difftest_step\u0060 \u5B9E\u73B0\uFF09\n\u5B9A\u4E49\u4E86\u51FD\u6570 \u0060difftest_skip_ref\u0060\uFF0C\u0060difftest_skip_dut\u0060 \u6807\u8BB0\u4E0A\u8FF0\u53D8\u91CF\u3002\n\n##### \u51FD\u6570 init_difftest\n\n\u521D\u59CB\u5316 Diff-Test\u3002\n\n- \u6253\u5F00\u52A8\u6001\u5E93\u6587\u4EF6 \u0060ref_so_file\u0060\n- \u4ECE\u52A8\u6001\u5E93\u4E2D\u5206\u522B\u8BFB\u53D6\u4E0A\u8FF0 API \u7684\u7B26\u53F7\n- \u5BF9 REF \u7684 DIffTest\u529F\u80FD\u8FDB\u884C\u521D\u59CB\u5316\uFF0C\u6B64\u65F6\u4F1A\u542F\u52A8 REF\uFF0C\u4EE3\u7801\u8FD8\u4F1A\u5BF9 REF \u7684\u72B6\u6001\u8FDB\u884C\u4E00\u4E9B\u521D\u59CB\u5316\u5DE5\u4F5C\uFF0CREF \u8FD0\u884C\u5728\u540E\u53F0\uFF0C\u56E0\u6B64\u5C06\u770B\u4E0D\u5230 REF \u7684\u4EFB\u4F55\u8F93\u51FA\n- \u5C06 DUT \u7684 guest memory \u62F7\u8D1D\u5230 REF \u4E2D\n- \u5C06 DUT \u7684\u5BC4\u5B58\u5668\u72B6\u6001\u62F7\u8D1D\u5230 REF \u4E2D\n\n##### \u51FD\u6570 difftest_step\n\n\u7528\u4E8E\u9010\u6761\u6307\u4EE4\u6267\u884C\u540E\u7684\u72B6\u6001\u5BF9\u6BD4\u3002\u5B83\u4F1A\u5728 \u0060exec_wrapper()\u0060 \u7684\u6700\u540E\u88AB\u8C03\u7528\u3002\u5728\u8FD9\u91CC\u8BFB\u53D6 REF \u7684\u5BC4\u5B58\u5668\u5E76\u4E0E NEMU \u5BC4\u5B58\u5668\u72B6\u6001\u6BD4\u5BF9\u3002\n\n## misc/\n\n### logo.c\n\n\u5B9A\u4E49\u4E86\u5B57\u7B26\u6570\u7EC4 \u0060logo\u0060 \u5B58\u50A8 i386 Manual Logo\u3002\u7528\u4E8E \u0060inv\u0060 \u6307\u4EE4\uFF08\u4F4D\u4E8E \u0060special.c\u0060 \u4E2D\uFF09\u3002\n\n# tools/\n\n## gen-expr.c\n\n\u751F\u6210 C \u8868\u8FBE\u5F0F\uFF0C\u7528\u4E8E\u6D4B\u8BD5\u8868\u8FBE\u5F0F\u6C42\u503C\u529F\u80FD\u3002\n\n## qemu-diff\n\nQEMU \u5B9E\u73B0\uFF0C\u7528\u4E8E Diff-Test\u3002\u7F16\u8BD1\u6210\u52A8\u6001\u5E93 \u0060qemu-so\u0060\uFF0C\u4F20\u5165 nemu \u7684 \u0060-d\u0060 \u53C2\u6570\u4E2D\u3002\n\n# \u5F15\u7528\u8D44\u6599\n\n- [ICS2018 PA \u8BB2\u4E49](https://legacy.gitbook.com/book/nju-ics/ics2018-programming-assignment/details)"},"Title":"NJU ICS Programming Assignment \u4EE3\u7801\u5206\u6790 - NEMU","Category":{"Items":["Learning"]},"Keywords":{"Items":[]},"CreationTime":"2018-10-05T19:30:22+08:00","ModificationTime":"2018-10-05T19:30:22+08:00"}