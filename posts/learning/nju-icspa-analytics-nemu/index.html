<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="æ¦‚è¿°  æ¡†æ¶ä»£ç åº“ CPU æ¶æ„ï¼šx64 æ“ä½œç³»ç»Ÿ: GNU/Linux ç¼–è¯‘å™¨: GCC ç¼–ç¨‹è¯­è¨€ï¼šC è¯­è¨€  ç”±äº NJU ICS PA æ¡†æ¶ä»£ç è¾ƒå¤šä¸”ç¼ºå°‘è¶³å¤Ÿè¯´æ˜ï¼Œè®²ä¹‰å¤šä¸ºåŸºç¡€å¼•å…¥å†…å®¹ï¼Œä¸ºæ–¹ä¾¿åç»­ç¨‹åºç¼–å†™ï¼Œæ ¹æ®å®é™…ä½œä¸šè¿‡ç¨‹ä¸­çš„ç†è§£æ•´ç†å‡ºæ­¤æ–‡ã€‚ æœ¬æ–‡ä¸»è¦åŒ…å«å¯¹ NJU ICS è¯¾ç¨‹ç¼–ç¨‹ä½œä¸šçš„æ¡†æ¶ä»£ç ä¸­ NEMU éƒ¨åˆ†çš„ç†è§£å’Œåˆ†æï¼Œè·Ÿéšè¯¾ç¨‹åŠè®²ä¹‰è¿›åº¦æ›´æ–°ï¼Œä»¥ä¸ªäººä½¿ç”¨ä¸ºä¸»ï¼Œå¯èƒ½å­˜åœ¨é”™è¯¯ã€‚
 éƒ¨åˆ†å†…å®¹æ¡†æ¶ä»£ç å¹¶ä¸åŒ…å«ï¼ˆå¦‚æ‰©å±•çš„ Debug å®ï¼‰ï¼Œå‡ä¸ºæˆ‘ä¸ºç¼–ç è€Œæ·»åŠ çš„å†…å®¹ã€‚é‡‡ç”¨ a_b æ–¹å¼å‘½åçš„å¤šä¸ºåŸå†…å®¹ï¼Œé‡‡ç”¨ aB æ–¹å¼å‘½åçš„å¤šä¸ºè¡¥å……å†…å®¹ã€‚ç”±äºæ­¤é¡¹ç›®æ˜¯ NJU ICS PA çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä¸­ä¼šåŒ…å«ä¸ç›¸å…³é¡¹ç›®çš„äº’æ“ä½œå†…å®¹ã€‚
 NEMU (NJU EMUlator) æ˜¯åœ¨ Linux ä¸Šçš„ä¸€ä¸ª n86ï¼ˆx86 å­é›†ï¼‰æ¨¡æ‹Ÿå™¨ï¼Œæ¨¡æ‹Ÿäº†åŸºæœ¬è®¡ç®—æœºç³»ç»Ÿçš„åŠŸèƒ½ï¼ˆå†…å­˜ï¼ŒCPUç­‰ï¼‰ã€‚åŒ…å«äº†ï¼š
 å†…å­˜ CPUï¼Œå¯„å­˜å™¨ è°ƒè¯•å™¨ï¼ˆç›‘è§†å™¨ï¼‰  æ¡†æ¶ä»£ç ç»“æ„ nanos-lite/ navy-apps/ nexus-am/ nemu/ # NEMU é¡¹ç›® build/ # æ„å»ºè¾“å‡ºæ–‡ä»¶å¤¹ nemu # NEMU ä¸»ç¨‹åºï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼‰ include/ # å¤´æ–‡ä»¶ src/ # æºç æ–‡ä»¶ tools/ # å·¥å…·æ–‡ä»¶ runall."><title>NJU ICS Programming Assignment ä»£ç åˆ†æ - NEMU</title><link rel=canonical href=https://stardustdl.github.io/posts/learning/nju-icspa-analytics-nemu/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="NJU ICS Programming Assignment ä»£ç åˆ†æ - NEMU"><meta property="og:description" content="æ¦‚è¿°  æ¡†æ¶ä»£ç åº“ CPU æ¶æ„ï¼šx64 æ“ä½œç³»ç»Ÿ: GNU/Linux ç¼–è¯‘å™¨: GCC ç¼–ç¨‹è¯­è¨€ï¼šC è¯­è¨€  ç”±äº NJU ICS PA æ¡†æ¶ä»£ç è¾ƒå¤šä¸”ç¼ºå°‘è¶³å¤Ÿè¯´æ˜ï¼Œè®²ä¹‰å¤šä¸ºåŸºç¡€å¼•å…¥å†…å®¹ï¼Œä¸ºæ–¹ä¾¿åç»­ç¨‹åºç¼–å†™ï¼Œæ ¹æ®å®é™…ä½œä¸šè¿‡ç¨‹ä¸­çš„ç†è§£æ•´ç†å‡ºæ­¤æ–‡ã€‚ æœ¬æ–‡ä¸»è¦åŒ…å«å¯¹ NJU ICS è¯¾ç¨‹ç¼–ç¨‹ä½œä¸šçš„æ¡†æ¶ä»£ç ä¸­ NEMU éƒ¨åˆ†çš„ç†è§£å’Œåˆ†æï¼Œè·Ÿéšè¯¾ç¨‹åŠè®²ä¹‰è¿›åº¦æ›´æ–°ï¼Œä»¥ä¸ªäººä½¿ç”¨ä¸ºä¸»ï¼Œå¯èƒ½å­˜åœ¨é”™è¯¯ã€‚
 éƒ¨åˆ†å†…å®¹æ¡†æ¶ä»£ç å¹¶ä¸åŒ…å«ï¼ˆå¦‚æ‰©å±•çš„ Debug å®ï¼‰ï¼Œå‡ä¸ºæˆ‘ä¸ºç¼–ç è€Œæ·»åŠ çš„å†…å®¹ã€‚é‡‡ç”¨ a_b æ–¹å¼å‘½åçš„å¤šä¸ºåŸå†…å®¹ï¼Œé‡‡ç”¨ aB æ–¹å¼å‘½åçš„å¤šä¸ºè¡¥å……å†…å®¹ã€‚ç”±äºæ­¤é¡¹ç›®æ˜¯ NJU ICS PA çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä¸­ä¼šåŒ…å«ä¸ç›¸å…³é¡¹ç›®çš„äº’æ“ä½œå†…å®¹ã€‚
 NEMU (NJU EMUlator) æ˜¯åœ¨ Linux ä¸Šçš„ä¸€ä¸ª n86ï¼ˆx86 å­é›†ï¼‰æ¨¡æ‹Ÿå™¨ï¼Œæ¨¡æ‹Ÿäº†åŸºæœ¬è®¡ç®—æœºç³»ç»Ÿçš„åŠŸèƒ½ï¼ˆå†…å­˜ï¼ŒCPUç­‰ï¼‰ã€‚åŒ…å«äº†ï¼š
 å†…å­˜ CPUï¼Œå¯„å­˜å™¨ è°ƒè¯•å™¨ï¼ˆç›‘è§†å™¨ï¼‰  æ¡†æ¶ä»£ç ç»“æ„ nanos-lite/ navy-apps/ nexus-am/ nemu/ # NEMU é¡¹ç›® build/ # æ„å»ºè¾“å‡ºæ–‡ä»¶å¤¹ nemu # NEMU ä¸»ç¨‹åºï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼‰ include/ # å¤´æ–‡ä»¶ src/ # æºç æ–‡ä»¶ tools/ # å·¥å…·æ–‡ä»¶ runall."><meta property="og:url" content="https://stardustdl.github.io/posts/learning/nju-icspa-analytics-nemu/"><meta property="og:site_name" content="StardustDL's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="NJU"><meta property="article:published_time" content="2018-10-05T19:30:22+08:00"><meta property="article:modified_time" content="2018-10-05T19:30:22+08:00"><meta name=twitter:title content="NJU ICS Programming Assignment ä»£ç åˆ†æ - NEMU"><meta name=twitter:description content="æ¦‚è¿°  æ¡†æ¶ä»£ç åº“ CPU æ¶æ„ï¼šx64 æ“ä½œç³»ç»Ÿ: GNU/Linux ç¼–è¯‘å™¨: GCC ç¼–ç¨‹è¯­è¨€ï¼šC è¯­è¨€  ç”±äº NJU ICS PA æ¡†æ¶ä»£ç è¾ƒå¤šä¸”ç¼ºå°‘è¶³å¤Ÿè¯´æ˜ï¼Œè®²ä¹‰å¤šä¸ºåŸºç¡€å¼•å…¥å†…å®¹ï¼Œä¸ºæ–¹ä¾¿åç»­ç¨‹åºç¼–å†™ï¼Œæ ¹æ®å®é™…ä½œä¸šè¿‡ç¨‹ä¸­çš„ç†è§£æ•´ç†å‡ºæ­¤æ–‡ã€‚ æœ¬æ–‡ä¸»è¦åŒ…å«å¯¹ NJU ICS è¯¾ç¨‹ç¼–ç¨‹ä½œä¸šçš„æ¡†æ¶ä»£ç ä¸­ NEMU éƒ¨åˆ†çš„ç†è§£å’Œåˆ†æï¼Œè·Ÿéšè¯¾ç¨‹åŠè®²ä¹‰è¿›åº¦æ›´æ–°ï¼Œä»¥ä¸ªäººä½¿ç”¨ä¸ºä¸»ï¼Œå¯èƒ½å­˜åœ¨é”™è¯¯ã€‚
 éƒ¨åˆ†å†…å®¹æ¡†æ¶ä»£ç å¹¶ä¸åŒ…å«ï¼ˆå¦‚æ‰©å±•çš„ Debug å®ï¼‰ï¼Œå‡ä¸ºæˆ‘ä¸ºç¼–ç è€Œæ·»åŠ çš„å†…å®¹ã€‚é‡‡ç”¨ a_b æ–¹å¼å‘½åçš„å¤šä¸ºåŸå†…å®¹ï¼Œé‡‡ç”¨ aB æ–¹å¼å‘½åçš„å¤šä¸ºè¡¥å……å†…å®¹ã€‚ç”±äºæ­¤é¡¹ç›®æ˜¯ NJU ICS PA çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä¸­ä¼šåŒ…å«ä¸ç›¸å…³é¡¹ç›®çš„äº’æ“ä½œå†…å®¹ã€‚
 NEMU (NJU EMUlator) æ˜¯åœ¨ Linux ä¸Šçš„ä¸€ä¸ª n86ï¼ˆx86 å­é›†ï¼‰æ¨¡æ‹Ÿå™¨ï¼Œæ¨¡æ‹Ÿäº†åŸºæœ¬è®¡ç®—æœºç³»ç»Ÿçš„åŠŸèƒ½ï¼ˆå†…å­˜ï¼ŒCPUç­‰ï¼‰ã€‚åŒ…å«äº†ï¼š
 å†…å­˜ CPUï¼Œå¯„å­˜å™¨ è°ƒè¯•å™¨ï¼ˆç›‘è§†å™¨ï¼‰  æ¡†æ¶ä»£ç ç»“æ„ nanos-lite/ navy-apps/ nexus-am/ nemu/ # NEMU é¡¹ç›® build/ # æ„å»ºè¾“å‡ºæ–‡ä»¶å¤¹ nemu # NEMU ä¸»ç¨‹åºï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼‰ include/ # å¤´æ–‡ä»¶ src/ # æºç æ–‡ä»¶ tools/ # å·¥å…·æ–‡ä»¶ runall."><link rel="shortcut icon" href=/favicon.png><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-111573521-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="article-page keep-sidebar"><script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.body.dataset.scheme='dark':document.body.dataset.scheme='light'})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=/assets/images/avatar_hu55fbf1db337484ccbc1a7220a4594f60_220509_300x0_resize_box_2.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
<span class=emoji>ğŸ¥</span></figure><h1 class=site-name><a href=https://stardustdl.github.io/>StardustDL's Blog</a></h1><h2 class=site-description></h2></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/learning/>Learning</a></header><h2 class=article-title><a href=/posts/learning/nju-icspa-analytics-nemu/>NJU ICS Programming Assignment ä»£ç åˆ†æ - NEMU</a></h2><footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>Oct 05, 2018</time></footer></div></header><section class=article-content><h1 id=æ¦‚è¿°>æ¦‚è¿°</h1><ul><li><a class=link href=https://github.com/NJU-ProjectN/nemu target=_blank rel=noopener>æ¡†æ¶ä»£ç åº“</a></li><li>CPU æ¶æ„ï¼šx64</li><li>æ“ä½œç³»ç»Ÿ: GNU/Linux</li><li>ç¼–è¯‘å™¨: GCC</li><li>ç¼–ç¨‹è¯­è¨€ï¼šC è¯­è¨€</li></ul><p>ç”±äº NJU ICS PA æ¡†æ¶ä»£ç è¾ƒå¤šä¸”ç¼ºå°‘è¶³å¤Ÿè¯´æ˜ï¼Œè®²ä¹‰å¤šä¸ºåŸºç¡€å¼•å…¥å†…å®¹ï¼Œä¸ºæ–¹ä¾¿åç»­ç¨‹åºç¼–å†™ï¼Œæ ¹æ®å®é™…ä½œä¸šè¿‡ç¨‹ä¸­çš„ç†è§£æ•´ç†å‡ºæ­¤æ–‡ã€‚
æœ¬æ–‡ä¸»è¦åŒ…å«å¯¹ NJU ICS è¯¾ç¨‹ç¼–ç¨‹ä½œä¸šçš„æ¡†æ¶ä»£ç ä¸­ NEMU éƒ¨åˆ†çš„ç†è§£å’Œåˆ†æï¼Œè·Ÿéšè¯¾ç¨‹åŠè®²ä¹‰è¿›åº¦æ›´æ–°ï¼Œä»¥ä¸ªäººä½¿ç”¨ä¸ºä¸»ï¼Œå¯èƒ½å­˜åœ¨é”™è¯¯ã€‚</p><blockquote><p>éƒ¨åˆ†å†…å®¹æ¡†æ¶ä»£ç å¹¶ä¸åŒ…å«ï¼ˆå¦‚æ‰©å±•çš„ Debug å®ï¼‰ï¼Œå‡ä¸ºæˆ‘ä¸ºç¼–ç è€Œæ·»åŠ çš„å†…å®¹ã€‚é‡‡ç”¨ <code>a_b</code> æ–¹å¼å‘½åçš„å¤šä¸ºåŸå†…å®¹ï¼Œé‡‡ç”¨ <code>aB</code> æ–¹å¼å‘½åçš„å¤šä¸ºè¡¥å……å†…å®¹ã€‚ç”±äºæ­¤é¡¹ç›®æ˜¯ NJU ICS PA çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä¸­ä¼šåŒ…å«ä¸ç›¸å…³é¡¹ç›®çš„äº’æ“ä½œå†…å®¹ã€‚</p></blockquote><p>NEMU (NJU EMUlator) æ˜¯åœ¨ Linux ä¸Šçš„ä¸€ä¸ª n86ï¼ˆx86 å­é›†ï¼‰æ¨¡æ‹Ÿå™¨ï¼Œæ¨¡æ‹Ÿäº†åŸºæœ¬è®¡ç®—æœºç³»ç»Ÿçš„åŠŸèƒ½ï¼ˆå†…å­˜ï¼ŒCPUç­‰ï¼‰ã€‚åŒ…å«äº†ï¼š</p><ul><li>å†…å­˜</li><li>CPUï¼Œå¯„å­˜å™¨</li><li>è°ƒè¯•å™¨ï¼ˆç›‘è§†å™¨ï¼‰</li></ul><h2 id=æ¡†æ¶ä»£ç ç»“æ„>æ¡†æ¶ä»£ç ç»“æ„</h2><pre><code>nanos-lite/
navy-apps/
nexus-am/
nemu/               # NEMU é¡¹ç›®
    build/          # æ„å»ºè¾“å‡ºæ–‡ä»¶å¤¹
        nemu        # NEMU ä¸»ç¨‹åºï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼‰
    include/        # å¤´æ–‡ä»¶
    src/            # æºç æ–‡ä»¶
    tools/          # å·¥å…·æ–‡ä»¶
    runall.sh       # æµ‹è¯• AM cputest æµ‹è¯•é›† ï¼ˆnexus-am/tests/cputestï¼‰
    Makefile        # NEMU æ„å»ºå‘½ä»¤
    Makefile.git    # NEMU Git è®°å½•å‘½ä»¤
</code></pre><h1 id=include>include/</h1><h2 id=nemuh>nemu.h</h2><p>åŸºç¡€å¤´æ–‡ä»¶ã€‚åŒ…å«äº† <code>commom.h</code>ï¼Œ<code>memory/memory.h</code>ï¼Œ<code>cpu/reg.h</code></p><h2 id=macroh>macro.h</h2><p>å®šä¹‰äº†ä¸€äº›å­—ç¬¦ä¸²è¿æ¥å® <code>concat</code> ç­‰ã€‚</p><h2 id=commonh>common.h</h2><p>å®šä¹‰äº†ä¸€äº›ç±»å‹åˆ«åã€‚</p><table><thead><tr><th>ç±»å‹åˆ«å</th><th>åŸç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>rtlreg_t</code></td><td><code>uint32_t</code></td><td>RTLå¯„å­˜å™¨</td></tr><tr><td><code>vaddr_t</code></td><td><code>uint32_t</code></td><td>è™šæ‹Ÿåœ°å€</td></tr><tr><td><code>paddr_t</code></td><td><code>uint32_t</code></td><td>ç‰©ç†åœ°å€</td></tr><tr><td><code>ioaddr_t</code></td><td><code>uint16_t</code></td><td>I/O ç«¯å£åœ°å€</td></tr></tbody></table><ul><li><code>relreg_t</code> å¤šç”¨äºå¯„å­˜å™¨è®¿é—®</li><li><code>vaddr_t</code> <code>paddr_t</code> å¤šç”¨äºå†…å­˜è®¿é—®</li><li><code>ioaddr_t</code> å¤šç”¨äºè®¾å¤‡ I/O ç«¯å£è®¿é—®</li></ul><p>å®šä¹‰äº†ä¸€äº›æ§åˆ¶ç¼–è¯‘æ–¹å¼çš„å®ã€‚</p><table><thead><tr><th>å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>DEBUG</code></td><td>å¯ç”¨è°ƒè¯•</td></tr><tr><td><code>DIFF_TEST</code></td><td>å¯ç”¨ diff-test</td></tr><tr><td><code>HAS_IOE</code></td><td>å¯ç”¨è¾“å…¥è¾“å‡ºæ‰©å±•</td></tr></tbody></table><ul><li><code>DIFF_TEST</code> å¯å¯ç”¨ä¸€ä¸ªå·®å¼‚æµ‹è¯•å·¥å…·ï¼Œå‚è§ <code>tools/qemu-diff</code> éƒ¨åˆ†ã€‚</li><li><code>HAS_IOE</code> å¯ç”¨è¾“å…¥è¾“å‡ºè®¾å¤‡ï¼Œå‚è§è®¾å¤‡éƒ¨åˆ†ã€‚</li></ul><h2 id=debugh>debug.h</h2><p>å®šä¹‰äº†ä¾¿äºè°ƒè¯•çš„å®ã€‚</p><table><thead><tr><th>å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>Log_write(format, ...)</code></td><td>ä»…è®°å½•æ—¥å¿—</td></tr><tr><td><code>printflog(format, ...)</code></td><td>æ˜¾ç¤ºæ–‡æœ¬å¹¶è®°å½•æ—¥å¿—</td></tr><tr><td><code>Log(format, ...)</code></td><td>å¯¹ <code>printflog</code> çš„æ‰©å±•ï¼ŒåŒ…å«å½“å‰æ–‡ä»¶ï¼Œè¡Œï¼Œå‡½æ•°</td></tr><tr><td><code>Info(format, ...)</code></td><td>å¯¹ <code>Log</code> çš„æ‰©å±•ï¼Œæ—¥å¿—çº§åˆ«ï¼šæç¤º</td></tr><tr><td><code>Warning(format, ...)</code></td><td>å¯¹ <code>Log</code> çš„æ‰©å±•ï¼Œæ—¥å¿—çº§åˆ«ï¼šè­¦å‘Š</td></tr><tr><td><code>Error(format, ...)</code></td><td>å¯¹ <code>Log</code> çš„æ‰©å±•ï¼Œæ—¥å¿—çº§åˆ«ï¼šé”™è¯¯</td></tr><tr><td><code>panic(format, ...)</code></td><td>å¼ºåˆ¶é€€å‡ºï¼Œæ˜¾ç¤ºæ–‡æœ¬å¹¶è®°å½•æ—¥å¿—</td></tr><tr><td><code>Assert(cond [, format, ...])</code></td><td>è®¾ç½®æ–­è¨€ï¼Œå¤±è´¥æ—¶å¼ºåˆ¶é€€å‡ºï¼Œæ˜¾ç¤ºæ–‡æœ¬å¹¶è®°å½•æ—¥å¿—</td></tr><tr><td><code>TODO()</code></td><td>æ ‡è¯†å¾…å®Œæˆé¡¹ï¼Œæ‰§è¡Œæ—¶ä¼šè§¦å‘ <code>panic</code></td></tr></tbody></table><h2 id=cpu>cpu/</h2><h3 id=regh>reg.h</h3><p>å®šä¹‰äº†å¯„å­˜å™¨ç»“æ„ï¼Œå’Œè¾…åŠ©å¯„å­˜å™¨çš„ä¸€äº›å®å’Œå‡½æ•°ã€‚</p><ul><li>å¤–éƒ¨æ•°ç»„ <code>regsl, regsw, regsb</code> ä¸åŒå¯„å­˜å™¨åã€‚å®ç°åœ¨ <code>src/cpu/reg.c</code></li></ul><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>extern</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>regsl</span><span class=p>[];</span>
<span class=k>extern</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>regsw</span><span class=p>[];</span>
<span class=k>extern</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>regsb</span><span class=p>[];</span>
</code></pre></div><h4 id=ç»“æ„ä½“-cpu_state>ç»“æ„ä½“ CPU_state</h4><p>å¯„å­˜å™¨ç»“æ„ï¼ŒåŒ…å«äº†æ‰€æœ‰å¯„å­˜å™¨ï¼Œå‡ä¸ºæ— ç¬¦å·æ•´æ•°ã€‚</p><ul><li>å¯¹äº 8 ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œå†…éƒ¨ä»¥ <code>gpr</code> æ•°ç»„ä¸ºåŸºç¡€ç»“æ„ï¼Œæä¾› <code>eax</code> ç­‰åˆ«åæ–¹ä¾¿è®¿é—®ã€‚å¯„å­˜å™¨æŒ‰ç…§ i386 æŒ‡ä»¤ä¸­å¯„å­˜å™¨æ ‡å·é¡ºåºæ’åˆ—ã€‚å¯ä½¿ç”¨ <code>_16,_8[0],_8[1]</code> è®¿é—®å¯„å­˜å™¨ä½ä½éƒ¨åˆ†ã€‚</li><li><code>eip</code> å½“å‰æ‰§è¡ŒæŒ‡ä»¤ä½ç½®å¯„å­˜å™¨</li><li><code>eflags</code> æ ‡å¿—ä½å¯„å­˜å™¨ï¼ˆä½¿ç”¨åŒ¿åç»“æ„ä½“ï¼Œå¯ç›´æ¥è®¿é—® <code>CF,OF,ZF,SF</code>ï¼‰<ul><li><code>eflags</code> åˆå§‹åŒ–ä¸º <code>0x2</code></li></ul></li><li><code>cs,ss,ds,es,fs,gs</code> ç¨‹åºæ®µå¯„å­˜å™¨ï¼ˆä»…ä¸ºæ”¯æŒ diff-testï¼‰<ul><li><code>cs</code> åˆå§‹åŒ–ä¸º <code>8</code></li></ul></li><li><code>idtr</code> 48 ä½å¯„å­˜å™¨ï¼Œå­˜æ”¾ IDT (Interrupt Descriptor Table, ä¸­æ–­æè¿°ç¬¦è¡¨)çš„é¦–åœ°å€å’Œé•¿åº¦<ul><li><code>limit</code> 16ä½ï¼Œé•¿åº¦ï¼Œå•ä½ï¼šå­—èŠ‚</li><li><code>base</code> 32ä½ï¼ŒIDT åŸºåœ°å€</li></ul></li></ul><table><thead><tr><th>å‡½æ•°/å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>reg_l(index)</code></td><td>è·å–æŒ‡å®šä¸‹æ ‡å¤„å¯„å­˜å™¨32ä½å€¼</td></tr><tr><td><code>reg_w(index)</code></td><td>è·å–æŒ‡å®šä¸‹æ ‡å¤„å¯„å­˜å™¨ä½16ä½å€¼</td></tr><tr><td><code>reg_b(index)</code></td><td>è·å–æŒ‡å®šä¸‹æ ‡å¤„å¯„å­˜å™¨ä½8ä½å€¼</td></tr><tr><td><code>reg_name(index,width)</code></td><td>æ ¹æ®ä¸‹æ ‡å’Œä½å®½è·å¾—å¯„å­˜å™¨å</td></tr></tbody></table><blockquote><p>å¯„å­˜å™¨å­˜å‚¨åœ¨å˜é‡ <code>cpu</code> ä¸­ã€‚</p></blockquote><h4 id=æšä¸¾>æšä¸¾</h4><p>å®šä¹‰äº†å½¢å¦‚ <code>R_NAME</code> çš„å¯„å­˜å™¨æšä¸¾ï¼Œå…¶é¡ºåºä¸å¯„å­˜å™¨ç»“æ„ä¸­çš„é¡ºåºä¸€è‡´ã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>enum</span> <span class=p>{</span> <span class=n>R_EAX</span><span class=p>,</span> <span class=n>R_ECX</span><span class=p>,</span> <span class=n>R_EDX</span><span class=p>,</span> <span class=n>R_EBX</span><span class=p>,</span> <span class=n>R_ESP</span><span class=p>,</span> <span class=n>R_EBP</span><span class=p>,</span> <span class=n>R_ESI</span><span class=p>,</span> <span class=n>R_EDI</span> <span class=p>};</span>
<span class=k>enum</span> <span class=p>{</span> <span class=n>R_AX</span><span class=p>,</span> <span class=n>R_CX</span><span class=p>,</span> <span class=n>R_DX</span><span class=p>,</span> <span class=n>R_BX</span><span class=p>,</span> <span class=n>R_SP</span><span class=p>,</span> <span class=n>R_BP</span><span class=p>,</span> <span class=n>R_SI</span><span class=p>,</span> <span class=n>R_DI</span> <span class=p>};</span>
<span class=k>enum</span> <span class=p>{</span> <span class=n>R_AL</span><span class=p>,</span> <span class=n>R_CL</span><span class=p>,</span> <span class=n>R_DL</span><span class=p>,</span> <span class=n>R_BL</span><span class=p>,</span> <span class=n>R_AH</span><span class=p>,</span> <span class=n>R_CH</span><span class=p>,</span> <span class=n>R_DH</span><span class=p>,</span> <span class=n>R_BH</span> <span class=p>};</span>
</code></pre></div><h3 id=decodeh>decode.h</h3><p>å®šä¹‰äº†ç”¨äºæŒ‡ä»¤è¯‘ç çš„ç»“æ„å’Œå‡½æ•°ã€‚</p><h4 id=ç»“æ„ä½“-operand>ç»“æ„ä½“ Operand</h4><p>æ“ä½œæ•°ã€‚</p><table><thead><tr><th>æˆå‘˜</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>type</code></td><td>ç±»å‹ï¼ˆè§ä¸‹æ–¹æšä¸¾ï¼‰</td></tr><tr><td><code>width</code></td><td>ä½å®½</td></tr><tr><td><code>val</code></td><td>å®é™…å€¼</td></tr><tr><td><code>str</code></td><td>åŸä¸²ï¼ˆç”¨äºè°ƒè¯•è¾“å‡ºï¼‰</td></tr><tr><td><code>reg</code></td><td>å¯„å­˜å™¨ä¸‹æ ‡</td></tr><tr><td><code>addr</code></td><td>å†…å­˜åœ°å€</td></tr><tr><td><code>imm</code></td><td>ç«‹å³æ•°</td></tr><tr><td><code>simm</code></td><td>å¸¦ç¬¦å·ç«‹å³æ•°</td></tr></tbody></table><h4 id=ç»“æ„ä½“-decodeinfo>ç»“æ„ä½“ DecodeInfo</h4><p>å•æ¡å‘½ä»¤è¯‘ç ç»“æœã€‚</p><table><thead><tr><th>æˆå‘˜</th><th>æè¿°</th><th>å¯¹åº”x86æŒ‡ä»¤éƒ¨åˆ†</th></tr></thead><tbody><tr><td><code>opcode</code></td><td>æŒ‡ä»¤ç </td><td>opcode</td></tr><tr><td><code>seq_eip</code></td><td>åºåˆ— EIP ä½ç½®</td><td></td></tr><tr><td><code>is_operand_size_16</code></td><td>æ ‡è¯†æ“ä½œæ•°æ˜¯å¦ä¸º 16 ä½</td><td>operand-size prefix</td></tr><tr><td><code>ext_opcode</code></td><td>é¢å¤–æŒ‡ä»¤ç </td><td>ModR/M ä¸­ opcode</td></tr><tr><td><code>is_jmp</code></td><td>æ ‡è¯†æ˜¯å¦ä¸ºè·³è½¬è¯­å¥</td><td></td></tr><tr><td><code>jmp_eip</code></td><td>è·³è½¬ç›®æ ‡ï¼ˆç»å¯¹åœ°å€ï¼‰ï¼Œä»…å¯¹äºè·³è½¬è¯­å¥</td><td></td></tr><tr><td><code>src</code></td><td>æºæ“ä½œæ•°</td><td></td></tr><tr><td><code>src2</code></td><td>ç¬¬äºŒä¸ªæºæ“ä½œæ•°</td><td></td></tr><tr><td><code>dest</code></td><td>ç›®æ ‡æ“ä½œæ•°</td><td></td></tr><tr><td><code>assembly</code></td><td></td><td></td></tr><tr><td><code>asm_buf</code></td><td></td><td></td></tr><tr><td><code>p</code></td><td></td><td></td></tr></tbody></table><ul><li><code>seq_eip</code> éšè¯‘ç è¿‡ç¨‹æ”¹å˜ï¼Œæœ€ç»ˆåœç•™åœ¨éœ€è¦è¯‘ç çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼Œå¯æ ¹æ®è¿™ä¸€å€¼å®ç° eip æ›´æ–°ã€‚</li><li><code>is_operand_size_16</code> å¤šç”¨äºå®ç°å•å‘½ä»¤å­˜åœ¨ 16 ä½ï¼Œ32 ä½ä¸¤ä¸ªç‰ˆæœ¬çš„æƒ…å†µ</li><li><code>ext_opcode</code> ç”¨äºå®ç° <code>sub /5</code> è¿™ç§æ ¹æ®ç¬¬äºŒä¸ªæŒ‡ä»¤ç  <code>/5</code> åŒºåˆ†ä¸åŒæŒ‡ä»¤çš„æƒ…å†µï¼Œåœ¨è¯‘ç ä¸­ä½¿ç”¨ <code>make_group</code> å®ç°ã€‚</li><li><code>is_jmp</code> å¤šåœ¨è¿è¡Œæ—¶æŒ‡å®šï¼ˆå¦‚ <code>rtl_j</code> å‡½æ•°ï¼‰ï¼Œå¦‚æœæ ‡è®°ï¼Œåˆ™ä¸ä¼šå†æ ¹æ® <code>seq_eip</code> æ›´æ–° eip</li></ul><table><thead><tr><th>å‡½æ•°/å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>id_src</code></td><td><code>(&decoding.src)</code></td></tr><tr><td><code>id_src2</code></td><td><code>(&decoding.src2)</code></td></tr><tr><td><code>id_dest</code></td><td><code>(&decoding.dest)</code></td></tr><tr><td><code>operand_write(Operand *, rtlreg_t *)</code></td><td>æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°ä¸­è®°å½•çš„ç±»å‹çš„ä¸åŒè¿›è¡Œç›¸åº”çš„å†™æ“ä½œï¼ŒåŒ…æ‹¬å†™å¯„å­˜å™¨å’Œå†™å†…å­˜</td></tr><tr><td><code>load_addr(vaddr_t *, ModR_M *, Operand *)</code></td><td></td></tr><tr><td><code>read_ModR_M(vaddr_t *, Operand *, bool, Operand *, bool)</code></td><td></td></tr></tbody></table><blockquote><p>è¯‘ç å†…å®¹å­˜å‚¨åœ¨å˜é‡ <code>decoding</code> ä¸­ã€‚</p></blockquote><h4 id=ç»“æ„ä½“-modr_m>ç»“æ„ä½“ ModR_M</h4><p>æŒ‡ä»¤ä¸­çš„ ModR/Mã€‚</p><h4 id=ç»“æ„ä½“-sib>ç»“æ„ä½“ SIB</h4><p>æŒ‡ä»¤ä¸­çš„ SIBã€‚</p><h4 id=æšä¸¾-1>æšä¸¾</h4><p>å®šä¹‰äº†æ“ä½œæ•°çš„ç±»å‹ <code>OP_TYPE_REG</code>ï¼Œ<code>OP_TYPE_MEM</code>ï¼Œ<code>OP_TYPE_IMM</code>ï¼Œåˆ†åˆ«ä¸ºå¯„å­˜å™¨ï¼Œå†…å­˜ï¼Œç«‹å³æ•°ã€‚</p><h4 id=å®-make_dhelper-ä¸å‡½æ•°æ—-decode_name>å® make_DHelper ä¸å‡½æ•°æ— decode_name</h4><p>ç”±å® <code>make_DHelper</code> å®šä¹‰äº†ä¸€æ—å‡½æ•°ï¼ˆå‚æ•°ç›¸åŒï¼‰ï¼Œç”¨äºæŒ‡ä»¤è¯‘ç ï¼Œå¹¶å®šä¹‰äº†è¿™äº›å‡½æ•°çš„æŒ‡é’ˆç±»å‹ <code>DHelper</code>ã€‚</p><ul><li>è®¾è®¡ç›®çš„ï¼šç”±äºå¤§é‡æŒ‡ä»¤çš„æ“ä½œæ•°æ¨¡å¼ç›¸ä¼¼ï¼Œå°†è¿™ä¸€ç‚¹æå–å‡ºæ¥ï¼Œå®ç°è§£è€¦ã€‚</li></ul><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#define make_DHelper(name) void concat(decode_, name) (vaddr_t *eip)
</span><span class=cp></span><span class=k>typedef</span> <span class=nf>void</span> <span class=p>(</span><span class=o>*</span><span class=n>DHelper</span><span class=p>)</span> <span class=p>(</span><span class=n>vaddr_t</span> <span class=o>*</span><span class=p>);</span>
</code></pre></div><p>å‡½æ•°æ—ä¸­éƒ¨åˆ†å‡½æ•°å‘½åè§„åˆ™ï¼ˆ<strong>ä¸å…¨</strong>ï¼‰ï¼š</p><table><thead><tr><th>åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>I</code></td><td>ç«‹å³æ•°</td></tr><tr><td><code>SI</code></td><td>æœ‰ç¬¦å·ç«‹å³æ•°</td></tr><tr><td><code>E</code></td><td>å†…å­˜æˆ–å¯„å­˜å™¨ï¼ˆå¯¹åº”æŒ‡ä»¤æè¿°ä¸­çš„ r/mï¼‰</td></tr><tr><td><code>G</code></td><td>é€šç”¨å¯„å­˜å™¨</td></tr><tr><td><code>r</code></td><td>å•ä¸€å¯„å­˜å™¨</td></tr><tr><td><code>a</code></td><td>æŒ‡å®šå¯„å­˜å™¨ä¸º <code>eax,ax,al</code></td></tr><tr><td><code>I2G</code></td><td>ç«‹å³æ•°åˆ°é€šç”¨å¯„å­˜å™¨</td></tr><tr><td><code>I_E2G</code></td><td>ç«‹å³æ•°ä¸å†…å­˜æˆ–å¯„å­˜å™¨åˆ°é€šç”¨å¯„å­˜å™¨</td></tr><tr><td><code>O</code></td><td>æœªçŸ¥</td></tr></tbody></table><ul><li><code>r</code> ä¸€èˆ¬ç”¨äºå¯„å­˜å™¨ä¿¡æ¯å­˜å‚¨åœ¨ <code>opcode</code> ä¸­çš„æƒ…å†µ</li><li>è¿˜æœ‰ä¸€äº›ä¸“ç”¨äºç‰¹å®šæŒ‡ä»¤çš„è¯‘ç å‡½æ•°</li></ul><blockquote><p>å»ºè®®ç»“åˆ i386 æ‰‹å†Œé™„å½• C ç†è§£ã€‚</p></blockquote><p>å‡½æ•°æ—ä¸­ç‰¹æ®Šå‡½æ•°ï¼š</p><ul><li><code>J</code> è·³è½¬æŒ‡ä»¤è§£ç ã€‚å•æ“ä½œæ•°ï¼Œå­˜å‚¨åˆ° <code>jmp_eip</code> ä¸­ã€‚</li></ul><h3 id=exech>exec.h</h3><p>å®šä¹‰äº†ä¸€äº›ç”¨äºè°ƒè¯•çš„æŒ‡ä»¤æ‰“å°å®ï¼š</p><table><thead><tr><th>å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>print_asm</code></td><td>æ‰“å°æŒ‡ä»¤</td></tr><tr><td><code>suffix_char</code></td><td>æ ¹æ®å®½åº¦è·å–æŒ‡ä»¤å®½åº¦åç¼€</td></tr><tr><td><code>print_asm_template1</code></td><td>å•æ“ä½œæ•°æŒ‡ä»¤</td></tr><tr><td><code>print_asm_template2</code></td><td>åŒæ“ä½œæ•°æŒ‡ä»¤</td></tr><tr><td><code>print_asm_template3</code></td><td>ä¸‰æ“ä½œæ•°æŒ‡ä»¤</td></tr></tbody></table><h4 id=å‡½æ•°-instr_fetch>å‡½æ•° instr_fetch</h4><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>uint32_t</span> <span class=n>instr_fetch</span><span class=p>(</span><span class=n>vaddr_t</span> <span class=o>*</span><span class=n>eip</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>)</span>
</code></pre></div><p>ä» <code>eip</code> å¼€å§‹ï¼Œè¯»å– <code>len</code> ä¸ªå­—èŠ‚ï¼Œè¿”å›å€¼ï¼Œå¹¶è‡ªåŠ¨å¢åŠ  <code>eip</code>ã€‚</p><ul><li>è®¾è®¡ç›®çš„ï¼šä¸æœºå™¨çš„å¤§ç«¯å°ç«¯è§£è€¦ã€‚</li></ul><h4 id=å®-make_ehelper-ä¸-å‡½æ•°æ—-exec_name>å® make_EHelper ä¸ å‡½æ•°æ— exec_name</h4><p>ç”¨äºå®šä¹‰ä¸€æ—å‡½æ•°ï¼ˆå‚æ•°ç›¸åŒï¼‰ï¼Œç”¨äºæŒ‡ä»¤æ‰§è¡Œï¼Œå¹¶å®šä¹‰äº†è¿™äº›å‡½æ•°çš„æŒ‡é’ˆç±»å‹ <code>EHelper</code>ã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#define make_EHelper(name) void concat(exec_, name) (vaddr_t *eip)
</span><span class=cp></span><span class=k>typedef</span> <span class=nf>void</span> <span class=p>(</span><span class=o>*</span><span class=n>EHelper</span><span class=p>)</span> <span class=p>(</span><span class=n>vaddr_t</span> <span class=o>*</span><span class=p>);</span>
</code></pre></div><h3 id=reloph>relop.h</h3><p>å®šä¹‰äº†å½¢å¦‚ <code>RELOP_NAME</code> çš„æšä¸¾ï¼Œæ ‡è¯†ä¸åŒç±»å‹çš„å…³ç³»è¿ç®—ã€‚å¯¹åº”äº† <code>setcc,jcc</code> å‘½ä»¤çš„ç›¸åº”ç¼–ç ã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>enum</span> <span class=p>{</span>
  <span class=c1>//            +-- unsign
</span><span class=c1></span>  <span class=c1>//            |   +-- sign
</span><span class=c1></span>  <span class=c1>//            |   |   +-- equal
</span><span class=c1></span>  <span class=c1>//            |   |   |   +-- invert
</span><span class=c1></span>  <span class=c1>//            |   |   |   |
</span><span class=c1></span>  <span class=n>RELOP_FALSE</span> <span class=o>=</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>0</span><span class=p>,</span>
  <span class=n>RELOP_TRUE</span>  <span class=o>=</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>1</span><span class=p>,</span>
  <span class=n>RELOP_EQ</span>    <span class=o>=</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>2</span> <span class=o>|</span> <span class=mi>0</span><span class=p>,</span>
  <span class=n>RELOP_NE</span>    <span class=o>=</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>2</span> <span class=o>|</span> <span class=mi>1</span><span class=p>,</span>

  <span class=n>RELOP_LT</span>    <span class=o>=</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>4</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>0</span><span class=p>,</span>
  <span class=n>RELOP_LE</span>    <span class=o>=</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>4</span> <span class=o>|</span> <span class=mi>2</span> <span class=o>|</span> <span class=mi>0</span><span class=p>,</span>
  <span class=n>RELOP_GT</span>    <span class=o>=</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>4</span> <span class=o>|</span> <span class=mi>2</span> <span class=o>|</span> <span class=mi>1</span><span class=p>,</span>
  <span class=n>RELOP_GE</span>    <span class=o>=</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>4</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>1</span><span class=p>,</span>

  <span class=n>RELOP_LTU</span>   <span class=o>=</span> <span class=mi>8</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>0</span><span class=p>,</span>
  <span class=n>RELOP_LEU</span>   <span class=o>=</span> <span class=mi>8</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>2</span> <span class=o>|</span> <span class=mi>0</span><span class=p>,</span>
  <span class=n>RELOP_GTU</span>   <span class=o>=</span> <span class=mi>8</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>2</span> <span class=o>|</span> <span class=mi>1</span><span class=p>,</span>
  <span class=n>RELOP_GEU</span>   <span class=o>=</span> <span class=mi>8</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>0</span> <span class=o>|</span> <span class=mi>1</span><span class=p>,</span>
<span class=p>};</span>
</code></pre></div><h3 id=cch>cc.h</h3><p>å®šä¹‰äº†å‡½æ•° <code>get_cc_name</code> æ ¹æ®ç¼–ç è·å–æŒ‡å®šå…³ç³»è¿ç®—å­—ç¬¦ä¸²ã€‚</p><p>å®šä¹‰äº† RTL åŸºæœ¬æŒ‡ä»¤ <code>rtl_setcc</code> ç”¨äºæ ¹æ®å½“å‰å…³ç³»è¿ç®—å’Œ eflags å¯„å­˜å™¨æ ‡å¿—ä½è®¾ç½® destã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>rtl_setcc</span><span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span><span class=p>,</span> <span class=n>uint8_t</span><span class=p>);</span>
</code></pre></div><h3 id=rtlh>rtl.h</h3><p>å®šä¹‰å’Œå®ç°äº†ä¸€äº› RTL æŒ‡ä»¤ï¼Œç”¨äºæä¾›å¯¹æŒ‡ä»¤æ‰§è¡Œçš„åº•å±‚å»ºæ¨¡ã€‚å¯ä½¿ç”¨è¿™äº›æ“ä½œå°†å¤æ‚æŒ‡ä»¤åˆ†è§£æˆæ›´ç®€å•çš„æ“ä½œã€‚</p><p>NEMU ä¸­çš„ RTL å¯„å­˜å™¨ï¼š</p><ul><li>x86çš„å…«ä¸ªé€šç”¨å¯„å­˜å™¨(åœ¨ <code>include/cpu/reg.h</code> ä¸­å®šä¹‰)</li><li><code>id_src</code>, <code>id_src2</code> å’Œ <code>id_dest</code> ä¸­çš„è®¿å­˜åœ°å€ <code>addr</code> å’Œæ“ä½œæ•°å†…å®¹ <code>val</code> (åœ¨ <code>include/cpu/decode.h</code> ä¸­å®šä¹‰). ä»æ¦‚å¿µä¸Šçœ‹, å®ƒä»¬åˆ†åˆ«ä¸MARå’Œ MDRæœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™</li><li>ä¸´æ—¶å¯„å­˜å™¨ <code>t0~t3</code> å’Œ <code>at</code> (åœ¨ <code>src/cpu/decode/decode.c</code> ä¸­å®šä¹‰)</li></ul><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>extern</span> <span class=n>rtlreg_t</span> <span class=n>t0</span><span class=p>,</span> <span class=n>t1</span><span class=p>,</span> <span class=n>t2</span><span class=p>,</span> <span class=n>t3</span><span class=p>,</span> <span class=n>at</span><span class=p>;</span>
</code></pre></div><ul><li>å® <code>make_rtl_arith_logic</code> æ ¹æ®ç®—æœ¯è¿ç®—ç¬¦ååˆ›å»ºå¯¹åº” RTL åŸºæœ¬æŒ‡ä»¤å’Œ RTL æŒ‡ä»¤ï¼Œä½¿ç”¨äº† <code>include/util/c_op.h</code> ä¸­çš„è¿ç®—ã€‚<ul><li>32ä½å¯„å­˜å™¨-å¯„å­˜å™¨ç±»å‹çš„ç®—æœ¯/é€»è¾‘è¿ç®—</li><li>32ä½å¯„å­˜å™¨-ç«‹å³æ•°ç±»å‹çš„ç®—æœ¯/é€»è¾‘è¿ç®—</li></ul></li><li>å®šä¹‰å‡½æ•° <code>decoding_set_jmp(bool is_jmp)</code> ï¼šå°† å½“å‰æŒ‡ä»¤æ ‡è®°ä¸ºè·³è½¬ï¼ˆæ ‡è®° <code>decoing.is_jmp</code>ï¼‰</li><li>å®šä¹‰å‡½æ•° <code>interpret_relop</code> ï¼šå®ç°ä¸¤ä¸ªå€¼çš„å…³ç³»è¿ç®—ï¼Œè¿”å›ç»“æœï¼ˆå®ç°åœ¨ <code>src/cpu/exec/relop.c</code></li></ul><h4 id=rtl-åŸºæœ¬æŒ‡ä»¤>RTL åŸºæœ¬æŒ‡ä»¤</h4><p>ç‰¹ç‚¹ï¼šä¸éœ€è¦ä½¿ç”¨ä¸´æ—¶å¯„å­˜å™¨, å¯ä»¥çœ‹åšæ˜¯æœ€åŸºæœ¬çš„x86æŒ‡ä»¤ä¸­çš„æœ€åŸºæœ¬çš„æ“ä½œã€‚
å®ç°æ—¶æ·»åŠ äº† <code>interpret_</code> å‰ç¼€ï¼Œä½†åœ¨ <code>include/cpu/rtl-wrapper.h</code> ä½œç”¨ä¸‹ï¼Œå…¶å®ƒä»£ç ä¸­ä½¿ç”¨åˆ°è¿™äº›RTLåŸºæœ¬æŒ‡ä»¤æ—¶ä¼šè‡ªåŠ¨æ·»åŠ  <code>interpret_</code> å‰ç¼€ã€‚</p><ul><li>ç«‹å³æ•°è¯»å…¥ <code>rtl_li</code></li><li>å¯„å­˜å™¨ä¼ è¾“ <code>rtl_mv</code></li><li>32ä½å¯„å­˜å™¨-å¯„å­˜å™¨ç±»å‹çš„ç®—æœ¯/é€»è¾‘è¿ç®—, åŒ…æ‹¬ <code>rtl_(add|sub|and|or|xor|shl|shr|sar|i?mul_[lo|hi]|i?div_[q|r])</code> , è¿™äº›è¿ç®—çš„å®šä¹‰ç”¨åˆ° <code>include/util/c_op.h</code> ä¸­çš„Cè¯­è¨€è¿ç®—</li><li>è¢«é™¤æ•°ä¸º64ä½çš„é™¤æ³•è¿ç®— <code>rtl_i?div64_[q|r]</code></li><li>guestå†…å­˜è®¿é—® <code>rtl_lm</code> å’Œ <code>rtl_sm</code></li><li>hostå†…å­˜è®¿é—® <code>rtl_host_lm</code> å’Œ <code>rtl_host_sm</code></li><li>å…³ç³»è¿ç®— <code>rtl_setrelop</code>, å…·ä½“å¯å‚è€ƒ <code>src/cpu/exec/relop.c</code></li><li>è·³è½¬, åŒ…æ‹¬ç›´æ¥è·³è½¬ <code>rtl_j</code> , é—´æ¥è·³è½¬ <code>rtl_jr</code> å’Œæ¡ä»¶è·³è½¬ <code>rtl_jrelop</code></li><li>ç»ˆæ­¢ç¨‹åº <code>rtl_exit</code></li></ul><p>å…·ä½“å£°æ˜ï¼š</p><ul><li>æœªæ ‡æ˜åˆ™å‡½æ•°ä¿®é¥°ç¬¦å‡ä¸º <code>static inline</code>ã€‚</li></ul><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=c1>// ç«‹å³æ•°è¯»å…¥
</span><span class=c1></span><span class=kt>void</span> <span class=nf>interpret_rtl_li</span><span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=n>uint32_t</span> <span class=n>imm</span><span class=p>);</span>

<span class=c1>// å¯„å­˜å™¨ä¼ è¾“
</span><span class=c1></span><span class=kt>void</span> <span class=nf>interpret_rtl_mv</span><span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>src1</span><span class=p>);</span>

<span class=c1>// 32ä½å¯„å­˜å™¨-å¯„å­˜å™¨ç±»å‹çš„ç®—æœ¯/é€»è¾‘è¿ç®—
</span><span class=c1></span><span class=kt>void</span> <span class=nf>interpret_rtl_add</span> <span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src1</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src2</span><span class=p>);</span>

<span class=c1>// è¢«é™¤æ•°ä¸º64ä½çš„é™¤æ³•è¿ç®—
</span><span class=c1></span><span class=kt>void</span> <span class=nf>interpret_rtl_div64_q</span><span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span>
    <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src1_hi</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src1_lo</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src2</span><span class=p>);</span>

<span class=c1>// guestå†…å­˜è®¿é—®
</span><span class=c1></span><span class=kt>void</span> <span class=nf>interpret_rtl_lm</span><span class=p>(</span><span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>interpret_rtl_sm</span><span class=p>(</span><span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>addr</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src1</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>);</span>

<span class=c1>// hostå†…å­˜è®¿é—®
</span><span class=c1></span><span class=kt>void</span> <span class=nf>interpret_rtl_host_lm</span><span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>addr</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>interpret_rtl_host_sm</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>addr</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>src1</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>);</span>

<span class=c1>// å…³ç³»è¿ç®—
</span><span class=c1></span><span class=kt>void</span> <span class=nf>interpret_rtl_setrelop</span><span class=p>(</span><span class=n>uint32_t</span> <span class=n>relop</span><span class=p>,</span> <span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>src1</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>src2</span><span class=p>);</span>

<span class=c1>// è·³è½¬
</span><span class=c1></span><span class=kt>void</span> <span class=nf>interpret_rtl_j</span><span class=p>(</span><span class=n>vaddr_t</span> <span class=n>target</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>interpret_rtl_jr</span><span class=p>(</span><span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>target</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>interpret_rtl_jrelop</span><span class=p>(</span><span class=n>uint32_t</span> <span class=n>relop</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>src1</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>src2</span><span class=p>,</span> <span class=n>vaddr_t</span> <span class=n>target</span><span class=p>);</span>

<span class=c1>// ç»ˆæ­¢ç¨‹åº
</span><span class=c1></span><span class=kt>void</span> <span class=nf>interpret_rtl_exit</span><span class=p>(</span><span class=kt>int</span> <span class=n>state</span><span class=p>);</span>
</code></pre></div><h4 id=rtl-ä¼ªæŒ‡ä»¤>RTL ä¼ªæŒ‡ä»¤</h4><p>é€šè¿‡RTLåŸºæœ¬æŒ‡ä»¤æˆ–è€…å·²ç»å®ç°çš„RTLä¼ªæŒ‡ä»¤æ¥å®ç°ã€‚</p><ul><li>32ä½å¯„å­˜å™¨-ç«‹å³æ•°ç±»å‹çš„ç®—æœ¯/é€»è¾‘è¿ç®—, åŒ…æ‹¬ <code>rtl_(add|sub|and|or|xor|shl|shr|sar|i?mul_[lo|hi]|i?div_[q|r])_i</code></li><li>é€šç”¨å¯„å­˜å™¨è®¿é—® <code>rtl_lr</code> å’Œ <code>rtl_sr</code></li><li>EFLAGSæ ‡å¿—ä½çš„è¯»å†™ <code>rtl_set_(CF|OF|ZF|SF)</code> å’Œ <code>rtl_get_(CF|OF|ZF|SF)</code></li><li>å…¶å®ƒå¸¸ç”¨åŠŸèƒ½, å¦‚æŒ‰ä½å–å <code>rtl_not</code> ï¼Œç¬¦å·æ‰©å±• <code>rtl_sext</code> ç­‰</li></ul><p>å…·ä½“å£°æ˜ï¼š</p><ul><li>æœªæ ‡æ˜åˆ™å‡½æ•°ä¿®é¥°ç¬¦å‡ä¸º <code>static inline</code>ã€‚</li><li>å® <code>make_rtl_setget_eflags</code> å£°æ˜äº†éœ€è¦å®ç°çš„ EFLAGSæ ‡å¿—ä½çš„è¯»å†™ æŒ‡ä»¤<ul><li><code>rtl_set_name</code></li><li><code>rtl_get_name</code></li></ul></li></ul><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=c1>// 32ä½å¯„å­˜å™¨-ç«‹å³æ•°ç±»å‹çš„ç®—æœ¯/é€»è¾‘è¿ç®—
</span><span class=c1></span><span class=kt>void</span> <span class=nf>rtl_addi</span> <span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src1</span><span class=p>,</span> <span class=kt>int</span> <span class=n>imm</span><span class=p>)</span>

<span class=c1>// é€šç”¨å¯„å­˜å™¨è®¿é—®
</span><span class=c1></span><span class=kt>void</span> <span class=n>rtl_lr</span><span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=kt>int</span> <span class=n>r</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>rtl_sr</span><span class=p>(</span><span class=kt>int</span> <span class=n>r</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src1</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>);</span>

<span class=c1>// EFLAGSæ ‡å¿—ä½çš„è¯»å†™
</span><span class=c1></span><span class=kt>void</span> <span class=nf>rtl_set_CF</span> <span class=p>(</span><span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>rtl_get_CF</span> <span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>rtl_set_OF</span> <span class=p>(</span><span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>rtl_get_OF</span> <span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>rtl_set_ZF</span> <span class=p>(</span><span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>rtl_get_ZF</span> <span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>rtl_set_SF</span> <span class=p>(</span><span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>rtl_get_SF</span> <span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>);</span>

<span class=c1>// æ ¹æ®è¿ç®—ç»“æ„æ›´æ–° ZF, SF æ ‡å¿—ä½
</span><span class=c1></span><span class=kt>void</span> <span class=nf>rtl_update_ZF</span><span class=p>(</span><span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>result</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>rtl_update_SF</span><span class=p>(</span><span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>result</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>rtl_update_ZFSF</span><span class=p>(</span><span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>result</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>);</span>

<span class=c1>// æŒ‰ä½å–å
</span><span class=c1></span><span class=kt>void</span> <span class=nf>rtl_not</span><span class=p>(</span><span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src1</span><span class=p>);</span>

<span class=c1>// ç¬¦å·æ‰©å±•
</span><span class=c1></span><span class=kt>void</span> <span class=nf>rtl_sext</span><span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src1</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>);</span>

<span class=c1>// å‹æ ˆ
</span><span class=c1></span><span class=kt>void</span> <span class=nf>rtl_push</span><span class=p>(</span><span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src1</span><span class=p>);</span>

<span class=c1>// å¼¹æ ˆ
</span><span class=c1></span><span class=kt>void</span> <span class=nf>rtl_pop</span><span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>);</span>

<span class=c1>// 32ä½å¯„å­˜å™¨-ç«‹å³æ•°ç±»å‹ å…³ç³»è¿ç®—
</span><span class=c1></span><span class=kt>void</span> <span class=nf>rtl_setrelopi</span><span class=p>(</span><span class=n>uint32_t</span> <span class=n>relop</span><span class=p>,</span> <span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span> <span class=o>*</span><span class=n>src1</span><span class=p>,</span> <span class=kt>int</span> <span class=n>imm</span><span class=p>);</span>

<span class=c1>// å–ç¬¦å·ä½ï¼ˆæœ€é«˜ä½ï¼‰
</span><span class=c1></span><span class=kt>void</span> <span class=nf>rtl_msb</span><span class=p>(</span><span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=n>rtlreg_t</span><span class=o>*</span> <span class=n>src1</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>);</span>
</code></pre></div><p>æˆ‘ä»¬å®šä¹‰RTLåŸºæœ¬æŒ‡ä»¤çš„æ—¶å€™, çº¦å®šäº†RTLåŸºæœ¬æŒ‡ä»¤ä¸éœ€è¦ä½¿ç”¨RTLä¸´æ—¶å¯„å­˜å™¨. ä½†æŸäº›RTLä¼ªæŒ‡ä»¤éœ€è¦ä½¿ç”¨ä¸´æ—¶å¯„å­˜å™¨å­˜æ”¾ä¸­é—´ç»“æœ, æ‰èƒ½å®ç°å…¶å®Œæ•´åŠŸèƒ½. è¿™æ ·å¯èƒ½ä¼šå¸¦æ¥å¯„å­˜å™¨è¦†ç›–çš„é—®é¢˜, ä¾‹å¦‚å¦‚ä¸‹RTLæŒ‡ä»¤åºåˆ—:</p><pre><code>(1) rtl_mv(&amp;t0, &amp;t1);
(2) rtl_sext(&amp;t1, &amp;t2, 1);  // use t0 temporarily
(3) rtl_add(&amp;t2, &amp;t0, &amp;t1);
</code></pre><p>å¦‚æœå®ç°(2)çš„æ—¶å€™æ°å¥½ä½¿ç”¨åˆ°äº†t0ä½œä¸ºä¸´æ—¶å¯„å­˜å™¨, åœ¨(3)ä¸­ä½¿ç”¨çš„t0å°±ä¸å†æ˜¯(1)çš„ç»“æœäº†, ä»è€Œäº§ç”Ÿéé¢„æœŸçš„ç»“æœ.</p><p>ä¸ºäº†å°½å¯èƒ½é¿å…ä¸Šè¿°é—®é¢˜, æˆ‘ä»¬æœ‰ä¸¤æ¡çº¦å®š:</p><ul><li>å®ç°RTLä¼ªæŒ‡ä»¤çš„æ—¶å€™, å°½å¯èƒ½ä¸ä½¿ç”¨ <code>dest</code> ä¹‹å¤–çš„å¯„å­˜å™¨å­˜æ”¾ä¸­é—´ç»“æœ. ç”±äº <code>dest</code> æœ€åä¼šè¢«å†™å…¥æ–°å€¼, å…¶æ—§å€¼è‚¯å®šè¦è¢«è¦†ç›–, è‡ªç„¶ä¹Ÿå¯ä»¥å®‰å…¨åœ°ä½œä¸ºRTLä¼ªæŒ‡ä»¤çš„ä¸´æ—¶å¯„å­˜å™¨.</li><li>å®åœ¨éœ€è¦ä½¿ç”¨ä¸´æ—¶å¯„å­˜å™¨çš„æ—¶å€™, ä½¿ç”¨ <code>at</code> . <code>at</code> å…¨ç§°æ˜¯assembly temporary, æ˜¯MIPS ABIä¸­å®šä¹‰çš„ä¸€ä¸ªç‰¹æ®Šå¯„å­˜å™¨: ç¼–è¯‘å™¨å¹¶ä¸ä¼šä½¿ç”¨å®ƒ, å®ƒå¯ä»¥åœ¨ç¼–å†™æ±‡ç¼–ä»£ç çš„æ—¶å€™å®‰å…¨åœ°ä½œä¸ºå¯ä½¿ç”¨çš„ä¸´æ—¶å¯„å­˜å™¨. åœ¨è¿™é‡Œï¼Œ æˆ‘ä»¬å€Ÿé‰´å®ƒçš„åŠŸèƒ½æ¥ä½œå¦‚ä¸‹çº¦å®š: ä¸è¦åœ¨RTLä¼ªæŒ‡ä»¤çš„å†…éƒ¨å®ç°ä¹‹å¤–ä½¿ç”¨ <code>at</code> . è¿™æ ·ï¼Œ <code>at</code> å°±å¯ä»¥å®‰å…¨åœ°ä½œä¸ºRTLä¼ªæŒ‡ä»¤çš„ä¸´æ—¶å¯„å­˜å™¨äº†.</li></ul><h3 id=rtl-wrapperh>rtl-wrapper.h</h3><p>ä¸º rtl.h ä¸­å®šä¹‰çš„ RTL åŸºæœ¬æŒ‡ä»¤çš„è°ƒç”¨çœå» <code>interpret_</code> å‰ç¼€ã€‚</p><h2 id=memory>memory/</h2><h3 id=memoryh>memory.h</h3><p>å®šä¹‰äº†è®¿é—®å†…å­˜çš„å‡½æ•°ã€‚ä½¿ç”¨æ•°ç»„ <code>pmem</code> æ¨¡æ‹Ÿå†…å­˜ã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>extern</span> <span class=n>uint8_t</span> <span class=n>pmem</span><span class=p>[];</span>
</code></pre></div><table><thead><tr><th>å‡½æ•°/å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>uint32_t vaddr_read(vaddr_t, int)</code></td><td>ä»è™šæ‹Ÿå†…å­˜æŒ‡å®šä½ç½®è¯»å–æŒ‡å®šæ•°ç›®ä¸ªå­—èŠ‚</td></tr><tr><td><code>void vaddr_write(vaddr_t, uint32_t, int)</code></td><td>å‘è™šæ‹Ÿå†…å­˜æŒ‡å®šä½ç½®å†™å…¥æŒ‡å®šæ•°ç›®ä¸ªå­—èŠ‚</td></tr><tr><td><code>uint32_t paddr_read(paddr_t, int)</code></td><td>ä»ç‰©ç†å†…å­˜æŒ‡å®šä½ç½®è¯»å–æŒ‡å®šæ•°ç›®ä¸ªå­—èŠ‚</td></tr><tr><td><code>void paddr_write(paddr_t, uint32_t, int)</code></td><td>å‘ç‰©ç†å†…å­˜æŒ‡å®šä½ç½®å†™å…¥æŒ‡å®šæ•°ç›®ä¸ªå­—èŠ‚</td></tr><tr><td><code>guest_to_host(p)</code></td><td><code>((void *)(pmem + (unsigned)p))</code></td></tr><tr><td><code>host_to_guest(p)</code></td><td><code>((paddr_t)((void *)p - (void *)pmem))</code></td></tr></tbody></table><h3 id=mmuh>mmu.h</h3><p>(TODO)</p><h4 id=ç»“æ„ä½“-gatedesc>ç»“æ„ä½“ GateDesc</h4><p>æŒ‡ç¤ºä¸­æ–­æ“ä½œçš„é—¨æè¿°ç¬¦(Gate Descriptor)ç±»å‹ã€‚é—¨æè¿°ç¬¦æ˜¯ä¸€ä¸ª8å­—èŠ‚çš„ç»“æ„ä½“, é‡Œé¢åŒ…å«ç€ä¸å°‘ç»†èŠ‚çš„ä¿¡æ¯, åœ¨NEMUä¸­ç®€åŒ–äº†é—¨æè¿°ç¬¦çš„ç»“æ„, åªä¿ç•™å­˜åœ¨ä½På’Œåç§»é‡OFFSETã€‚</p><pre><code>   31                23                15                7                0
  +-----------------+-----------------+---+-------------------------------+
  |           OFFSET 31..16           | P |          Don't care           |4
  +-----------------------------------+---+-------------------------------+
  |             Don't care            |           OFFSET 15..0            |0
  +-----------------+-----------------+-----------------+-----------------+
</code></pre><p>åœ¨ <code>raise_intr</code>ï¼ˆå®šä¹‰åœ¨ <code>intr.c</code> ä¸­ï¼‰ä¸­ä½¿ç”¨ã€‚</p><table><thead><tr><th>æˆå‘˜</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>offset_15_0</code></td><td>Offset ä½ä½éƒ¨åˆ†</td></tr><tr><td><code>offset_31_16</code></td><td>Offset é«˜ä½éƒ¨åˆ†</td></tr><tr><td><code>present</code></td><td>æ ‡è¯†æ˜¯å¦æœ‰æ•ˆ</td></tr></tbody></table><ul><li>ä¸ºæ–¹ä¾¿ä»å†…å­˜ä¸­è¯»å–ï¼Œä½¿ç”¨ union ç»“æ„ä»¥åŠ <code>val0 val1</code> åŸŸç®€åŒ–è¯»å†™ã€‚</li><li>æ­¤ç»“æ„ä½“ä¸ AM ä¸­å®šä¹‰çš„ <code>GateDesc</code> ï¼ˆåœ¨ <code>arch/x86-nemu/include/x86.h</code> ä¸­ï¼‰ç»“æ„ç›¸åŒã€‚</li></ul><h2 id=device>device/</h2><h3 id=mmioh>mmio.h</h3><p>å¯¹å†…å­˜æ˜ å°„ I/O ç¼–å€æ–¹å¼çš„æ”¯æŒã€‚æ³¨æ„ï¼Œå†…å­˜æ˜ å°„ I/O çš„è¯»å†™å¹¶ä¸æ˜¯é¢å‘ CPU çš„ã€‚</p><blockquote><p>ç«¯å£æ˜ å°„I/OæŠŠç«¯å£å·ä½œä¸ºI/OæŒ‡ä»¤çš„ä¸€éƒ¨åˆ†, è¿™ç§æ–¹æ³•å¾ˆç®€å•, ä½†åŒæ—¶ä¹Ÿæ˜¯å®ƒæœ€å¤§çš„ç¼ºç‚¹. æŒ‡ä»¤é›†ä¸ºäº†å…¼å®¹å·²ç»å¼€å‘çš„ç¨‹åº, æ˜¯åªèƒ½æ·»åŠ ä½†ä¸èƒ½ä¿®æ”¹çš„. è¿™æ„å‘³ç€, ç«¯å£æ˜ å°„I/Oæ‰€èƒ½è®¿é—®çš„I/Oåœ°å€ç©ºé—´çš„å¤§å°, åœ¨è®¾è®¡I/OæŒ‡ä»¤çš„é‚£ä¸€åˆ»å°±å·²ç»å†³å®šä¸‹æ¥äº†. æ‰€è°“I/Oåœ°å€ç©ºé—´, å…¶å®å°±æ˜¯æ‰€æœ‰èƒ½è®¿é—®çš„è®¾å¤‡çš„åœ°å€çš„é›†åˆ. éšç€è®¾å¤‡è¶Šæ¥è¶Šå¤š, åŠŸèƒ½ä¹Ÿè¶Šæ¥è¶Šå¤æ‚, I/Oåœ°å€ç©ºé—´æœ‰é™çš„ç«¯å£æ˜ å°„I/Oå·²ç»é€æ¸ä¸èƒ½æ»¡è¶³éœ€æ±‚äº†. æœ‰çš„è®¾å¤‡éœ€è¦è®©CPUè®¿é—®ä¸€æ®µè¾ƒå¤§çš„è¿ç»­å­˜å‚¨ç©ºé—´, å¦‚VGAçš„æ˜¾å­˜, 24è‰²åŠ ä¸ŠAlphaé€šé“çš„1024x768åˆ†è¾¨ç‡çš„æ˜¾å­˜å°±éœ€è¦3MBçš„ç¼–å€èŒƒå›´. äºæ˜¯å†…å­˜æ˜ å°„I/O(memory-mapped I/O)åº”è¿è€Œç”Ÿ.
å†…å­˜æ˜ å°„I/Oè¿™ç§ç¼–å€æ–¹å¼éå¸¸å·§å¦™, å®ƒæ˜¯é€šè¿‡ä¸åŒçš„ç‰©ç†å†…å­˜åœ°å€ç»™è®¾å¤‡ç¼–å€çš„. è¿™ç§ç¼–å€æ–¹å¼å°†ä¸€éƒ¨åˆ†ç‰©ç†å†…å­˜"é‡å®šå‘"åˆ°I/Oåœ°å€ç©ºé—´ä¸­, CPUå°è¯•è®¿é—®è¿™éƒ¨åˆ†ç‰©ç†å†…å­˜çš„æ—¶å€™, å®é™…ä¸Šæœ€ç»ˆæ˜¯è®¿é—®äº†ç›¸åº”çš„I/Oè®¾å¤‡, CPUå´æµ‘ç„¶ä¸çŸ¥. è¿™æ ·ä»¥å, CPUå°±å¯ä»¥é€šè¿‡æ™®é€šçš„è®¿å­˜æŒ‡ä»¤æ¥è®¿é—®è®¾å¤‡. è¿™ä¹Ÿæ˜¯å†…å­˜æ˜ å°„I/Oå¾—å¤©ç‹¬åšçš„å¥½å¤„: ç‰©ç†å†…å­˜çš„åœ°å€ç©ºé—´å’ŒCPUçš„ä½å®½éƒ½ä¼šä¸æ–­å¢é•¿, å†…å­˜æ˜ å°„I/Oä»æ¥ä¸éœ€è¦æ‹…å¿ƒI/Oåœ°å€ç©ºé—´è€—å°½çš„é—®é¢˜. ä»åŸç†ä¸Šæ¥è¯´, å†…å­˜æ˜ å°„I/Oå”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯, CPUæ— æ³•é€šè¿‡æ­£å¸¸æ¸ é“ç›´æ¥è®¿é—®é‚£äº›è¢«æ˜ å°„åˆ°I/Oåœ°å€ç©ºé—´çš„ç‰©ç†å†…å­˜äº†. ä½†éšç€è®¡ç®—æœºçš„å‘å±•, å†…å­˜æ˜ å°„I/Oçš„å”¯ä¸€ç¼ºç‚¹å·²ç»è¶Šæ¥è¶Šä¸æ˜æ˜¾äº†: ç°ä»£è®¡ç®—æœºéƒ½å·²ç»æ˜¯64ä½è®¡ç®—æœº, ç‰©ç†åœ°å€çº¿éƒ½æœ‰48æ ¹, è¿™æ„å‘³ç€ç‰©ç†åœ°å€ç©ºé—´æœ‰256TBè¿™ä¹ˆå¤§, ä»é‡Œé¢åˆ’å‡º3MBçš„åœ°å€ç©ºé—´ç»™æ˜¾å­˜, æ ¹æœ¬å°±æ˜¯ä¸ç—›ä¸ç—’. æ­£å› ä¸ºå¦‚æ­¤, å†…å­˜æ˜ å°„I/Oæˆä¸ºäº†ç°ä»£è®¡ç®—æœºä¸»æµçš„I/Oç¼–å€æ–¹å¼: RISCæ¶æ„åªæä¾›å†…å­˜æ˜ å°„I/Oçš„ç¼–å€æ–¹å¼, è€ŒPCI-e, ç½‘å¡, x86çš„APICç­‰ä¸»æµè®¾å¤‡, éƒ½æ”¯æŒé€šè¿‡å†…å­˜æ˜ å°„I/Oæ¥è®¿é—®.</p></blockquote><blockquote><p>åœ¨ NEMU ä¸­ï¼Œ video memoryæ˜¯å”¯ä¸€ä½¿ç”¨å†…å­˜æ˜ å°„ I/O æ–¹å¼è®¿é—®çš„ I/O ç©ºé—´ã€‚</p></blockquote><p>å®šä¹‰äº†ç±»å‹ <code>mmio_callback_t</code> ï¼Œè®¾å¤‡å®šä¹‰çš„å›è°ƒå‡½æ•°ï¼Œç”¨ä»¥æ›´æ–°è®¾å¤‡çŠ¶æ€ã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=nf>void</span><span class=p>(</span><span class=o>*</span><span class=n>mmio_callback_t</span><span class=p>)(</span><span class=n>paddr_t</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>bool</span><span class=p>);</span>
</code></pre></div><table><thead><tr><th>å‡½æ•°</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>void* add_mmio_map(paddr_t, int, mmio_callback_t)</code></td><td>æ³¨å†Œä¸€ä¸ªå†…å­˜æ˜ å°„ I/O æ˜ å°„å…³ç³»ï¼Œè¿”å›è¯¥æ˜ å°„å…³ç³»çš„ I/O ç©ºé—´é¦–åœ°å€</td></tr><tr><td><code>int is_mmio(paddr_t)</code></td><td>åˆ¤æ–­ä¸€ä¸ªç‰©ç†åœ°å€æ˜¯å¦è¢«æ˜ å°„åˆ° I/O ç©ºé—´ï¼Œå¦‚æœæ˜¯ï¼Œè¿”å›æ˜ å°„å·, å¦åˆ™è¿”å› -1</td></tr><tr><td><code>uint32_t mmio_read(paddr_t, int, int)</code></td><td>æ ¹æ®ç«¯å£å·å’Œåœ°å€è¯»å–</td></tr><tr><td><code>void mmio_write(paddr_t, int, uint32_t, int)</code></td><td>æ ¹æ®ç«¯å£å·å’Œåœ°å€å†™å…¥</td></tr></tbody></table><h3 id=port-ioh>port-io.h</h3><p>å¯¹ç«¯å£æ˜ å°„ I/O ç¼–å€æ–¹å¼çš„æ”¯æŒã€‚ç«¯å£æ˜ å°„I/O(port-mapped I/O)ï¼Œ CPUä½¿ç”¨ä¸“é—¨çš„I/OæŒ‡ä»¤å¯¹è®¾å¤‡è¿›è¡Œè®¿é—®ï¼Œ å¹¶æŠŠè®¾å¤‡çš„åœ°å€ç§°ä½œç«¯å£å·ã€‚ æœ‰äº†ç«¯å£å·ä»¥åï¼Œ åœ¨I/OæŒ‡ä»¤ä¸­ç»™å‡ºç«¯å£å·ï¼Œ å°±çŸ¥é“è¦è®¿é—®å“ªä¸€ä¸ªè®¾å¤‡å¯„å­˜å™¨äº†ã€‚</p><p>å®šä¹‰äº†ç±»å‹ <code>pio_callback_t</code> ï¼Œè®¾å¤‡å®šä¹‰çš„å›è°ƒå‡½æ•°ï¼Œç”¨ä»¥æ›´æ–°è®¾å¤‡çŠ¶æ€ã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=nf>void</span><span class=p>(</span><span class=o>*</span><span class=n>pio_callback_t</span><span class=p>)(</span><span class=n>ioaddr_t</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>bool</span><span class=p>);</span>
</code></pre></div><table><thead><tr><th>å‡½æ•°</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>void* add_pio_map(paddr_t, int, mmio_callback_t)</code></td><td>æ³¨å†Œä¸€ä¸ªç«¯å£æ˜ å°„ I/O æ˜ å°„å…³ç³»ï¼Œè¿”å›è¯¥æ˜ å°„å…³ç³»çš„ I/O ç©ºé—´é¦–åœ°å€</td></tr><tr><td><code>uint32_t pio_read_[l,w,b](ioaddr_t)</code></td><td>é¢å‘ CPU çš„ç«¯å£ I/O è¯»æ¥å£</td></tr><tr><td><code>void pio_write_[l,w,b](ioaddr_t, uint32_t)</code></td><td>é¢å‘ CPU çš„ç«¯å£ I/O å†™æ¥å£</td></tr></tbody></table><h2 id=monitor>monitor/</h2><p>ç›‘è§†å™¨éƒ¨åˆ†ï¼ˆä¹ŸåŒ…å« NEMU æ‰§è¡Œä¸»å¾ªç¯ï¼‰ã€‚</p><h3 id=exprh>expr.h</h3><p>å®šä¹‰äº†è®¡ç®—è¡¨è¾¾å¼çš„å€¼çš„å‡½æ•° <code>expr</code>ã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>uint32_t</span> <span class=nf>expr</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>,</span> <span class=kt>bool</span> <span class=o>*</span><span class=p>);</span>
</code></pre></div><h3 id=monitorh>monitor.h</h3><p>å®šä¹‰äº† NEMU çŠ¶æ€ å˜é‡ <code>nemu_state</code>ï¼Œå’Œæšä¸¾å€¼ <code>NEMU_STOP, NEMU_RUNNING, NEMU_END, NEMU_ABORT</code>ã€‚
å®šä¹‰äº† åº”ç”¨ç¨‹åºå…¥å£ç‚¹ <code>ENTRY_START</code> ï¼š</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#define ENTRY_START 0x100000
</span></code></pre></div><h3 id=watchpointh>watchpoint.h</h3><h4 id=ç»“æ„ä½“-wp>ç»“æ„ä½“ WP</h4><p>ç›‘è§†ç‚¹ç»“æ„ã€‚é‡‡ç”¨é“¾è¡¨ç»“æ„å­˜å‚¨ã€‚</p><table><thead><tr><th>æˆå‘˜</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>NO</code></td><td>åºå·</td></tr><tr><td><code>next</code></td><td>ä¸‹ä¸€ç›‘è§†ç‚¹æŒ‡é’ˆ</td></tr><tr><td><code>expr</code></td><td>ç›‘è§†çš„è¡¨è¾¾å¼</td></tr><tr><td><code>lastVal</code></td><td>è¡¨è¾¾å¼æœ€è¿‘ä¸€æ¬¡çš„å€¼</td></tr></tbody></table><h2 id=util>util/</h2><h3 id=c_oph>c_op.h</h3><p>å®šä¹‰äº†ä¸€äº›å½¢å¦‚ <code>c_opname_type</code> çš„å®ï¼Œç”¨äºè¡¨ç¤ºåŸºç¡€ C è¿ç®—ã€‚åœ¨ RTLåŸºæœ¬æŒ‡ä»¤ä¸­çš„å¯„å­˜å™¨è¿ç®—æŒ‡ä»¤ä¸­ä½¿ç”¨ã€‚</p><h1 id=src>src/</h1><h2 id=mainc>main.c</h2><p>NEMU ä¸»ç¨‹åºã€‚</p><p>è°ƒç”¨ <code>init_monitor</code> ï¼ˆå®ç°åœ¨ <code>/src/monitor/monitor.c</code>ï¼‰åˆå§‹åŒ–ç›‘è§†å™¨ï¼Œå¹¶è·å–å½“å‰æ˜¯å¦ä¸ºæ‰¹å¤„ç†æ¨¡å¼ã€‚
è°ƒç”¨ <code>ui_mainloop</code> ï¼ˆå®ç°åœ¨ <code>/src/monitor/debug/ui.c</code>ï¼‰è¿›è¡ŒæŒ‡ä»¤æ‰§è¡Œæ¨¡æ‹Ÿã€‚</p><h2 id=cpu-1>cpu/</h2><h3 id=regc>reg.c</h3><p>å®ç°äº† <code>include/cpu/reg.h</code> ä¸­çš„ <code>regsl,regsw,regsb</code>ï¼ŒåŒæ—¶å®ç°å¯„å­˜å™¨å®é™…å®šä¹‰ï¼šå˜é‡ <code>cpu</code>ã€‚</p><ul><li>å‡½æ•° <code>reg_test</code>ï¼šæµ‹è¯•å¯„å­˜å™¨ç»“æ„å®šä¹‰ï¼ˆ<code>CPU_state</code>ï¼‰æ˜¯å¦æ­£ç¡®ã€‚</li></ul><h3 id=intrc>intr.c</h3><p>å‡½æ•° <code>void raise_intr(uint8_t NO, vaddr_t ret_addr)</code> ä¸º <code>int</code> æŒ‡ä»¤ï¼ˆåœ¨ <code>system.c</code> ä¸­å®ç°ï¼‰çš„å†…éƒ¨å®ç°ã€‚
å®ç°äº†è§¦å‘ä¸­æ–­æˆ–å¼‚å¸¸åçš„ç¡¬ä»¶å¤„ç†ï¼š</p><ol><li>ä¾æ¬¡å°†EFLAGS, CS(ä»£ç æ®µå¯„å­˜å™¨), EIPå¯„å­˜å™¨ï¼ˆè¿”å›åœ°å€ï¼‰çš„å€¼å‹å…¥å †æ ˆ</li><li>æ ¹æ®ä¸­æ–­ç ï¼Œä»IDTRä¸­è¯»å‡ºIDTçš„é¦–åœ°å€</li><li>æ ¹æ®å¼‚å¸¸å·åœ¨IDTä¸­è¿›è¡Œç´¢å¼•, æ‰¾åˆ°ä¸€ä¸ªé—¨æè¿°ç¬¦</li><li>å°†é—¨æè¿°ç¬¦ä¸­çš„offsetåŸŸç»„åˆæˆç›®æ ‡åœ°å€</li><li>è·³è½¬åˆ°ç›®æ ‡åœ°å€</li></ol><h3 id=decode>decode/</h3><p>æŒ‡ä»¤è¯‘ç ç›¸å…³ã€‚</p><h4 id=decodec>decode.c</h4><p>å®ç°äº† <code>include/cpu/decode.h</code> ä¸­çš„è¯‘ç å‡½æ•°æ—ï¼Œå‡½æ•° <code>operand_write</code> ä»¥åŠè¯‘ç ä¿¡æ¯å˜é‡ <code>decoding</code>ã€‚
å®ç°äº† <code>include/cpu/rtl.h</code> ä¸­çš„ä¸´æ—¶å¯„å­˜å™¨ <code>t0,t1,t2,t3,at</code> å’Œå‡½æ•° <code>decoding_set_jmp</code>ã€‚</p><h5 id=å®-make_dophelper-ä¸å‡½æ•°æ—-decode_op_name>å® make_DopHelper ä¸å‡½æ•°æ— decode_op_name</h5><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#define make_DopHelper(name) void concat(decode_op_, name) (vaddr_t *eip, Operand *op, bool load_val)
</span></code></pre></div><p>è¯‘ç å‡½æ•°ä¼šè¿›ä¸€æ­¥åˆ†è§£æˆå„ç§ä¸åŒæ“ä½œæ•°çš„è¯‘ç çš„ç»„åˆï¼Œä»¥å®ç°æ“ä½œæ•°è¯‘ç çš„è§£è€¦. æ“ä½œæ•°è¯‘ç å‡½æ•°ç»Ÿä¸€é€šè¿‡å® <code>make_DopHelper</code> æ¥å®šä¹‰ ï¼ˆ<code>decode_op_rm</code> é™¤å¤–ï¼‰ã€‚
æ“ä½œæ•°è¯‘ç å‡½æ•°ä¼šæŠŠæ“ä½œæ•°çš„ä¿¡æ¯è®°å½•åœ¨ç»“æ„ä½“ <code>op</code> ä¸­, å¦‚æœæ“ä½œæ•°åœ¨æŒ‡ä»¤ä¸­ï¼Œ å°±ä¼šé€šè¿‡ <code>instr_fetch()</code> å°†å®ƒä»¬ä» <code>eip</code> æ‰€æŒ‡å‘çš„å†…å­˜ä½ç½®å–å‡º. ä¸ºäº†ä½¿æ“ä½œæ•°è¯‘ç å‡½æ•°æ›´æ˜“äºå¤ç”¨ï¼Œ å‡½æ•°ä¸­çš„ <code>load_val</code> å‚æ•°ä¼šæ§åˆ¶ æ˜¯å¦éœ€è¦å°†è¯¥æ“ä½œæ•°è¯»å‡ºåˆ°å…¨å±€è¯‘ç ä¿¡æ¯ <code>decoding</code> ä¾›åç»­ä½¿ç”¨. ä¾‹å¦‚å¦‚æœä¸€ä¸ªå†…å­˜æ“ä½œæ•°æ˜¯æºæ“ä½œæ•°, å°±éœ€è¦å°†è¿™ä¸ªæ“ä½œæ•°ä»å†…å­˜ä¸­è¯»å‡ºæ¥ä¾›åç»­æ‰§è¡Œé˜¶æ®µæ¥ä½¿ç”¨ï¼› å¦‚æœå®ƒä»…ä»…æ˜¯ä¸€ä¸ªç›®çš„æ“ä½œæ•°ï¼Œ å°±ä¸éœ€è¦ä»å†…å­˜è¯»å‡ºå®ƒçš„å€¼äº†ï¼Œå› ä¸ºæ‰§è¡Œè¿™æ¡æŒ‡ä»¤å¹¶ä¸éœ€è¦è¿™ä¸ªå€¼ï¼Œ è€Œæ˜¯å°†æ–°æ•°æ®å†™å…¥ç›¸åº”çš„å†…å­˜ä½ç½®.</p><p><code>decode_op_name</code> å‡½æ•°æ—å‘½åè§„åˆ™å¯å‚è§ <code>decode_name</code> å‡½æ•°æ—å‘½åè§„åˆ™ã€‚</p><ul><li><code>decode_op_a</code> æ˜¯ä¸€ä¸ªç‰¹ä¾‹ï¼Œå…¶ç”¨äºå°†æ“ä½œæ•°æ ‡è®°ä¸ºå¯„å­˜å™¨ <code>ax</code> æˆ– <code>eax</code></li></ul><h4 id=modrmc>modrm.c</h4><p>å®ç°äº† <code>include/cpu/decode.h</code> ä¸­çš„å‡½æ•° <code>load_addr</code> å’Œ <code>read_ModR_M</code>ã€‚</p><h3 id=exec>exec/</h3><p>æŒ‡ä»¤æ‰§è¡Œç›¸å…³ã€‚</p><h4 id=ccc>cc.c</h4><p>å®ç°äº† <code>include/cpu/cc.h</code> ä¸­çš„å‡½æ•° <code>rtl_setcc</code>ã€‚æ ¹æ®æŒ‡å®šå…³ç³»è¿ç®—ä»¥åŠæ¡ä»¶æ ‡å¿—ä½è®¾ç½® destã€‚</p><h4 id=relopc>relop.c</h4><p>å®ç°äº† <code>include/cpu/relop.h</code> ä¸­çš„å‡½æ•° <code>interpret_relop</code>ï¼Œä½¿ç”¨ Cè¯­è¨€å…³ç³»è¿ç®—ç¬¦å®ç°å…³ç³»è¿ç®—ã€‚</p><h4 id=all-instrh>all-instr.h</h4><p>å®šä¹‰äº†å·²ç»å®ç°çš„æŒ‡ä»¤æ‰§è¡Œå‡½æ•°ï¼ˆåœ¨ <code>exec.c</code> ä¸­ä½¿ç”¨ï¼‰ã€‚</p><h4 id=arithc>arith.c</h4><p>ç®—æœ¯è¿ç®—æŒ‡ä»¤æ‰§è¡Œå‡½æ•°å®ç°ã€‚</p><table><thead><tr><th>æŒ‡ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>add</code></td><td></td></tr><tr><td><code>sub</code></td><td></td></tr><tr><td><code>cmp</code></td><td></td></tr><tr><td><code>inc</code></td><td></td></tr><tr><td><code>dec</code></td><td></td></tr><tr><td><code>neg</code></td><td></td></tr><tr><td><code>adc</code></td><td></td></tr><tr><td><code>sbb</code></td><td></td></tr><tr><td><code>mul</code></td><td></td></tr><tr><td><code>imul1</code></td><td>imul å•æ“ä½œæ•°</td></tr><tr><td><code>imul2</code></td><td>imul åŒæ“ä½œæ•°</td></tr><tr><td><code>imul3</code></td><td>imul ä¸‰æ“ä½œæ•°</td></tr><tr><td><code>div</code></td><td></td></tr><tr><td><code>idiv</code></td><td></td></tr></tbody></table><h4 id=controlc>control.c</h4><p>æ§åˆ¶æŒ‡ä»¤æ‰§è¡Œå‡½æ•°å®ç°ã€‚</p><table><thead><tr><th>æŒ‡ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>jmp</code></td><td>ç›´æ¥è·³è½¬</td></tr><tr><td><code>jmp_rm</code></td><td>é—´æ¥è·³è½¬</td></tr><tr><td><code>jcc</code></td><td>æ¡ä»¶è·³è½¬</td></tr><tr><td><code>call</code></td><td>ç›´æ¥è°ƒç”¨</td></tr><tr><td><code>call_rm</code></td><td>é—´æ¥è°ƒç”¨</td></tr><tr><td><code>ret</code></td><td></td></tr></tbody></table><h4 id=data-movc>data-mov.c</h4><p>æ•°æ®ç§»åŠ¨æŒ‡ä»¤æ‰§è¡Œå‡½æ•°å®ç°ã€‚</p><table><thead><tr><th>æŒ‡ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>mov</code></td><td></td></tr><tr><td><code>movsx</code></td><td></td></tr><tr><td><code>movzx</code></td><td></td></tr><tr><td><code>lea</code></td><td></td></tr><tr><td><code>push</code></td><td></td></tr><tr><td><code>pop</code></td><td></td></tr><tr><td><code>pusha</code></td><td></td></tr><tr><td><code>popa</code></td><td></td></tr><tr><td><code>leave</code></td><td></td></tr><tr><td><code>cltd</code></td><td></td></tr><tr><td><code>cwtl</code></td><td></td></tr></tbody></table><h4 id=logicc>logic.c</h4><p>é€»è¾‘è¿ç®—æŒ‡ä»¤æ‰§è¡Œå‡½æ•°å®ç°ã€‚</p><table><thead><tr><th>æŒ‡ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>test</code></td><td></td></tr><tr><td><code>and</code></td><td></td></tr><tr><td><code>xor</code></td><td></td></tr><tr><td><code>or</code></td><td></td></tr><tr><td><code>sar</code></td><td></td></tr><tr><td><code>shl</code></td><td></td></tr><tr><td><code>shr</code></td><td></td></tr><tr><td><code>setcc</code></td><td></td></tr><tr><td><code>not</code></td><td></td></tr><tr><td><code>rol</code></td><td></td></tr><tr><td><code>ror</code></td><td></td></tr></tbody></table><h4 id=specialc>special.c</h4><p>ç‰¹æ®ŠæŒ‡ä»¤æ‰§è¡Œå‡½æ•°å®ç°ã€‚</p><p>å®ç°äº† <code>include/cpu/rtl.h</code> ä¸­çš„å‡½æ•° <code>interpret_rtl_exit</code>ã€‚</p><table><thead><tr><th>æŒ‡ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>nop</code></td><td></td></tr><tr><td><code>inv</code></td><td>éæ³•æŒ‡ä»¤</td></tr><tr><td><code>nemu_trap</code></td><td>ç»“æŸæ‰§è¡Œ</td></tr></tbody></table><h4 id=prefixc>prefix.c</h4><p>å®šä¹‰äº†æ‰§è¡Œå‡½æ•° <code>exec_real</code>ã€‚
å®šä¹‰å¹¶å®ç°äº†æ‰§è¡Œå‡½æ•° <code>exec_operand_size</code>ã€‚</p><ul><li><code>exec_operand_size</code> ä»¥ 16 ä½æ“ä½œæ•°æ‰§è¡ŒæŒ‡ä»¤ï¼ˆæ ‡è®° <code>decoding.is_operand_size_16</code>ï¼‰</li></ul><h4 id=systemc>system.c</h4><p>ç³»ç»Ÿç›¸å…³æŒ‡ä»¤å®ç°ã€‚</p><table><thead><tr><th>æŒ‡ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>lidt</code></td><td>è®¾ç½® IDTR å¯„å­˜å™¨</td></tr><tr><td><code>mov_r2cr</code></td><td></td></tr><tr><td><code>mov_cr2r</code></td><td></td></tr><tr><td><code>int</code></td><td>æ ¹æ®ä¸­æ–­ç è¿›è¡Œä¸­æ–­è·³è½¬</td></tr><tr><td><code>iret</code></td><td>ä»ä¸­æ–­è·³è½¬è¿”å›</td></tr><tr><td><code>in</code></td><td>è¯»å–ç«¯å£æ˜ å°„ I/O</td></tr><tr><td><code>out</code></td><td>å†™å…¥ç«¯å£æ˜ å°„ I/O</td></tr></tbody></table><ul><li>x86 æä¾›äº† in å’Œ out æŒ‡ä»¤ç”¨äºè®¿é—®è®¾å¤‡ï¼Œå…¶ä¸­ in æŒ‡ä»¤ç”¨äºå°†è®¾å¤‡å¯„å­˜å™¨ä¸­çš„æ•°æ®ä¼ è¾“åˆ° CPU å¯„å­˜å™¨ä¸­ï¼Œout æŒ‡ä»¤ç”¨äºå°† CPU å¯„å­˜å™¨ä¸­çš„æ•°æ®ä¼ é€åˆ°è®¾å¤‡å¯„å­˜å™¨ä¸­</li></ul><h4 id=execc>exec.c</h4><p>æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹æ ¸å¿ƒå®ç°ã€‚</p><h5 id=ç»“æ„ä½“-opcode_entry>ç»“æ„ä½“ opcode_entry</h5><p>è¯‘ç æŸ¥æ‰¾è¡¨ä¸­å…ƒç´ ã€‚</p><table><thead><tr><th>æˆå‘˜</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>DHelper decode</code></td><td>è¯‘ç å‡½æ•°æŒ‡é’ˆ</td></tr><tr><td><code>EHelper execute</code></td><td>æ‰§è¡Œå‡½æ•°æŒ‡é’ˆ</td></tr><tr><td><code>width</code></td><td>æŒ‡ä»¤å®½åº¦</td></tr></tbody></table><h5 id=æ•°ç»„-opcode_table>æ•°ç»„ opcode_table</h5><p>è¯‘ç è¡¨ã€‚æŒ‰æŒ‡ä»¤ç¬¬ä¸€ä¸ªå­—èŠ‚ç´¢å¼•å­˜æ”¾ã€‚åˆ†ä¸¤æ®µï¼šå•å­—èŠ‚æŒ‡ä»¤ç å’ŒåŒå­—èŠ‚æŒ‡ä»¤ç ã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>opcode_entry</span> <span class=n>opcode_table</span> <span class=p>[</span><span class=mi>512</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
  <span class=cm>/* 0x00 */</span>	<span class=n>EMPTY</span><span class=p>,</span> <span class=n>EMPTY</span><span class=p>,</span> <span class=n>EMPTY</span><span class=p>,</span> <span class=n>EMPTY</span><span class=p>,</span>
  <span class=cm>/* 0x04 */</span>	<span class=n>EMPTY</span><span class=p>,</span> <span class=n>EMPTY</span><span class=p>,</span> <span class=n>EMPTY</span><span class=p>,</span> <span class=n>EMPTY</span><span class=p>,</span>
  <span class=cm>/* 0x08 */</span>	<span class=n>EMPTY</span><span class=p>,</span> <span class=n>EMPTY</span><span class=p>,</span> <span class=n>EMPTY</span><span class=p>,</span> <span class=n>EMPTY</span><span class=p>,</span>
  <span class=p>...</span>
<span class=p>};</span>
</code></pre></div><table><thead><tr><th>å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>IDEXW(id, ex, w)</code></td><td>æ ¹æ®è¯‘ç å‡½æ•°åï¼Œæ‰§è¡Œå‡½æ•°åï¼Œå®½åº¦ç”Ÿæˆ <code>opcode_entry</code></td></tr><tr><td><code>IDEX(id, ex)</code></td><td>æ ¹æ®è¯‘ç å‡½æ•°åï¼Œæ‰§è¡Œå‡½æ•°åï¼Œä»¥å®½åº¦ 0 ç”Ÿæˆ <code>opcode_entry</code></td></tr><tr><td><code>EXW(ex, w)</code></td><td>æ ¹æ®æ‰§è¡Œå‡½æ•°åï¼Œå®½åº¦ï¼Œç”Ÿæˆæ— è¯‘ç å‡½æ•°çš„ <code>opcode_entry</code></td></tr><tr><td><code>EX(ex)</code></td><td>æ ¹æ®æ‰§è¡Œå‡½æ•°åï¼Œç”Ÿæˆå®½åº¦ä¸º 0 ä¸”æ— è¯‘ç å‡½æ•°çš„ <code>opcode_entry</code></td></tr><tr><td><code>EMPTY</code></td><td>æœªå®ç°çš„å‘½ä»¤ï¼Œä½¿ç”¨ <code>exec_inv</code>ï¼ˆå®šä¹‰åœ¨ <code>special.c</code> ä¸­ï¼‰ æ„é€  <code>opcode_entry</code></td></tr><tr><td><code>make_group(name, item0, item1, item2, item3, item4, item5, item6, item7)</code></td><td>ç”¨äºå®ç° <code>sub /5</code> è¿™ç§æ ¹æ®ç¬¬äºŒä¸ªæŒ‡ä»¤ç  <code>/5</code> åŒºåˆ†ä¸åŒæŒ‡ä»¤çš„æƒ…å†µã€‚ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª <code>exec_name</code> çš„ç»Ÿä¸€æ‰§è¡Œå‡½æ•°ï¼Œå¹¶æ ¹æ® <code>decoding.ext_opcode</code> åˆ†é…åˆ°æŒ‡å®šæ‰§è¡Œå‡½æ•°ã€‚</td></tr></tbody></table><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#define IDEXW(id, ex, w)   {concat(decode_, id), concat(exec_, ex), w}
</span><span class=cp>#define IDEX(id, ex)       IDEXW(id, ex, 0)
</span><span class=cp>#define EXW(ex, w)         {NULL, concat(exec_, ex), w}
</span><span class=cp>#define EX(ex)             EXW(ex, 0)
</span><span class=cp>#define EMPTY              EX(inv)
</span><span class=cp></span>
<span class=cp>#define make_group(name, item0, item1, item2, item3, item4, item5, item6, item7) \
</span><span class=cp>  static opcode_entry concat(opcode_table_, name) [8] = { \
</span><span class=cp>    </span><span class=cm>/* 0x00 */</span><span class=cp>	item0, item1, item2, item3, \
</span><span class=cp>    </span><span class=cm>/* 0x04 */</span><span class=cp>	item4, item5, item6, item7  \
</span><span class=cp>  }; \
</span><span class=cp>static make_EHelper(name) { \
</span><span class=cp>  idex(eip, &amp;concat(opcode_table_, name)[decoding.ext_opcode]); \
</span><span class=cp>}
</span></code></pre></div><p>ä½¿ç”¨ <code>make_group</code> å®å®šä¹‰äº†ä¸€äº›ç»„ <code>gp1</code> - <code>gp7</code>ã€‚å¯¹åº”äº 80386 æ‰‹å†Œé™„å½•ä¸­ç»„çš„åˆ’åˆ†ã€‚</p><h5 id=å‡½æ•°-exec_wrapper>å‡½æ•° exec_wrapper</h5><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>exec_wrapper</span><span class=p>(</span><span class=kt>bool</span> <span class=n>print_flag</span><span class=p>);</span>
</code></pre></div><p>æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p><ul><li>é¦–å…ˆå°†å½“å‰çš„ <code>%eip</code> ä¿å­˜åˆ°å…¨å±€è¯‘ç ä¿¡æ¯ <code>decoding</code> çš„æˆå‘˜ <code>seq_eip</code> ä¸­</li><li>ç„¶åå°†å…¶åœ°å€è¢«ä½œä¸ºå‚æ•°é€è¿› <code>exec_real()</code> å‡½æ•°ä¸­<ul><li><code>seq</code> ä»£è¡¨é¡ºåºçš„æ„æ€, å½“ä»£ç ä» <code>exec_real()</code> è¿”å›æ—¶ï¼Œ<code>decoding.seq_eip</code> å°†ä¼šæŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€.</li></ul></li><li>è°ƒç”¨ <code>update_eip</code> æ›´æ–° <code>%eip</code></li><li>è°ƒè¯•æ¨¡å¼ä¸‹<ul><li>è®°å½•æ—¥å¿—ï¼ˆæŒ‡ä»¤å†…å®¹ä»¥åŠç›¸å…³ä¿¡æ¯ï¼‰</li><li>è‹¥ <code>print_flag</code> ä¸ºçœŸï¼Œåˆ™æ˜¾ç¤º <code>decoding.asm_buf</code></li></ul></li></ul><h5 id=å‡½æ•°-exec_real>å‡½æ•° exec_real</h5><ul><li>é¦–å…ˆé€šè¿‡ <code>instr_fetch()</code> å‡½æ•°(åœ¨ <code>include/cpu/exec.h</code> ä¸­å®šä¹‰)è¿›è¡Œå–æŒ‡ï¼Œ å¾—åˆ°æŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚, å°†å…¶è§£é‡Šæˆ <code>opcode</code> å¹¶è®°å½•åœ¨å…¨å±€è¯‘ç ä¿¡æ¯ <code>decoding</code> ä¸­.</li><li>æ ¹æ® <code>opcode</code> æŸ¥é˜…è¯‘ç æŸ¥æ‰¾è¡¨ï¼Œå¾—åˆ°æ“ä½œæ•°çš„å®½åº¦ä¿¡æ¯ï¼Œå¹¶é€šè¿‡è°ƒç”¨ <code>set_width()</code> å‡½æ•°å°†å…¶è®°å½•åœ¨å…¨å±€è¯‘ç ä¿¡æ¯ <code>decoding</code> ä¸­</li><li>è°ƒç”¨ <code>idex()</code> å¯¹æŒ‡ä»¤è¿›è¡Œè¿›ä¸€æ­¥çš„è¯‘ç å’Œæ‰§è¡Œ</li></ul><h5 id=å‡½æ•°-set_width>å‡½æ•° set_width</h5><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>set_width</span><span class=p>(</span><span class=kt>int</span> <span class=n>width</span><span class=p>);</span>
</code></pre></div><p>æ ¹æ®æŒ‡ä»¤å®šä¹‰å®½åº¦ï¼ˆ<code>opcode_entry.width</code>ï¼‰æŒ‡å®šæ‰€æœ‰æ“ä½œæ•°å®½åº¦ï¼ˆ<code>decoding.src.width</code>ï¼‰ã€‚</p><ul><li>å¦‚æœå®šä¹‰å®½åº¦ä¸º 0ï¼Œåˆ™é‡‡ç”¨è¯‘ç ç»“æœï¼ˆ<code>decoding.is_operand_size_16</code>ï¼‰</li></ul><h5 id=å‡½æ•°-idex>å‡½æ•° idex</h5><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cm>/* Instruction Decode and EXecute */</span>
<span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>idex</span><span class=p>(</span><span class=n>vaddr_t</span> <span class=o>*</span><span class=n>eip</span><span class=p>,</span> <span class=n>opcode_entry</span> <span class=o>*</span><span class=n>e</span><span class=p>);</span>
</code></pre></div><p>è°ƒç”¨è¯‘ç æŸ¥æ‰¾è¡¨ä¸­çš„ç›¸åº”çš„è¯‘ç å‡½æ•°ï¼ˆè‹¥å­˜åœ¨ï¼‰è¿›è¡Œæ“ä½œæ•°çš„è¯‘ç ï¼Œè¯‘ç è¿‡ç¨‹ç»“æŸä¹‹å, ä¼šè°ƒç”¨è¯‘ç æŸ¥æ‰¾è¡¨ä¸­çš„ç›¸åº”çš„æ‰§è¡Œå‡½æ•°æ¥è¿›è¡ŒçœŸæ­£çš„æ‰§è¡Œæ“ä½œã€‚</p><h5 id=å‡½æ•°-update_eip>å‡½æ•° update_eip</h5><p>æ ¹æ®å½“å‰æŒ‡ä»¤æ˜¯å¦ä¸ºè·³è½¬æŒ‡ä»¤ï¼Œæ›´æ–° <code>%eip</code>ã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>update_eip</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>decoding</span><span class=p>.</span><span class=n>is_jmp</span><span class=p>)</span> <span class=p>{</span> <span class=n>decoding</span><span class=p>.</span><span class=n>is_jmp</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>else</span> <span class=p>{</span> <span class=n>cpu</span><span class=p>.</span><span class=n>eip</span> <span class=o>=</span> <span class=n>decoding</span><span class=p>.</span><span class=n>seq_eip</span><span class=p>;</span> <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h2 id=memory-1>memory/</h2><h3 id=memoryc>memory.c</h3><p>å®šä¹‰äº†å® <code>PMEM_SIZE</code> æŒ‡å®šç‰©ç†å†…å­˜å¤§å°ã€‚
å®ç°äº† <code>include/memory/memory.h</code> ä¸­çš„å‡½æ•° <code>paddr_read</code>ï¼Œ<code>paddr_write</code>ï¼Œ<code>vaddr_read</code>ï¼Œ<code>vaddr_write</code>ã€‚</p><ul><li><code>vaddr_read, vaddr_write</code> çš„å®ç°è°ƒç”¨äº† <code>paddr_read</code> å’Œ <code>paddr_write</code>ã€‚</li><li>ä¸ºæ”¯æŒå†…å­˜æ˜ å°„ I/Oï¼Œ<code>paddr_read, paddr_write</code> çš„å®ç°åŠ å…¥äº†å¯¹å†…å­˜æ˜ å°„ I/O çš„åˆ¤æ–­ã€‚</li></ul><h2 id=device-1>device/</h2><h3 id=io>io/</h3><h4 id=mmioc>mmio.c</h4><p>å®šä¹‰äº†å® <code>MMIO_SPACE_MAX</code> æŒ‡å®šå†…å­˜æ˜ å°„ç©ºé—´å¤§å°ã€‚
å®šä¹‰äº†ç»“æ„ä½“ <code>MMIO_t</code> ä¿å­˜ MMIO ä¿¡æ¯ã€‚</p><p>å®ç°äº† <code>include/device/mmio.h</code> ä¸­çš„å‡½æ•°ã€‚</p><ul><li>åœ¨ <code>mmio_read</code> å’Œ <code>mmio_write</code> ä¸­ï¼Œè°ƒç”¨äº†å›è°ƒå‡½æ•°ã€‚</li></ul><h4 id=port-ioc>port-io.c</h4><p>å®šä¹‰äº†å® <code>PORT_IO_SPACE_MAX</code> æŒ‡å®šå†…å­˜æ˜ å°„ç©ºé—´å¤§å°ã€‚
å®šä¹‰äº†ç»“æ„ä½“ <code>PIO_t</code> ä¿å­˜ MMIO ä¿¡æ¯ã€‚</p><p>å®ç°äº† <code>include/device/port-io.h</code> ä¸­çš„å‡½æ•°ã€‚</p><ul><li>åœ¨ <code>pio_read_common</code> å’Œ <code>pio_write_common</code> ä¸­ï¼Œè°ƒç”¨äº†å›è°ƒå‡½æ•°ã€‚</li><li>åŸºäº <code>pio_read_common</code> å’Œ <code>pio_write_common</code> å®ç°äº†ä¸åŒçš„ç«¯å£è¯»å†™å‡½æ•°</li></ul><h3 id=devicec>device.c</h3><p>æä¾›åˆå§‹åŒ–å’Œæ§åˆ¶è®¾å¤‡çš„ä¸€äº›å‡½æ•°ã€‚å«æœ‰å’ŒSDLåº“ç›¸å…³çš„ä»£ç ï¼ŒNEMUä½¿ç”¨SDLåº“æ¥å®ç°è®¾å¤‡çš„æ¨¡æ‹Ÿã€‚</p><table><thead><tr><th>å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>TIMER_HZ</code></td><td>æ—¶é’Ÿé¢‘ç‡</td></tr><tr><td><code>VGA_HZ</code></td><td>VGA åˆ·æ–°é¢‘ç‡</td></tr></tbody></table><h4 id=å‡½æ•°-init_device>å‡½æ•° init_device</h4><p>ç”¨äºåˆå§‹åŒ–è®¾å¤‡ï¼šä¸²å£ï¼Œ æ—¶é’Ÿï¼Œ é”®ç›˜ï¼Œ VGAå››ç§è®¾å¤‡ã€‚
å…¶ä¸­åœ¨åˆå§‹åŒ– VGA æ—¶è¿˜ä¼šè¿›è¡Œä¸€äº›å’ŒSDLç›¸å…³çš„åˆå§‹åŒ–å·¥ä½œï¼Œ åŒ…æ‹¬åˆ›å»ºçª—å£ï¼Œ è®¾ç½®æ˜¾ç¤ºæ¨¡å¼ç­‰. æœ€åè¿˜ä¼šæ³¨å†Œä¸€ä¸ª100Hzçš„å®šæ—¶å™¨ï¼Œ æ¯éš”0.01ç§’å°±ä¼šè°ƒç”¨ä¸€æ¬¡ <code>device_update()</code> å‡½æ•°ã€‚</p><h4 id=å‡½æ•°-device_update>å‡½æ•° device_update</h4><p>ä¸»è¦è¿›è¡Œä¸€äº›è®¾å¤‡çš„æ¨¡æ‹Ÿæ“ä½œ, åŒ…æ‹¬ä»¥50Hzçš„é¢‘ç‡åˆ·æ–°å±å¹•, ä»¥åŠæ£€æµ‹æ˜¯å¦æœ‰æŒ‰é”®æŒ‰ä¸‹/é‡Šæ”¾.</p><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œ ä»£ç ä¸­æ³¨å†Œçš„å®šæ—¶å™¨æ˜¯è™šæ‹Ÿå®šæ—¶å™¨ï¼Œ å®ƒåªä¼šåœ¨ NEMU å¤„äºç”¨æˆ·æ€çš„æ—¶å€™è¿›è¡Œè®¡æ—¶ï¼š å¦‚æœ NEMU åœ¨ <code>ui_mainloop()</code> ä¸­ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œ å®šæ—¶å™¨å°†ä¸ä¼šè®¡æ—¶; å¦‚æœ NEMU è¿›è¡Œå¤§é‡çš„è¾“å‡ºï¼Œ å®šæ—¶å™¨çš„è®¡æ—¶å°†ä¼šå˜å¾—ç¼“æ…¢. å› æ­¤é™¤éä½ åœ¨è¿›è¡Œè°ƒè¯•ï¼Œ å¦åˆ™å°½é‡é¿å…å¤§é‡è¾“å‡ºçš„æƒ…å†µï¼Œ ä»è€Œå½±å“å®šæ—¶å™¨çš„å·¥ä½œã€‚</p><h3 id=serialc>serial.c</h3><p>ä¸²å£è®¾å¤‡ã€‚
æ¨¡æ‹Ÿäº†ä¸²å£çš„åŠŸèƒ½ã€‚ å…¶å¤§éƒ¨åˆ†åŠŸèƒ½ä¹Ÿè¢«ç®€åŒ–ï¼Œåªä¿ç•™äº†æ•°æ®å¯„å­˜å™¨å’ŒçŠ¶æ€å¯„å­˜å™¨ã€‚ä¸²å£åˆå§‹åŒ–æ—¶ä¼šåˆ†åˆ«æ³¨å†Œ <code>0x3F8</code> å’Œ <code>0x3FC</code> å¤„é•¿åº¦ä¸º1ä¸ªå­—èŠ‚çš„ç«¯å£ï¼Œåˆ†åˆ«ä½œä¸ºæ•°æ®å¯„å­˜å™¨å’ŒçŠ¶æ€å¯„å­˜å™¨ã€‚ç”±äºNEMUä¸²è¡Œæ¨¡æ‹Ÿè®¡ç®—æœºç³»ç»Ÿçš„å·¥ä½œï¼Œä¸²å£çš„çŠ¶æ€å¯„å­˜å™¨å¯ä»¥ä¸€ç›´å¤„äºç©ºé—²çŠ¶æ€; æ¯å½“CPUå¾€æ•°æ®å¯„å­˜å™¨ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œä¸²å£ä¼šå°†æ•°æ®ä¼ é€åˆ°ä¸»æœºçš„æ ‡å‡†è¾“å‡ºã€‚</p><table><thead><tr><th>å‡½æ•°/å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>init_serial()</code></td><td>åˆå§‹åŒ–è®¾å¤‡</td></tr><tr><td><code>SERIAL_PORT=0x3F8</code></td><td>ç«¯å£ I/O åœ°å€</td></tr></tbody></table><h3 id=timerc>timer.c</h3><p>æ—¶é’Ÿè®¾å¤‡ã€‚
æ¨¡æ‹Ÿäº†i8253è®¡æ—¶å™¨çš„åŠŸèƒ½. è®¡æ—¶å™¨çš„å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½è¢«ç®€åŒ–, åªä¿ç•™äº†"å‘èµ·æ—¶é’Ÿä¸­æ–­"çš„åŠŸèƒ½. åŒæ—¶æ·»åŠ äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„RTC(Real Time Clock), åˆå§‹åŒ–æ—¶å°†ä¼šæ³¨å†Œ0x48å¤„çš„ç«¯å£ä½œä¸ºRTCå¯„å­˜å™¨, CPUå¯ä»¥é€šè¿‡I/OæŒ‡ä»¤è®¿é—®è¿™ä¸€å¯„å­˜å™¨, è·å¾—å½“å‰æ—¶é—´(å•ä½æ˜¯ms).</p><table><thead><tr><th>å‡½æ•°/å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>init_timer()</code></td><td>åˆå§‹åŒ–è®¾å¤‡</td></tr><tr><td><code>RTC_PORT=0x48</code></td><td>ç«¯å£ I/O åœ°å€</td></tr></tbody></table><h3 id=keyboardc>keyboard.c</h3><p>é”®ç›˜è®¾å¤‡ã€‚
æ¨¡æ‹Ÿäº†i8042é€šç”¨è®¾å¤‡æ¥å£èŠ¯ç‰‡çš„åŠŸèƒ½. å…¶å¤§éƒ¨åˆ†åŠŸèƒ½ä¹Ÿè¢«ç®€åŒ–, åªä¿ç•™äº†é”®ç›˜æ¥å£. i8042åˆå§‹åŒ–æ—¶ä¼šæ³¨å†Œ <code>0x60</code> å¤„çš„ç«¯å£ï¼ˆé•¿åº¦ä¸º 4ï¼‰ä½œä¸ºæ•°æ®å¯„å­˜å™¨. æ¯å½“ç”¨æˆ·æ•²ä¸‹/é‡Šæ”¾æŒ‰é”®æ—¶, å°†ä¼šæŠŠç›¸åº”çš„é”®ç›˜ç æ”¾å…¥æ•°æ®å¯„å­˜å™¨, CPUå¯ä»¥é€šè¿‡ç«¯å£I/Oè®¿é—®æ•°æ®å¯„å­˜å™¨, è·å¾—é”®ç›˜ç ; å½“æ— æŒ‰é”®å¯è·å–æ—¶, å°†ä¼šè¿”å› <code>_KEY_NONE</code> . åœ¨AMä¸­, æˆ‘ä»¬çº¦å®šé€šç çš„å€¼ä¸º <code>æ–­ç  | KEYDOWN_MASK</code>.</p><table><thead><tr><th>å‡½æ•°/å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>init_i8042()</code></td><td>åˆå§‹åŒ–è®¾å¤‡</td></tr><tr><td><code>I8042_DATA_PORT=0x60</code></td><td>ç«¯å£ I/O åœ°å€</td></tr><tr><td><code>KEYDOWN_MASK=0x8000</code></td><td>é€šç  MASK</td></tr><tr><td><code>KEY_QUEUE_LEN</code></td><td>é”®é˜Ÿåˆ—é•¿åº¦</td></tr></tbody></table><h3 id=vgac>vga.c</h3><p>VGA è®¾å¤‡ã€‚
æ¨¡æ‹Ÿäº†VGAçš„åŠŸèƒ½. VGAåˆå§‹åŒ–æ—¶æ³¨å†Œäº†ä» <code>0x40000</code> å¼€å§‹çš„ä¸€æ®µç”¨äºæ˜ å°„åˆ°video memoryçš„ç‰©ç†å†…å­˜. åœ¨NEMUä¸­, video memoryæ˜¯å”¯ä¸€ä½¿ç”¨å†…å­˜æ˜ å°„I/Oæ–¹å¼è®¿é—®çš„I/Oç©ºé—´. ä»£ç åªæ¨¡æ‹Ÿäº†400x300x32çš„å›¾å½¢æ¨¡å¼, ä¸€ä¸ªåƒç´ å 32ä¸ªbitçš„å­˜å‚¨ç©ºé—´, R(red), G(green), B(blue), A(alpha)å„å 8 bit, å…¶ä¸­VGAä¸ä½¿ç”¨alphaçš„ä¿¡æ¯ã€‚VGA è®¾å¤‡åŒæ—¶æ³¨å†Œäº†ä½äº <code>0x100</code> çš„é•¿åº¦ä¸º 4 çš„ç«¯å£å­˜å‚¨å±å¹•å¤§å°ä¿¡æ¯ã€‚</p><table><thead><tr><th>å‡½æ•°/å®</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>init_vga()</code></td><td>åˆå§‹åŒ–è®¾å¤‡</td></tr><tr><td><code>SCREEN_PORT=0x100</code></td><td>ç«¯å£ I/O åœ°å€</td></tr><tr><td><code>VMEM=0x40000</code></td><td>å†…å­˜æ˜ å°„ I/O åœ°å€</td></tr><tr><td><code>SCREEN_H</code></td><td>å±å¹•é«˜åº¦</td></tr><tr><td><code>SCREEN_W</code></td><td>å±å¹•å®½åº¦</td></tr></tbody></table><h2 id=monitor-1>monitor/</h2><p>ç›‘è§†å™¨éƒ¨åˆ†å®ç°ï¼ˆä¹ŸåŒ…å« NEMU æ‰§è¡Œä¸»å¾ªç¯ï¼‰ã€‚</p><h3 id=monitorc>monitor.c</h3><h4 id=å‡½æ•°-init_monitor>å‡½æ•° init_monitor</h4><p>åˆå§‹åŒ–ç›‘è§†å™¨å¹¶å¯åŠ¨ï¼ˆç”¨äº <code>main.c/main</code> ä¸­ï¼‰ã€‚</p><ul><li>è§£æå¹¶å¤„ç†å‘½ä»¤è¡Œå‚æ•°</li><li>åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶</li><li>å¯„å­˜å™¨æµ‹è¯•ï¼ˆè°ƒç”¨ <code>reg_test()</code>ï¼Œå®ç°åœ¨ <code>src/cpu/reg.c</code>ï¼‰</li><li>åŠ è½½ç¨‹åºé•œåƒï¼ˆæ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>load_default_img()</code> åŠ è½½é»˜è®¤é•œåƒï¼‰</li><li>å¯åŠ¨ç¯å¢ƒï¼ˆè°ƒç”¨ <code>restart()</code>ï¼Œåˆå§‹åŒ–åº”ç”¨ç¨‹åºå…¥å£ç‚¹ï¼Œå¯„å­˜å™¨å€¼ï¼‰</li><li>ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼ï¼ˆè°ƒç”¨ <code>init_regex()</code>ï¼Œå®ç°åœ¨ <code>src/monitor/debug/expr.c</code>ï¼‰</li><li>åˆå§‹åŒ–ç›‘è§†ç‚¹æ± ï¼ˆè°ƒç”¨ <code>init_wp_pool()</code>ï¼Œå®ç°åœ¨ <code>src/monitor/debug/watchpoint.c</code>ï¼‰</li><li>åˆå§‹åŒ–è®¾å¤‡ï¼ˆè°ƒç”¨ <code>init_device()</code>ï¼Œå®ç°åœ¨ <code>src/device/device.c</code>ï¼‰</li><li>åˆå§‹åŒ–å·®å¼‚æµ‹è¯•ï¼ˆè°ƒç”¨ <code>init_difftest()</code>ï¼Œå®ç°åœ¨ <code>src/monitor/diff-test.c</code>ï¼‰</li><li>æ˜¾ç¤ºæ¬¢è¿ç•Œé¢</li><li>è¿”å›æ˜¯å¦ä¸ºæ‰¹å¤„ç†æ¨¡å¼ï¼ˆæ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼‰</li></ul><p>æ³¨ï¼š</p><ul><li>å‘½ä»¤è¡Œå‚æ•°<ul><li><code>[img_file]</code> æŒ‡å®šåº”ç”¨ç¨‹åºé•œåƒæ–‡ä»¶</li><li><code>-b</code> æ‰¹å¤„ç†æ¨¡å¼</li><li><code>-l log_file</code> æŒ‡å®šæ—¥å¿—æ–‡ä»¶</li><li><code>-d</code> æŒ‡å®š Diff-Test é•œåƒæ–‡ä»¶</li></ul></li></ul><h3 id=cpu-execc>cpu-exec.c</h3><h4 id=å‡½æ•°-cpu_exec>å‡½æ•° cpu_exec</h4><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>cpu_exec</span><span class=p>(</span><span class=n>uint64_t</span> <span class=n>n</span><span class=p>);</span>
</code></pre></div><p>æ¨¡æ‹Ÿ CPU å·¥ä½œã€‚</p><ul><li>åˆ¤æ–­ NEMU çŠ¶æ€ï¼ˆæŸ¥çœ‹ <code>nemu_state</code>ï¼Œå®šä¹‰åœ¨ <code>include/monitor/monitor.h</code>ï¼‰</li><li>è‹¥æŒ‡ä»¤æ•° <code>n</code> å°äº <code>MAX_INSTR_TO_PRINT</code> ï¼ˆé»˜è®¤ä¸º 10ï¼‰ï¼Œåˆ™æ‰“å°æ¯æ¡æŒ‡ä»¤ã€‚</li><li>å¼€å§‹æ‰§è¡ŒæŒ‡ä»¤<ul><li>è°ƒç”¨ <code>exec_wrapper</code> æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ˆä¼ å…¥æ˜¯å¦æ‰“å°æŒ‡ä»¤æ ‡è®°ï¼‰</li><li>æ£€æŸ¥ç›‘è§†ç‚¹çŠ¶æ€æ˜¯å¦æœ‰æ›´æ–°</li><li>æ›´æ–°è®¾å¤‡ä¿¡æ¯</li><li>åˆ¤æ–­ NEMU çŠ¶æ€ï¼ˆæŸ¥çœ‹ <code>nemu_state</code>ï¼‰ï¼Œå†³å®šæ˜¯å¦é€€å‡º</li></ul></li><li>æ‰§è¡Œå®Œ <code>n</code> æ¡æŒ‡ä»¤åï¼Œå°† NEMU çŠ¶æ€ç½®ä¸ºç»“æŸï¼ˆ<code>NEMU_END</code>ï¼‰</li></ul><p>æ³¨ï¼š</p><ul><li>æ‰§è¡ŒæŸæ¡å‘½ä»¤å<ul><li>è‹¥ NEMU çŠ¶æ€ä¸ºç»“æŸï¼ˆ<code>NEMU_END</code>ï¼‰ï¼Œåˆ™æ£€æŸ¥ç¨‹åºè¿”å›å€¼ï¼ˆ<code>cpu.eax</code>ï¼‰æ˜¯å¦ä¸º 0ï¼ˆæ˜¯å¦æ­£å¸¸é€€å‡ºï¼‰ã€‚å¹¶è¾“å‡º <code>HIT GOOD TRAP</code>ï¼ˆæ­£å¸¸é€€å‡ºï¼‰ æˆ– <code>HIT BAD TRAP</code>ï¼ˆéæ­£å¸¸é€€å‡ºï¼‰ã€‚</li></ul></li></ul><h3 id=debug>debug/</h3><h4 id=watchpointc>watchpoint.c</h4><p>å®šä¹‰äº†ç›‘è§†ç‚¹å†…å­˜æ± åŠå…¶ç›¸å…³çš„å‡½æ•°ã€‚</p><ul><li><code>wp_pool</code> ç›‘è§†ç‚¹æ± </li><li><code>head</code> ä½¿ç”¨ä¸­çš„ç›‘è§†ç‚¹é“¾è¡¨å¤´æŒ‡é’ˆ</li><li><code>free_</code> ç›‘è§†ç‚¹æ± ä¸­æœªä½¿ç”¨çš„ç›‘è§†ç‚¹é“¾è¡¨å¤´æŒ‡é’ˆ</li></ul><table><thead><tr><th>å‡½æ•°</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>init_wp_pool()</code></td><td>åˆå§‹åŒ–ç›‘è§†ç‚¹å†…å­˜æ± </td></tr><tr><td><code>clearWP(wp)</code></td><td>æ¸…ç©ºæŸç›‘è§†ç‚¹çš„ä¸‹ä¸€é¡¹æŒ‡é’ˆ</td></tr><tr><td><code>WP *getHeadWP()</code></td><td>è·å– <code>head</code></td></tr><tr><td><code>WP *createWP()</code></td><td>ç”³è¯·ä½¿ç”¨ä¸€ä¸ªæ–°ç›‘è§†ç‚¹ï¼ˆå†…éƒ¨è°ƒç”¨ <code>new_wp()</code> å¹¶æ›´æ–°é“¾è¡¨ä¿¡æ¯ï¼‰</td></tr><tr><td><code>removeWP(no)</code></td><td>åˆ é™¤æŒ‡å®šç¼–å·çš„ç›‘è§†ç‚¹</td></tr><tr><td><code>WP *new_wp()</code></td><td>ï¼ˆç§æœ‰ï¼‰ä»å†…å­˜æ± ä¸­è·å–ä¸‹ä¸€ä¸ªèƒ½ä½¿ç”¨çš„ç›‘è§†ç‚¹ï¼Œå¹¶ä½œä¸€å®šé¢„å¤„ç†</td></tr><tr><td><code>free_wp(wp)</code></td><td>ï¼ˆç§æœ‰ï¼‰é‡Šæ”¾ä¸€ä¸ªç›‘è§†ç‚¹</td></tr></tbody></table><h4 id=exprc>expr.c</h4><p>å®ç°äº† <code>expr.h/expr</code> å‡½æ•°ï¼Œå®ç°è¡¨è¾¾å¼è§£æå’Œæ±‚å€¼ã€‚</p><h5 id=å¸¸é‡>å¸¸é‡</h5><ul><li><code>PRI_NEG</code> å–è´Ÿè¿ç®—ä¼˜å…ˆçº§</li><li><code>PRI_POINT</code> è§£å¼•ç”¨è¿ç®—ä¼˜å…ˆçº§</li><li>å½¢å¦‚ <code>TK_TYPE</code> çš„ Token ç±»å‹æšä¸¾</li></ul><h5 id=æ•°ç»„-rules>æ•°ç»„ rules</h5><p>è§„å®šäº†ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æ Token çš„è§„åˆ™ã€‚</p><table><thead><tr><th>æˆå‘˜</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>regex</code></td><td>æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸²</td></tr><tr><td><code>token_type</code></td><td>å¯¹åº” Token ç±»å‹ï¼Œå¯ç”¨ <code>TK_TYPE</code> æšä¸¾æˆ–å­—ç¬¦ï¼ˆå¦‚ <code>+</code>ï¼‰è¡¨ç¤º</td></tr><tr><td><code>opPri</code></td><td>è¿ç®—ç¬¦ Token çš„ä¼˜å…ˆçº§</td></tr></tbody></table><h5 id=æ•°ç»„-re>æ•°ç»„ re</h5><p>æ ¹æ® <code>rules</code> ç¼–è¯‘åçš„æ­£åˆ™è¡¨è¾¾å¼ã€‚</p><h5 id=å‡½æ•°-init_regex>å‡½æ•° <code>init_regex</code></h5><p>æ ¹æ® <code>rules</code> ç¼–è¯‘åˆ° <code>re</code></p><h5 id=ç»“æ„ä½“-token>ç»“æ„ä½“ Token</h5><p>è¯†åˆ«åçš„ Token.</p><table><thead><tr><th>æˆå‘˜</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>type</code></td><td>Token ç±»å‹ï¼Œå¯ç”¨ <code>TK_TYPE</code> æšä¸¾æˆ–å­—ç¬¦ï¼ˆå¦‚ <code>+</code>ï¼‰è¡¨ç¤º</td></tr><tr><td><code>isOp</code></td><td>æ ‡è®°æ­¤ Token æ˜¯å¦æ˜¯è¿ç®—ç¬¦</td></tr><tr><td><code>isValue</code></td><td>æ ‡è®°æ­¤ Token æ˜¯å¦æ˜¯å€¼</td></tr><tr><td><code>str</code></td><td>Token çš„åŸå§‹å­—ç¬¦ä¸²</td></tr><tr><td><code>data</code></td><td>å€¼ç±»å‹çš„å®é™…æ•°æ®</td></tr><tr><td><code>priority</code></td><td>è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§</td></tr></tbody></table><ul><li><code>isOp</code> å’Œ <code>isValue</code> å¤šç”¨äºåŒºåˆ†ç‰¹æ®Šå•ç›®è¿ç®—ç¬¦ï¼Œå¦‚è§£å¼•ç”¨å’Œå–è´Ÿ</li><li><code>data</code> å¤šå­˜å‚¨ç»è¿‡é¢„å¤„ç†çš„æ•°æ®ï¼Œå¦‚è½¬æ¢åçš„æ•´æ•°</li></ul><blockquote><p>è§£æåçš„ Token åˆ—è¡¨å­˜å‚¨åœ¨æ•°ç»„ <code>tokens</code> ä¸­ã€‚
<code>nr_token</code> æŒ‡ç¤º <code>token</code> æœ‰æ•ˆé•¿åº¦ã€‚</p></blockquote><h5 id=å‡½æ•°-make_token>å‡½æ•° make_token</h5><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=kt>bool</span> <span class=n>make_token</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>e</span><span class=p>)</span>
</code></pre></div><p>æ ¹æ®å­—ç¬¦ä¸²è§£æ Token åˆ—è¡¨ï¼Œè¿”å›æ˜¯å¦è§£ææˆåŠŸã€‚</p><p>å®ç°æ€è·¯ï¼šä½¿ç”¨ <code>re</code> ä¾æ¬¡å°è¯•æ¯ä¸€ç§åŒ¹é…ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ªæˆåŠŸåŒ¹é…ï¼Œæ ¹æ®å…¶è§„åˆ™çš„ <code>token_type</code> ç”Ÿæˆ Tokenï¼Œå­˜å…¥ <code>token</code>ã€‚</p><ul><li>å‡½æ•° <code>toInteger</code> ï¼šä»¥æŒ‡å®šè¿›åˆ¶å®Œæˆå­—ç¬¦ä¸²åˆ°æ•°çš„è½¬æ¢ï¼Œç”¨äº åè¿›åˆ¶ï¼ŒäºŒè¿›åˆ¶ï¼Œå…«è¿›åˆ¶ï¼Œåå…­è¿›åˆ¶ æ•°çš„è§£æã€‚</li></ul><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=n>uint32_t</span> <span class=n>toInteger</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>s</span><span class=p>,</span> <span class=n>uint32_t</span> <span class=n>base</span><span class=p>)</span>
</code></pre></div><h5 id=å‡½æ•°-evalwithtoken>å‡½æ•° evalWithToken</h5><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>uint32_t</span> <span class=n>evalWithToken</span><span class=p>(</span><span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=kt>int</span> <span class=n>r</span><span class=p>,</span> <span class=kt>bool</span> <span class=o>*</span> <span class=n>success</span><span class=p>)</span>
</code></pre></div><p>æ±‚è§£ <code>tokens[l..r]</code> ä¸­çš„è¡¨è¾¾å¼çš„å€¼ã€‚</p><p>å®ç°æ€è·¯ï¼šå• Token ç‰¹æ®Šå¤„ç†ï¼Œç„¶åå¤„ç†å¤–å›´æ‹¬å·æƒ…å†µï¼Œç„¶åç¡®å®šæœ€åè®¡ç®—çš„è¿ç®—ç¬¦ï¼Œåˆ†å‰²æˆ <code>left</code> å’Œ <code>right</code> ä¸¤éƒ¨åˆ†ï¼Œç„¶åé€’å½’è§£å†³ï¼Œæœ€ååˆå¹¶ï¼Œ</p><ul><li>å‡½æ•° <code>checkExtraP</code> åˆ¤æ–­ <code>tokens[l..r]</code> æ˜¯å¦å¤–å›´ä¸ºæ‹¬å·ä¸”æ‹¬å·åŒ¹é…æ­£å¸¸ã€‚</li><li>å‡½æ•° <code>getReg</code> æ ¹æ®å¯„å­˜å™¨åè·å–å¯„å­˜å™¨å€¼ï¼Œä½¿ç”¨äº† <code>regMap</code></li><li>æ•°ç»„ <code>regMap</code> æ ‡è¯†å¯„å­˜å™¨åä¸å¯¹åº”çš„åç§»é‡ï¼ˆ<code>cpu.gpr</code>ï¼‰</li></ul><h5 id=å‡½æ•°-expr>å‡½æ•° expr</h5><p>å¯¹ <code>expr.h/expr</code> çš„å®ç°ï¼Œè°ƒç”¨äº† <code>make_token</code> å’Œ <code>evalWithToken</code>ã€‚</p><h4 id=uic>ui.c</h4><p>ç›‘è§†å™¨ CUI éƒ¨åˆ†ã€‚</p><h5 id=å‡½æ•°æ—-fc2color>å‡½æ•°æ— fc2color</h5><p>æ§åˆ¶å°å­—ä½“é¢œè‰²æ§åˆ¶ã€‚</p><table><thead><tr><th>å‡½æ•°</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>fc2red</code></td><td>å‰æ™¯è‰²è®¾ä¸ºçº¢è‰²</td></tr><tr><td><code>fc2green</code></td><td>å‰æ™¯è‰²è®¾ä¸ºç»¿è‰²</td></tr><tr><td><code>fc2yellow</code></td><td>å‰æ™¯è‰²è®¾ä¸ºé»„è‰²</td></tr><tr><td><code>fc2blue</code></td><td>å‰æ™¯è‰²è®¾ä¸ºè“è‰²</td></tr><tr><td><code>fc2purple</code></td><td>å‰æ™¯è‰²è®¾ä¸ºç´«è‰²</td></tr><tr><td><code>csClear</code></td><td>æ¸…é™¤æ‰€æœ‰æ§åˆ¶å°è®¾ç½®</td></tr></tbody></table><h5 id=å‡½æ•°æ—-cmd_item>å‡½æ•°æ— cmd_item</h5><p>ä¸åŒå‘½ä»¤çš„å®ç°ã€‚</p><table><thead><tr><th>å‡½æ•°</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>cmd_help</code></td><td>è·å–å¸®åŠ©</td></tr><tr><td><code>cmd_q</code></td><td>é€€å‡º</td></tr><tr><td><code>cmd_c</code></td><td>ç»§ç»­æ‰§è¡Œï¼ˆè°ƒç”¨ <code>cpu_exec(-1)</code>ï¼Œå®ç°åœ¨ <code>src/monitor/cpu-exec.c</code>ï¼‰</td></tr><tr><td><code>cmd_si</code></td><td>æ‰§è¡Œå•æ­¥æŒ‡ä»¤</td></tr><tr><td><code>cmd_info name</code></td><td>æŸ¥çœ‹ä¿¡æ¯</td></tr><tr><td><code>cmd_x N expr</code></td><td>æ˜¾ç¤ºåœ°å€ä» <code>expr</code> çš„å€¼å¼€å§‹çš„ <code>N</code> ä¸ªå­—èŠ‚å€¼</td></tr><tr><td><code>cmd_p expr</code></td><td>è®¡ç®—è¡¨è¾¾å¼çš„å€¼</td></tr><tr><td><code>cmd_w expr</code></td><td>æ–°å»ºç›‘è§†ç‚¹ï¼Œç›‘è§†è¡¨è¾¾å¼ä¸º <code>expr</code></td></tr><tr><td><code>cmd_d no</code></td><td>åˆ é™¤æŒ‡å®šç¼–å·çš„ç›‘è§†ç‚¹</td></tr></tbody></table><ul><li><code>cmd_info</code><ul><li><code>r</code> æ‰“å°æ‰€æœ‰å¯„å­˜å™¨ä¿¡æ¯</li><li><code>w</code> æ‰“å°æ‰€æœ‰ç›‘è§†ç‚¹ä¿¡æ¯</li></ul></li></ul><h5 id=æ•°ç»„-cmd_table>æ•°ç»„ cmd_table</h5><table><thead><tr><th>æˆå‘˜</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>name</code></td><td>å‘½ä»¤åï¼ˆç”¨äºè¯†åˆ«å‘½ä»¤ï¼‰</td></tr><tr><td><code>description</code></td><td>å‘½ä»¤æè¿°ï¼ˆç”¨äºå¸®åŠ©åˆ—è¡¨ï¼‰</td></tr><tr><td><code>handler</code></td><td>å‘½ä»¤å®ç°å‡½æ•°æŒ‡é’ˆ</td></tr></tbody></table><h5 id=å‡½æ•°-ui_mainloop>å‡½æ•° ui_mainloop</h5><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>ui_mainloop</span><span class=p>(</span><span class=kt>int</span> <span class=n>is_batch_mode</span><span class=p>);</span>
</code></pre></div><p>NEMU ä»¥åŠå…¶ CUI ä¸»å¾ªç¯ï¼Œä¸æ–­è¯»å–å‘½ä»¤ï¼Œå¹¶æ‰§è¡Œã€‚</p><ul><li>å¦‚æœæ˜¯æ‰¹å¤„ç†æ¨¡å¼ï¼ˆ<code>is_batch_mode</code> ä¸ºçœŸï¼‰ï¼Œåˆ™ç›´æ¥æ‰§è¡Œåº”ç”¨ç¨‹åºï¼Œä¸ç›‘å¬ç”¨æˆ·å‘½ä»¤ã€‚</li></ul><h3 id=diff-test>diff-test/</h3><p>å·®å¼‚æµ‹è¯•å®ç°ã€‚</p><blockquote><p>å¦‚æœæœ‰ä¸€ç§æ–¹æ³•èƒ½å¤Ÿè¡¨è¾¾æŒ‡ä»¤çš„æ­£ç¡®è¡Œä¸º, æˆ‘ä»¬å°±å¯ä»¥åŸºäºè¿™ç§æ–¹æ³•æ¥è¿›è¡Œç±»ä¼¼assert()çš„æ£€æŸ¥äº†ã€‚é‚£ä¹ˆ, ç©¶ç«Ÿä»€ä¹ˆåœ°æ–¹è¡¨è¾¾äº†æŒ‡ä»¤çš„æ­£ç¡®è¡Œä¸ºå‘¢? æœ€ç›´æ¥çš„, å½“ç„¶å°±æ˜¯i386æ‰‹å†Œäº†, ä½†æ˜¯æˆ‘ä»¬æ°æ°å°±æ˜¯æ ¹æ®i386æ‰‹å†Œä¸­çš„æŒ‡ä»¤è¡Œä¸ºæ¥åœ¨NEMUä¸­å®ç°æŒ‡ä»¤çš„, åŒä¸€å¥—æ–¹æ³•ä¸èƒ½æ—¢ç”¨äºå®ç°ä¹Ÿç”¨äºæ£€æŸ¥. å¦‚æœæœ‰ä¸€ä¸ªi386æ‰‹å†Œçš„å‚è€ƒå®ç°å°±å¥½äº†. å˜¿! æˆ‘ä»¬ç”¨çš„çœŸæœºä¸å°±æ˜¯æ ¹æ®i386æ‰‹å†Œå®ç°å‡ºæ¥çš„å—? æˆ‘ä»¬è®©åœ¨NEMUä¸­æ‰§è¡Œçš„æ¯æ¡æŒ‡ä»¤ä¹Ÿåœ¨çœŸæœºä¸­æ‰§è¡Œä¸€æ¬¡, ç„¶åå¯¹æ¯”NEMUå’ŒçœŸæœºçš„çŠ¶æ€, å¦‚æœNEMUå’ŒçœŸæœºçš„çŠ¶æ€ä¸ä¸€è‡´, æˆ‘ä»¬å°±æ•æ‰åˆ°erroräº†!
è¿™å®é™…ä¸Šæ˜¯ä¸€ç§éå¸¸å¥æ•ˆçš„æµ‹è¯•æ–¹æ³•, åœ¨è½¯ä»¶æµ‹è¯•é¢†åŸŸç§°ä¸ºdifferential testing(åç»­ç®€ç§°DiffTest). æˆ‘ä»¬åˆšæ‰æåˆ°äº†"çŠ¶æ€", é‚£"çŠ¶æ€"å…·ä½“æŒ‡çš„æ˜¯ä»€ä¹ˆå‘¢? æˆ‘ä»¬åœ¨PA1ä¸­å·²ç»è®¤è¯†åˆ°, è®¡ç®—æœºå°±æ˜¯ä¸€ä¸ªæ•°å­—ç”µè·¯. é‚£ä¹ˆ, &ldquo;è®¡ç®—æœºçš„çŠ¶æ€"å°±æ°æ°æ˜¯é‚£äº›æ—¶åºé€»è¾‘éƒ¨ä»¶çš„çŠ¶æ€, ä¹Ÿå°±æ˜¯å¯„å­˜å™¨å’Œå†…å­˜çš„å€¼. å…¶å®ä»”ç»†æ€è€ƒä¸€ä¸‹, è®¡ç®—æœºæ‰§è¡ŒæŒ‡ä»¤, å°±æ˜¯ä¿®æ”¹è¿™äº›æ—¶åºé€»è¾‘éƒ¨ä»¶çš„çŠ¶æ€çš„è¿‡ç¨‹. è¦æ£€æŸ¥æŒ‡ä»¤çš„å®ç°æ˜¯å¦æ­£ç¡®, åªè¦æ£€æŸ¥è¿™äº›æ—¶åºé€»è¾‘éƒ¨ä»¶ä¸­çš„å€¼æ˜¯å¦ä¸€è‡´å°±å¯ä»¥äº†! DiffTestå¯ä»¥éå¸¸åŠæ—¶åœ°æ•æ‰åˆ°error, ç¬¬ä¸€æ¬¡å‘ç°NEMUçš„å¯„å­˜å™¨æˆ–å†…å­˜çš„å€¼ä¸çœŸæœºä¸ä¸€æ ·çš„æ—¶å€™, å°±æ˜¯å› ä¸ºå½“æ—¶æ‰§è¡Œçš„æŒ‡ä»¤å®ç°æœ‰è¯¯å¯¼è‡´çš„. è¿™æ—¶å€™å…¶å®ç¦»erroréå¸¸æ¥è¿‘, é˜²æ­¢äº†errorè¿›ä¸€æ­¥ä¼ æ’­çš„åŒæ—¶, è¦å›æº¯æ‰¾åˆ°faultä¹Ÿå®¹æ˜“å¾—å¤š.
å¤šä¹ˆç¾å¦™çš„åŠŸèƒ½å•Š! èƒŒåè¿˜è•´å«ç€è®¡ç®—æœºæœ¬è´¨çš„æ·±åˆ»åŸç†! ä½†å¾ˆé—æ†¾, ä¸è¦å¿˜è®°äº†, çœŸæœºä¸Šæ˜¯è¿è¡Œäº†æ“ä½œç³»ç»ŸGNU/Linuxçš„, è€ŒNEMUä¸­çš„æµ‹è¯•ç¨‹åºæ˜¯è¿è¡Œåœ¨x86-nemuä¸Šçš„, æˆ‘ä»¬æ— æ³•åœ¨nativeä¸­è¿è¡Œç¼–è¯‘åˆ°x86-nemuçš„AMç¨‹åº. æ‰€ä»¥, æˆ‘ä»¬éœ€è¦çš„ä¸ä»…æ˜¯ä¸€ä¸ªi386æ‰‹å†Œçš„æ­£ç¡®å®ç°, è€Œä¸”éœ€è¦åœ¨ä¸Šé¢èƒ½æ­£ç¡®è¿è¡Œx86-nemuçš„AMç¨‹åº.
äº‹å®ä¸Š, QEMUå°±æ˜¯ä¸€ä¸ªä¸é”™çš„å‚è€ƒå®ç°. å®ƒæ˜¯ä¸€ä¸ªè™šæ‹Ÿå‡ºæ¥çš„å®Œæ•´çš„x86è®¡ç®—æœºç³»ç»Ÿ, è€ŒNEMUçš„ç›®æ ‡åªæ˜¯è™šæ‹Ÿå‡ºx86çš„ä¸€ä¸ªå­é›†, èƒ½åœ¨NEMUä¸Šè¿è¡Œçš„ç¨‹åº, è‡ªç„¶ä¹Ÿèƒ½åœ¨QEMUä¸Šè¿è¡Œ. å› æ­¤, ä¸ºäº†é€šè¿‡DiffTestçš„æ–¹æ³•æµ‹è¯•NEMUå®ç°çš„æ­£ç¡®æ€§, æˆ‘ä»¬è®©NEMUå’ŒQEMUé€æ¡æŒ‡ä»¤åœ°æ‰§è¡ŒåŒä¸€ä¸ªå®¢æˆ·ç¨‹åº. åŒæ–¹æ¯æ‰§è¡Œå®Œä¸€æ¡æŒ‡ä»¤, å°±æ£€æŸ¥å„è‡ªçš„å¯„å­˜å™¨å’Œå†…å­˜çš„çŠ¶æ€, å¦‚æœå‘ç°çŠ¶æ€ä¸ä¸€è‡´, å°±é©¬ä¸ŠæŠ¥å‘Šé”™è¯¯, åœæ­¢å®¢æˆ·ç¨‹åºçš„æ‰§è¡Œ.</p></blockquote><h4 id=diff-testh>diff-test.h</h4><p>å®šä¹‰äº†å® <code>DIFFTEST_REG_SIZE</code> è§„å®šè®¿é—®çš„å¯„å­˜å™¨å¤§å°ã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#define DIFFTEST_REG_SIZE (sizeof(uint32_t) * 9) </span><span class=c1>// GRPs + EIP
</span></code></pre></div><h4 id=refc>ref.c</h4><p>åœ¨ DUT(Design Under Test, æµ‹è¯•å¯¹è±¡)å’Œ REF(Reference, å‚è€ƒå®ç°) ä¹‹é—´å®šä¹‰äº†ä¸€ç»„ APIã€‚</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=c1>// ä»DUT host memoryçš„ src å¤„æ‹·è´ n å­—èŠ‚åˆ°REF guest memoryçš„ dest å¤„
</span><span class=c1></span><span class=kt>void</span> <span class=nf>difftest_memcpy_from_dut</span><span class=p>(</span><span class=n>paddr_t</span> <span class=n>dest</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>src</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>n</span><span class=p>);</span>
<span class=c1>// è·å–REFçš„å¯„å­˜å™¨çŠ¶æ€åˆ° r 
</span><span class=c1></span><span class=kt>void</span> <span class=nf>difftest_getregs</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>r</span><span class=p>);</span>
<span class=c1>// è®¾ç½®REFçš„å¯„å­˜å™¨çŠ¶æ€ä¸º r 
</span><span class=c1></span><span class=kt>void</span> <span class=nf>difftest_setregs</span><span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>r</span><span class=p>);</span>
<span class=c1>// è®©REFæ‰§è¡Œ n æ¡æŒ‡ä»¤
</span><span class=c1></span><span class=kt>void</span> <span class=nf>difftest_exec</span><span class=p>(</span><span class=n>uint64_t</span> <span class=n>n</span><span class=p>);</span>
<span class=c1>// åˆå§‹åŒ–REFçš„DiffTeståŠŸèƒ½
</span><span class=c1></span><span class=kt>void</span> <span class=nf>difftest_init</span><span class=p>();</span>
</code></pre></div><ul><li>å…¶ä¸­å¯„å­˜å™¨çŠ¶æ€ <code>r</code> è¦æ±‚å¯„å­˜å™¨çš„å€¼æŒ‰ç…§æŸç§é¡ºåºæ’åˆ—ï¼Œè‹¥æœªæŒ‰è¦æ±‚é¡ºåºæ’åˆ—ï¼Œ <code>difftest_getregs()</code> å’Œ <code>difftest_setregs()</code> çš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„. REF éœ€è¦å®ç°è¿™äº› APIï¼ŒDUTä¼šä½¿ç”¨è¿™äº› API æ¥è¿›è¡Œ DiffTest ã€‚</li></ul><h4 id=diff-testc>diff-test.c</h4><p>å®šä¹‰äº†å˜é‡ <code>is_skip_ref</code>ï¼Œ<code>is_skip_dut</code> ç”¨äºæ ‡è®°å¿½è§†ä¸€äº›æŒ‡ä»¤å¤„çš„æ¯”å¯¹ã€‚ï¼ˆå¯ç»“åˆ <code>difftest_step</code> å®ç°ï¼‰
å®šä¹‰äº†å‡½æ•° <code>difftest_skip_ref</code>ï¼Œ<code>difftest_skip_dut</code> æ ‡è®°ä¸Šè¿°å˜é‡ã€‚</p><h5 id=å‡½æ•°-init_difftest>å‡½æ•° init_difftest</h5><p>åˆå§‹åŒ– Diff-Testã€‚</p><ul><li>æ‰“å¼€åŠ¨æ€åº“æ–‡ä»¶ <code>ref_so_file</code></li><li>ä»åŠ¨æ€åº“ä¸­åˆ†åˆ«è¯»å–ä¸Šè¿° API çš„ç¬¦å·</li><li>å¯¹ REF çš„ DIffTeståŠŸèƒ½è¿›è¡Œåˆå§‹åŒ–ï¼Œæ­¤æ—¶ä¼šå¯åŠ¨ REFï¼Œä»£ç è¿˜ä¼šå¯¹ REF çš„çŠ¶æ€è¿›è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼ŒREF è¿è¡Œåœ¨åå°ï¼Œå› æ­¤å°†çœ‹ä¸åˆ° REF çš„ä»»ä½•è¾“å‡º</li><li>å°† DUT çš„ guest memory æ‹·è´åˆ° REF ä¸­</li><li>å°† DUT çš„å¯„å­˜å™¨çŠ¶æ€æ‹·è´åˆ° REF ä¸­</li></ul><h5 id=å‡½æ•°-difftest_step>å‡½æ•° difftest_step</h5><p>ç”¨äºé€æ¡æŒ‡ä»¤æ‰§è¡Œåçš„çŠ¶æ€å¯¹æ¯”ã€‚å®ƒä¼šåœ¨ <code>exec_wrapper()</code> çš„æœ€åè¢«è°ƒç”¨ã€‚åœ¨è¿™é‡Œè¯»å– REF çš„å¯„å­˜å™¨å¹¶ä¸ NEMU å¯„å­˜å™¨çŠ¶æ€æ¯”å¯¹ã€‚</p><h2 id=misc>misc/</h2><h3 id=logoc>logo.c</h3><p>å®šä¹‰äº†å­—ç¬¦æ•°ç»„ <code>logo</code> å­˜å‚¨ i386 Manual Logoã€‚ç”¨äº <code>inv</code> æŒ‡ä»¤ï¼ˆä½äº <code>special.c</code> ä¸­ï¼‰ã€‚</p><h1 id=tools>tools/</h1><h2 id=gen-exprc>gen-expr.c</h2><p>ç”Ÿæˆ C è¡¨è¾¾å¼ï¼Œç”¨äºæµ‹è¯•è¡¨è¾¾å¼æ±‚å€¼åŠŸèƒ½ã€‚</p><h2 id=qemu-diff>qemu-diff</h2><p>QEMU å®ç°ï¼Œç”¨äº Diff-Testã€‚ç¼–è¯‘æˆåŠ¨æ€åº“ <code>qemu-so</code>ï¼Œä¼ å…¥ nemu çš„ <code>-d</code> å‚æ•°ä¸­ã€‚</p><h1 id=å¼•ç”¨èµ„æ–™>å¼•ç”¨èµ„æ–™</h1><ul><li><a class=link href=https://legacy.gitbook.com/book/nju-ics/ics2018-programming-assignment/details target=_blank rel=noopener>ICS2018 PA è®²ä¹‰</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/nju/>NJU</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script></article><div id=remark42></div><script>var remark_config={host:"https://comments.stardustdl.top",site_id:'blog',components:['embed'],url:"https://stardustdl.github.io/posts/learning/nju-icspa-analytics-nemu/",max_shown_comments:15,theme:document.body.dataset.scheme,page_title:'NJU ICS Programming Assignment ä»£ç åˆ†æ - NEMU',locale:'en',show_email_subscription:!0};(function(d){for(var a=0,b,c;a<d.length;a++)b=document,c=b.createElement('script'),c.src=remark_config.host+'/web/'+d[a]+'.js',c.defer=!0,(b.head||b.body).appendChild(c)})(remark_config.components||['embed']),window.addEventListener('onColorSchemeChange',a=>{window.REMARK42.changeTheme(a.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2021 StardustDL's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=2.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script></body></html>